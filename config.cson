settings:[
  query:
    domain: "test_domain"
    my_key: "{{ my_filter }}"
]
sharingOptions: true
slidePdfEnabled: true
dashboardPdfEnabled: true
captureChartEnabled: true
locale: 'fr'
comments: true
glossary:
  title: "Commentaires"
  'terms': []

# home:
#   skipToReport: "0"
home:
  search:
    text: "Accéder au rapport"
    helper: 'Entrez les 3 premières lettres du groupe /pays souhaité'
    placeholder: 'GROUPE / PAYS'
    selectList: 'Ou choisissez un pays dans la liste'
  widget:
    type: "list"

slides: [
  {
    level: 0
    id: 0
  }
  {
    level: 1
    title: "CA Groupe"
    id: 10
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
  }
  {
    level: 1
    title: "Chiffre d'Affaires"
    id: 101
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
  }
  {
    level: 1
    title: "VA Web"
    id: 20
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
  }
  {
    level: 1
    title: "VA Web"
    id: 201
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
  }
  {
    level: 1
    title: "Marge Commerciale"
    id: 30
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
        'Pays'
      ]
  }
  {
    level: 1
    title: "Coûts de Distribution"
    id: 40
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
        'Pays'
      ]
  }
  {
    level: 1
    title: "ROC / ROCDA"
    id: 50
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
        'Pays'
      ]
  }
  {
    level: 1
    title: "Free Cash Flow"
    id: 60
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
        'Pays'
      ]
  }
  {
    title: "Dynamique CA" # en 12 mois glissants
    level: 3
    parent_id: 10
    id: 10001
    # commentary: "Les évolutions sont présentées à taux constants. L'évolution LFL est retraitée de l'effet calendaire et de l'effet travaux. <br>NB : France inclut CPI"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]

    chartOptions:
      requesters:
        "upper-right":
          query:[
            $match:
              domain:"SA"
              Compte: "3XR55LFLTX"
              "Secteur": "3SECD004"
              "Format": "3MUD006"
              View: "MONTH"
              Origine: "30SA-CALC"
              "Code Entité": $nin: ["3RUDASIAADP", "3RUDEURADP", "3RUDAMLAADP", "3RUDFRA09"]
          ,
            $group:
              _id: "$Libellé Entité"
          ]
          type: "dropdown"
          id: "pays"
          fields: ["_id"]
          default: "Groupe"
          order:
            custom: [
              "Groupe"
              "France"
              "Espagne"
              "Italie"
              "Belgique"
              "Pologne"
              "Roumanie"
              "Chine"
              "Taiwan"
              "Brésil"
              "Argentine"
            ]
      chartType: 'linechart'
      data:
        query:[
          [
            $match:
              domain:"SA"
              Compte: "3XR55LFLTX"
              "Code Entité": $nin: ["3RUDASIAADP", "3RUDEURADP", "3RUDAMLAADP", "3RUDFRA09"]
              "Secteur": "3SECD004"
              "Format": "3MUD006"
              View: "MONTH"
              "Libellé Entité": "{{ requestersManager.pays }}"
              Origine: "30SA-CALC"
          ,
            $addFields:
              serie: $literal: "CA LFL Month"
              value: $divide: ["$Montant", 100]
              "Evo YTD": "$Evo LFL net (hors TWRK & Cal) groupe vs histo % YTD"
          ]
          [
            $match:
              domain:"SA"
              Compte: "3XR55TXEH1"
              "Code Entité": $nin: ["3RUDASIAADP", "3RUDEURADP", "3RUDAMLAADP", "3RUDFRA09"]
              "Secteur": "3SECD004"
              "Format": "3MUD006"
              "Libellé Entité": "{{ requestersManager.pays }}"
              View: "MONTH"
              Origine: "30SA-CALC"
          ,
            $addFields:
              serie: $literal: "CA Total Month"
              value: $divide: ["$Montant", 100]
              "Evo YTD": "$Evo CA TOT vs histo % cstt YTD"
          ]
        ]
        multiple_queries: true
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          value: ".1%"
          "Evo YTD": ".1f"
      value:"value"
      date:"Période"
      # dateFormat: "%M %Y"
      metaSerie: ["Evo YTD"]
      groups: "serie"
      legend: true
      smoothLine: true
      units:
        "value": ""
        "Evo YTD": "%"

  }
  {
    level: 3
    title: "Tendance LFL pays"
    parent_id: 10
    id: 10002
    # commentary: "L'évolution LFL est retraitée de l'effet calendaire et de l'effet travaux, elle est présentée à taux constants.<br>NB : France inclut CPI"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:
          domain:"SA"
          Compte: $in: ["3XR55LFLTX","3XR55LFLTXVH"]
          "Code Entité": $nin: ["3RUDASIAADP", "3RUDEURADP", "3RUDAMLAADP"]
          "Secteur": "3SECD004"
          "Format": "3MUD006"
          "Libellé Entité": $ne: "France hors CPI"
          Origine: "30SA-CALC"
        order:
          by: "Libellé Entité"
          custom:[
            "Groupe"
            "France"
            "Espagne"
            "Italie"
            "Belgique"
            "Pologne"
            "Roumanie"
            "Chine"
            "Taiwan"
            "Brésil"
            "Argentine"
          ]
        postprocess:[
          argmax: "Période"
        ,
          pivot:
            index: ['Libellé Entité',"Période", 'View']
            column: 'Libellé'
            value: 'Montant'
        ]
        precision:
          'Evo LFL net (hors TWRK & Cal) groupe vs histo %': ",.1f"
          'Var. LFL vs n-1': ",.1f"

      chartType: "leaderboardCenteredAverage"
      value: "Evo LFL net (hors TWRK & Cal) groupe vs histo %"
      label: "Libellé Entité"
      variation: "Var. LFL vs n-1"
      variationLegend: "Ecart vs N-1"
      average: 0
      averageText: " "
      hideAverageBox: true

      units:
        'Evo LFL net (hors TWRK & Cal) groupe vs histo %': "%"
        "Var. LFL vs n-1": "pts"

      sparklines:
        orderDates: true
        value: "Evo LFL net (hors TWRK & Cal) groupe vs histo %"
        units: "Evo LFL net (hors TWRK & Cal) groupe vs histo %" : "%"
        legend: "Evo sur<br>12 mois"
        joins: [
          "Libellé Entité"
        ]
        date: "Période"
        data:
          query:
            domain:"SA"
            Compte: "3XR55LFLTX"
            "Code Entité": $nin: ["3RUDASIAADP", "3RUDEURADP", "3RUDAMLAADP"]
            "Secteur": "3SECD004"
            "Format": "3MUD006"
            Origine: "30SA-CALC"
            View: "MONTH"
            "Libellé Entité": $ne: "France hors CPI"

          precision:
            "Evo LFL net (hors TWRK & Cal) groupe vs histo %": '.1f'
  }
  #
  # {
  #   level: 3
  #   title: "Mix catégories & LFL"
  #   parent_id: 10
  #   id: 10003
  #   commentary: "Poids des catégories par pays et variation LFL"
  #   restrictVisibility:
  #     reportEntry: 'entityGroup'
  #     allowedReports: [
  #       'Groupe'
  #     ]
  #   filters:
  #     "bottom-right":
  #       on: "consolidation"
  #       type: "buttons"
  #       defaultSelected: "YTD"
  #
  #   chartOptions:
  #     data:
  #       query: [
  #         [
  #           {
  #             $match:
  #               categorie:
  #                 $in: [
  #                   "Food"
  #                   "Non Food"
  #                 ]
  #               domain: "master"
  #               ecran: "mix_produit"
  #               group: "detail"
  #               packs:
  #                 $ne: "Total"
  #           }
  #           {
  #             $project:
  #               _id: 0
  #               consolidation: 1
  #               id:
  #                 $concat: [
  #                   "$pays"
  #                   "_"
  #                   "$packs"
  #                 ]
  #               label: "$packs"
  #               parent: ""
  #               pays: 1
  #               periods: 1
  #               units: 1
  #               value: 1
  #               order: 1
  #           }
  #         ]
  #         [
  #           {
  #             $match:
  #               categorie:
  #                 $nin: [
  #                   "Food"
  #                   "Non Food"
  #                   "Autres"
  #                 ]
  #               domain: "master"
  #               ecran: "mix_produit"
  #               group: "detail"
  #               packs:
  #                 $ne: "Total"
  #           }
  #           {
  #             $project:
  #               _id: 0
  #               consolidation: 1
  #               id:
  #                 $concat: [
  #                   "$pays"
  #                   "_"
  #                   "$packs"
  #                   "_"
  #                   "$categorie"
  #                 ]
  #               label: "$categorie"
  #               parent:
  #                 $concat: [
  #                   "$pays"
  #                   "_"
  #                   "$packs"
  #                 ]
  #               pays: ""
  #               periods: 1
  #               units: 1
  #               value: 1
  #               order: 1
  #           }
  #         ]
  #       ]
  #       multiple_queries: true
  #     chartType:'horizontal-barchart'
  #     value: "value"
  #     variation: "order"
  #     variationLegend: "Var. CA LFL%"
  #     domain: [0, 100]
  #     label:"label"
  #     packs: "pays"
  #     packNames: true
  #     'children':
  #           'root': ''
  #           'id': 'id'
  #           'parent': 'parent'
  #     units:
  #       value: "%"
  #       order: "%"
  #     legend: true
  #     style: "no-value-legend"
  # }

  {
    level: 3
    title: "Poids catégories et LFL"
    parent_id: 10
    id: 10003
    # commentary:  "Le poids des catégories est calculé sur base du CA total. L'évolution LFL est retraitée de l'effet calendaire et de l'effet travaux, elle est présentée à taux constants. <br>NB : France inclut CPI. NB2 : Le poids du Non-food inclut également les catégories 'autres'"
    restrictVisibility:
      reportEntry: "entityGroup"
      allowedReports: [
        "Groupe"
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query: [
          [
            {
              $match:
                domain: "SA"
                Format: "3MUD006"
                Exrecice: "SALES"
                "Code Entité":
                  $nin: [
                    "3RUDASIAADP"
                    "3RUDEURADP"
                    "3RUDAMLAADP"
                    "3RUDFRA09"
                  ]
                Origine: "30SA-CALC"
                Compte: "3XR55PDS"
                Secteur:
                  $in: [
                    "3SECD100"
                    "3SECD007"
                  ]
            }
            {
              $addFields:
                parent:
                  $literal: ""
                id:
                  $concat: [
                    "$Libellé Entité"
                    "-"
                    "$Libellé Secteur"
                  ]
            }
            {
              $sort: "Libellé Secteur": 1
            }
          ]
          [
            {
              $match:
                domain: "SA"
                Format: "3MUD006"
                Exrecice: "SALES"
                "Code Entité":
                  $nin: [
                    "3RUDASIAADP"
                    "3RUDEURADP"
                    "3RUDAMLAADP"
                    "3RUDFRA09"
                  ]
                Origine: "30SA-CALC"
                Compte: "3XR55PDS"
                Secteur:
                  $in: [
                    "SECT1010"
                    "SECT1020"
                  ]
            }
            {
              $addFields:
                parent:
                  $concat: [
                    "$Libellé Entité"
                    "-"
                    "Food"
                  ]
                id:
                  $concat: [
                    "$Libellé Entité"
                    "-"
                    "Food"
                    "-"
                    "$Libellé Secteur"
                  ]
                order:
                  $cond:[
                    $eq: ["$Libellé Secteur", "Cons. Goods"]
                    1
                    $cond:[
                      $eq: ["$Libellé Secteur", "Fresh"]
                      2
                      3
                    ]
                  ]
            }
            {
              $sort:
                order: 1
            }
          ]
          [
            {
              $match:
                domain: "SA"
                Format: "3MUD006"
                Exrecice: "SALES"
                "Code Entité":
                  $nin: [
                    "3RUDASIAADP"
                    "3RUDEURADP"
                    "3RUDAMLAADP"
                    "3RUDFRA09"
                  ]
                Origine: "30SA-CALC"
                Compte: "3XR55PDS"
                Secteur:
                  $in: [
                    "SECT1110"
                    "SECT1120"
                    "SECT1130"
                  ]
            }
            {
              $addFields:
                parent:
                  $concat: [
                    "$Libellé Entité"
                    "-"
                    "Non Food"
                  ]
                id:
                  $concat: [
                    "$Libellé Entité"
                    "-"
                    "Non Food"
                    "-"
                    "$Libellé Secteur"
                  ]
                order:
                  $cond:[
                    $eq: ["$Libellé Secteur", "Bazar"]
                    4
                    $cond:[
                      $eq: ["$Libellé Secteur", "Textile"]
                      5
                      $cond:[
                        $eq: ["$Libellé Secteur", "Appliance"]
                        6
                        7
                      ]
                    ]
                  ]
            }
            {
              $sort:
                order: 1
            }

          ]
        ]
        multiple_queries: true
        order:
          by: "Libellé Entité"
          custom: [
            "Groupe"
            "France"
            "Espagne"
            "Italie"
            "Belgique"
            "Pologne"
            "Roumanie"
            "Chine"
            "Taiwan"
            "Brésil"
            "Argentine"
          ]
        postprocess: [
            argmax: "Période"
          ,
            rename:
              values:
                "Cons. Goods":
                  en: "PGC"
                  fr: "PGC"
                "Fresh":
                  en: "PFT"
                  fr: "PFT"
                "Appliance":
                  en: "EPCS"
                  fr: "EPCS"
        ]
        precision:
          "Evo LFL net (hors TWRK & Cal) groupe vs histo %": ".1f"
          Montant: ".0f"
      chartType: "horizontal-barchart"
      children:
        id: "id"
        parent: "parent"
        root: ""
      value: "Montant"
      variation: "Evo LFL net (hors TWRK & Cal) groupe vs histo %"
      variationLegend: "Evo LFL%"
      domain: [
        0
        100
      ]
      label: "Libellé Secteur"
      packs: "Libellé Entité"
      packNames: true
      units:
        Montant: "%"
        "Evo LFL net (hors TWRK & Cal) groupe vs histo %": "%"
      legend: true
      style: "no-arrow no-value-legend"
  }
  {
    level: 3
    title: "Poids Format et LFL"
    parent_id: 10
    id: 10004
    commentary: "Poids formats et évolution LFL %"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          $match:
            domain: "SA"
            Compte: $in: ["3XR55LFLTX", "3XR55PDF"]
            Secteur: "3SECD004"
            Format: $in: ["3MUD1000","3MUD1100", "3MUD1200","3MUD1300"]
            Exrecice: "SALES"
            Origine: "30SA-CALC"
            "Libellé Entité": $nin: [
              "Amérique Latine"
              "France hors CPI"
              "Asie"
              "Europe"
            ]
        ,
          $addFields:
            categoryOrder:
              $cond:[
                $eq: ["$Libellé Format", "Hyper"]
                1
                $cond:[
                  $eq: ["$Libellé Format", "Super"]
                  2
                  $cond:[
                    $eq: ["$Libellé Format", "Proxi"]
                    3
                    4
                  ]
                ]
              ]
            entityOrder:
              $switch:
                branches: [
                  case: $eq: ["$Libellé Entité", "Groupe"]
                  then: 1
                ,
                  case: $eq: ["$Libellé Entité", "France"]
                  then: 2
                ,
                  case: $eq: ["$Libellé Entité", "Espagne"]
                  then: 3
                ,
                  case: $eq: ["$Libellé Entité", "Italie"]
                  then: 4
                ,
                  case: $eq: ["$Libellé Entité", "Belgique"]
                  then: 5
                ,
                  case: $eq: ["$Libellé Entité", "Pologne"]
                  then: 6
                ,
                  case: $eq: ["$Libellé Entité", "Roumanie"]
                  then: 7
                ,
                  case: $eq: ["$Libellé Entité", "Chine"]
                  then: 8
                ,
                  case: $eq: ["$Libellé Entité", "Taiwan"]
                  then: 9
                ,
                  case: $eq: ["$Libellé Entité", "Brésil"]
                  then: 10
                ,
                  case: $eq: ["$Libellé Entité", "Argentine"]
                  then: 11
                ]
                default: 12
        ,
          $addFields: order: $add: [
            $multiply: ["$entityOrder", 100]
          ,
            "$categoryOrder"
          ]
        ,
          $sort: order : 1
        ]
        precision:
          "Evo LFL net (hors TWRK & Cal) groupe vs histo %": '.1f'

        postprocess:[
          argmax: "Période"
        ,
          pivot:
            index: ['Libellé Entité','Libellé Format', 'View', "Période", "order"]
            column: 'Libellé'
            value: 'Montant'
        ]
        order:
          by: "order"
        #   custom: ["Groupe", "France", "Espagne", "Italie", "Belgique", "Pologne", "Roumanie", "Chine", "Taiwan", "Brésil", "Argentine"]
      chartType:'horizontal-barchart'
      value: "Poids Format"
      variation: "Evo LFL net (hors TWRK & Cal) groupe vs histo %"
      variationLegend: "Evo LFL%"
      label:"Libellé Format"
      packs: "Libellé Entité"
      # packsOrder: ["Groupe", "France", "Espagne", "Italie", "Belgique", "Pologne", "Roumanie", "Chine", "Taiwan", "Brésil", "Argentine"]
      style: "no-arrow"
      packNames: true
      # labelsOrder: [
      #   "Hyper"
      #   "Super"
      #   "Proxi"
      #   "C&C"
      # ]

      units:
        "Poids Format": "%"
        "Evo LFL net (hors TWRK & Cal) groupe vs histo %": "%"
      # legend: true

  }
  {
    level:3
    parent_id:10
    id:10005
    title: "Passage CA"
    # commentary:  "L'évolution LFL est retraitée de l'effet calendaire et de l'effet travaux, elle est présentée à taux constants. NB : France inclut CPI"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    requesters:
      "bottom-right":
        type: "buttons"
        id: 'period'
        values: [
          View: 'MONTH'
          # name: 'MONTH'
        ,
          View: 'YTD'
          # name: 'YTD'
        ]
        fields: ['View']
        completeObjectMode: true
    # filters:
    #   "bottom-right":
    #     on: "View"
    #     type: "buttons"
    #     defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [#point de départ CA N-1
            $match:
              domain: "SA"
              Compte: "3XR55H"
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-IFRS"
              "Code Entité": "3RUD2100"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              type: $subtract: [0, 1]
              label: $literal: "N-1"
              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: "$label"
              order: $sum: [0,0]
          ]
          [ #création group=France
            $match:
              domain: "SA"
              Compte: $in:["3XR55LFLV","3XR55LFLTX"]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-CALC"
              "Code Entité": "3RUDFRAADP"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
          ,
            $project:
              type: $literal: "parent"
              label: $literal: 'France'
              value: $divide:["$value", 1000]
              group: $literal: 'France'
              variation: $divide:["$variation", 100]
              "Période": "$_id"
              order: $literal: 1
          ]
          [ #création labels formats pour group France
            $match:
              domain: "SA"
              Compte: $in:["3XR55LFLV","3XR55LFLTX"]
              Secteur: "3SECD004"
              Format: $in: ["3MUD014","3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300" ]
              Flux: "Y99"
              Exrecice: "SALES"
              Origine: "30SA-CALC"
              "Code Entité": "3RUDFRAADP"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id:
                "Période": "$Période"
                "Libellé Format": "$Libellé Format"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
              label: $first: "$Libellé Format"
              "Code Entité": $first: "$Code Entité"
              Zone: $first: "$Zone"
          ,
            $project:
              type: $literal: "child"
              label: 1
              value: $divide:["$value", 1000]
              group: $literal: "France"
              variation: $divide:["$variation", 100]
              "Période": "$_id.Période"
              order:
                $cond:[
                  $eq: ["$label", "Hyper"]
                  1
                  $cond:[
                    $eq: ["$label", "Super"]
                    2
                    $cond:[
                      $eq: ["$label", "Proxi"]
                      3
                      $cond:[
                        $eq: ["$label", "C&C"]
                        4
                        5
                      ]
                    ]
                  ]
                ]
          ]
          [ #création group=Zone
            $match:
              domain: "SA"
              Compte: $in:["3XR55LFLV","3XR55LFLTX"]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-CALC"
              "Code Entité": $in: ["3RUDAMLAADP", "3RUDASIAADP", "3RUDEURADP"]
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id:
                "Période": "$Période"
                "Libellé Entité": "$Libellé Entité"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
              label: $first: "$Libellé Entité"
              "Code Entité": $first: "$Code Entité"
          ,
            $project:
              type: $literal: "parent"
              label: 1
              value: $divide:["$value", 1000]
              group: '$label'
              variation: $divide:["$variation", 100]
              "Période": "$_id.Période"
              order:
                $cond:[
                  $eq: ["$Code Entité", "3RUDEURADP"]
                  6
                  $cond:[
                    $eq: ["$Code Entité", "3RUDASIAADP"]
                    11
                    13
                  ]
                ]
          ]
          [ #création labels pays
            $match:
              domain: "SA"
              Compte: $in:["3XR55LFLV","3XR55LFLTX"]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-CALC"
              "Code Entité": $nin: ["3RUD2100","3RUDFRA09", "3RUDFRAADP", "3RUDAMLAADP", "3RUDASIAADP", "3RUDEURADP"]
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id:
                "Période": "$Période"
                "Libellé Entité": "$Libellé Entité"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
              label: $first: "$Libellé Entité"
              "Code Entité": $first: "$Code Entité"
              Zone: $first: "$Zone"
          ,
            $project:
              type: $literal: "child"
              label: $toUpper: $substr: ["$label", 0, 2]
              value: $divide:["$value", 1000]
              group: '$Zone'
              variation: $divide:["$variation", 100]
              "Période": "$_id.Période"
          ,
            $addFields:
              order:
                $cond:[
                  $eq: ["$label", "ES"]
                  6
                  $cond:[
                    $eq: ["$label", "IT"]
                    7
                    $cond:[
                      $eq: ["$label", "BE"]
                      8
                      $cond:[
                        $eq: ["$label", "PO"]
                        9
                        $cond:[
                          $eq: ["$label", "RO"]
                          10
                          $cond:[
                            $eq: ["$label", "CH"]
                            11
                            $cond:[
                              $eq: ["$label", "TA"]
                              12
                              $cond:[
                                $eq: ["$label", "BR"]
                                13
                                14
                              ]
                            ]
                          ]
                        ]
                      ]
                    ]
                  ]
                ]


          ]
          [ #effet calendaire
            $match:
              domain: "SA"
              $or: [
                Compte: "3XR55EFCTX"
                Origine: "30SA-CALC"
                Flux: "Y99"
              ,
                Compte: "XR55"
                Origine: "30SA-IFRS"
                Flux: "EFCAL"
              ]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Exrecice: "SALES"
              "Code Entité": "3RUD2100"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
          ,
            $project:
              type: $literal: "parent"
              label: $literal: "Eff Cal"
              value: $divide:["$value", 1000]
              group: $literal: "Eff Cal"
              order: $literal: 15
              variation: $divide:["$variation", 100]
              "Période": "$_id"
          ]
          [ #effets travaux
            $match:
              domain: "SA"
              Compte: $in: ["3XR55EFWRKTX","3XR55EFWRKTV"]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Exrecice: "SALES"
              Origine: "30SA-CALC"
              "Code Entité": "3RUD2100"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
              label: $first: "$Libellé"
          ,
            $project:
              type: $literal: "parent"
              label: 1
              value: $divide:["$value", 1000]
              group: "$label"
              order: $literal: 16
              variation: $divide:["$variation", 100]
              "Période": "$_id"
          ]
          [ #effets  périmètre
            $match:
              domain: "SA"
              Compte: $in: ["3XR55PETX", "3XR55PETV"]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Exrecice: "SALES"
              Origine: "30SA-CALC"
              "Code Entité": "3RUD2100"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
              label: $first: "$Libellé"
          ,
            $project:
              type: $literal: "parent"
              label: 1
              value: $divide:["$value", 1000]
              group: "$label"
              order: $literal: 17
              variation: $divide:["$variation", 100]
              "Période": "$_id"
          ]
          [ #effet acquisition
            $match:
              domain: "SA"
              $or:[
                Compte: "XR55"
                Flux: "TACQ"
                Origine: "30SA-IFRS"
              ,
                Compte: "3XR55ACQTX"
                Flux: "Y99"
                Origine: "30SA-CALC"
              ]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Exrecice: "SALES"
              "Code Entité": "3RUD2100"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
          ,
            $project:
              type: $literal: "parent"
              label: $literal: "Eff Acq"
              value: $divide:["$value", 1000]
              group: $literal: "Eff Acq"
              order:$sum: [0,19]
              variation: $divide:["$variation", 100]
              "Période": "$_id"
          ]
          [ #effet X rate
            $match:
              domain: "SA"
              Compte: $in:["3XR55XR","3XR55XRTX"]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-CALC"
              "Code Entité": "3RUD2100"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
              label: $first: "$Libellé"
          ,
            $project:
              type: $literal: "parent"
              label: 1
              value: $divide:["$value", 1000]
              group: "$label"
              order:$sum: [0,20]
              variation: $divide:["$variation", 100]
              "Période": "$_id"
         # ,
         #   $addFields:
         #     type: $literal: "parent"
         #     label: "$Libellé"
         #     value: $divide:["$Montant", 1000]
         # ,
         #   $addFields:
         #     group: "$label"
         #     order:$sum: [0,20]
          ]
          [#point d'arrivée CA N
            $match:
              domain: "SA"
              Compte: "XR55"
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-IFRS"
              "Code Entité": "3RUD2100"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              type: $sum: [0, -1]
              label: $literal: "N"
              value: $divide:["$Montant", 1000]

          ,
            $addFields:
              group: "$label"
              order:$sum: [0,21]
          ]
        ]
        multiple_queries: true
        order:
          by: "order"
        postprocess:[
          argmax: "Période"
        ,
          rename:
            values:
              "Europe du Sud":
                en: "Europe"
                fr: "Europe"
              "Europe du Nord":
                en: "Europe"
                fr: "Europe"
              "Amérique Latine":
                en: "AmLat"
                fr: "AmLat"
              "Amérique latine":
                en: "AmLat"
                fr: "AmLat"
              "Effet Travaux en valeur":
                en: "Eff Trav"
                fr: "Eff Trav"
              "Effet Périmètre en valeur":
                en: "Eff Pér"
                fr: "Eff Pér"
        ]

        precision:
          "variation":',.1%'

      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      value:"value"
      label:"label"
      groups: "group"
      variation: "variation"
      type: "type"
      style: "waterfall-variation-only no-global-evolution"
      units:
        "evolution":' %'
        "value":' M€'

    highlightedKpis: [
      name: " Var. à taux constants"
      value: "value"
      badge: 'value'
      # comment: "commentary shown bellow KPI"
      sentiment:
        value:
          domain: [0]
          range: ['negative','positive']
      precision:
        value: ',.1f'
      units: value: "%"

      data:
        value:
          query:
            domain: "SA"
            Compte: "3XR55TXEH1"
            Secteur: "3SECD004"
            Format: "3MUD006"
            Flux: "Y99"
            Exrecice: "SALES"
            Origine: "30SA-CALC"
            View: "{{ requestersManager.period.View }}"
            "Code Entité": "3RUD2100"
          field: "Montant"
          postprocess:[
            argmax: 'Période'
          ]
    ,
      name: " Var. à taux courants"
      value: "value"
      badge: 'value'
      # comment: "commentary shown bellow KPI"
      sentiment:
        value:
          domain: [0]
          range: ['negative','positive']
      precision:
        value: ',.1f'
      units: value: "%"
      data:
        value:
          query:
            domain: "SA"
            Compte: "3XR55TXEH2"
            Secteur: "3SECD004"
            Format: "3MUD006"
            Flux: "Y99"
            Exrecice: "SALES"
            Origine: "30SA-CALC"
            View: "{{ requestersManager.period.View }}"
            "Code Entité": "3RUD2100"
          field: "Montant"
          postprocess:[
            argmax: 'Période'
          ]

    ]
  }
  {
    level: 3
    title: "CA incl. Essence"
    parent_id: 10
    id: 10006
    # commentary: "CA y compris essence"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [#point de départ CA N-1
            $match:
              domain: "SA"
              Compte: "3XR55H"
              Secteur: "3SECD000"
              Format: "3MUD000"
              Flux: "Y99"
              Origine: "30SA-IFRS"
              "Code Entité": "3RUD2100"
          ,
            $addFields:
              type: $subtract: [0, 1]
              label: $literal: "N-1 "
              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: "$label"
              order: $sum: [0,1]
          ]

          [ #création label CA retail
            $match:
              domain: "SA"
              Compte: "3XR55TXVH1"
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Exrecice: "SALES"
              Origine: "30SA-CALC"
              "Code Entité": "3RUD2100"
          ,
            $addFields:
              type: $literal: "parent"
              label: $literal: "CA retail"
              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: "$label"
              order: $sum: [0,2]
          ]
          [ #création group CA essence
            $match:
              domain: "SA"
              Compte: "3XR55TXVH1"
              Secteur: "SECT1430"
              Format: "3MUD000"
              Flux: "Y99"
              Origine: "30SA-CALC"
              "Code Entité": "3RUD2100"
          ,
            $addFields:
              type: $literal: "parent"
              label: $literal: "CA essence"
              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: "$label"
              order: $sum: [0,2]
          ]
          [ #création des labels du CA essence
            $match:
              domain: "SA"
              Compte: "3XR55TXVH1"
              Secteur: "SECT1430"
              Format: "3MUD000"
              Flux: "Y99"
              Origine: "30SA-CALC"
              "Code Entité": $nin: ["3RUDAMLAADP", "3RUDASIAADP", "3RUDEURADP", "3RUD2100", "3RUDFRA09"]
          ,
            $addFields:
              type: $literal: "child"
              label: $substr: ["$Libellé Entité", 0, 2]

              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: $literal: "CA essence"
              label: $toUpper: "$label"
              order:
                $cond:[
                  $eq: ["$Code Entité", "3RUDFRAADP"]
                  3
                  $cond:[
                    $eq: ["$Code Entité", "3RUDESPADP"]
                    4
                    $cond:[
                      $eq: ["$Code Entité", "3RUDITAADP"]
                      5
                      $cond:[
                        $eq: ["$Code Entité", "3RUDBELADP"]
                        6
                        $cond:[
                          $eq: ["$Code Entité", "3RUDPOLADP"]
                          7
                          $cond:[
                            $eq: ["$Code Entité", "3RUDROUADP"]
                            8
                            $cond:[
                              $eq: ["$Code Entité", "3RUDTWNADP"]
                              9
                              $cond:[
                                $eq: ["$Code Entité", "3RUDBRAADP"]
                                10
                                11
                              ]
                            ]
                          ]
                        ]
                      ]
                    ]
                  ]
                ]
          ]
          [ #création group effet X rate
            $match:
              domain: "SA"
              Compte: "3XR55XR"
              Secteur: "3SECD000"
              Format: "3MUD000"
              Flux: "Y99"
              Origine: "30SA-CALC"
              "Code Entité": "3RUD2100"
          ,
            $addFields:
              type: $literal: "parent"
              label: "$Libellé"
              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: "$label"
              order: $sum: [0,12]
          ]
          [#point d'arrivée CA N
            $match:
              domain: "SA"
              Compte: "XR55"
              Secteur: "3SECD000"
              Format: "3MUD000"
              Flux: "Y99"
              Origine: "30SA-IFRS"
              "Code Entité": "3RUD2100"
          ,
            $addFields:
              type: $subtract: [0, 1]
              label: $literal: "N"
              value: $divide:["$Montant", 1000]

          ,
            $addFields:
              group: "$label"
              order: $sum: [0,13]
          ]
        ]
        multiple_queries: true
        order:
          by: "order"
        postprocess:[
          argmax:"Période"
        ]
        precision:
          "evolution":',.2f'
          "value":',.0f'
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      value:"value"
      label:"label"
      groups: "group"
      # variation: "evolution"
      type: "type"
      units:
        "evolution":' %'
        "value":' M€'

  }
  {
    level: 3
    title: "CA Sous-Enseignes"
    parent_id: 10
    id: 10007
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "Month"
        type: "buttons"
        datasets:["my_zone_data"]
        defaultSelected: "YTD"
    datasets:
      my_zone_data:
        units:
          value: [
            unit: " M€"
            where:
              kpi: "CA en €"
          ,
            unit: "%"
            where:
              kpi: "Evo CA vs N-1"
          ]
        query:[
          $match:
            domain:"ca_enseigne"
            Value: $ne: 0
        ,
          $addFields:
            denominateur:
              $cond:[
                $eq: ["$kpi", "CA"]
                1000
                1
              ]
        ,
          $addFields:
            value: $divide: ["$Value", "$denominateur"]

        ]

        postprocess:[
          rename:
            values:
              "Var":
                en: "Evo CA vs N-1"
                fr: "Evo CA vs N-1"
              "CA":
                en: "CA en €"
                fr: "CA en €"
        ]
        precision:
          value: [
            precision: ",.0f"
            where:
              kpi: "CA en €"
          ,
            precision: ".1f"
            where:
              kpi: "Evo CA vs N-1"
          ]
    chartOptions:
      chartType: "mapchart"
      legend: "identity-card"
      zones:
        dataset: 'my_zone_data'
        shapes:"world-topojson.json"
        label:"Country Name"
        join:
          shapes:"COUNTRY_CODE"
          data:"Country Code"
        color:"value"
      filters:
        "upper-middle":
          on: "kpi"
          type: "buttons"
          datasets:["my_zone_data"]
          order: ['Evo CA vs N-1', 'CA en €']

  }
  {
    level: 3
    title: "VA par pays"
    parent_id: 20
    id: 20000
    commentary: "Valeur et Variation du VA web en %"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    charts: [
      {
        chartType:'stackedBarchart'
        data:
          query:[
            $match:
              domain: "VA"
              Compte: $in: [ "3XR60I", "3XR60M", "3XR60ITXVH", "3XR60MTXVH"]
              Secteur: "Total"
          ,
            $addFields:
              Montant: $divide: ["$Montant", 1000]
              multiplicateur: $sum: [0, 1000]
          ]

          order:
            by: "Libellé Entité"
            custom: [
              "Groupe"
              "France"
              "Espagne"
              "Italie"
              "Belgique"
              "Pologne"
              "Roumanie"
              "Chine"
              "Taiwan"
              "Brésil"
              "Argentine"
            ]
          postprocess:[
            argmax: "Période"
          ,
            pivot:
              index: ['View','Libellé Entité', 'Période', 'multiplicateur']
              column: 'Libellé'
              value: 'Montant'
          ,
            melt:
              id: ['View', 'Libellé Entité', "Var. VA Marketplace", "Var. ventes consolidées", 'Période', "multiplicateur"]
              value: ['VA consolidé','VA Marketplace']
              dropna: true
          # ,
          #   multiply:
          #     new_column: 'Evo VA consolidé'
          #     column_1: 'Var. ventes consolidées'
          #     column_2: 'multiplicateur'
          # ,
          #   multiply:
          #     new_column: 'Evo VA Marketplace'
          #     column_1: 'Var. VA Marketplace'
          #     column_2: 'multiplicateur'
          ,
            math: [
              multiply:
                'Evo VA consolidé': ["Var. ventes consolidées","multiplicateur"]
            ]

          ,
            math: [
              multiply:
                'Evo VA Marketplace': ["Var. VA Marketplace","multiplicateur"]
            ]

          ,
            rename:
              columns:
                "Var. ventes consolidées":
                  en: "Evo VA consolidé"
                  fr: "Evo VA consolidé"
                "Var. VA Marketplace":
                  en: "Evo VA Marketplace"
                  fr: "Evo VA Marketplace"

          ]
          precision:
            "Evo VA consolidé":".1f"
            "Evo VA Marketplace": '.1f'
            Montant:[
              precision: ",.1f"
              where:
                View: "Month"
            ,
              precision: ".0f"
              where:
                View: "YTD"
            ]
        value: "value"
        label:"Libellé Entité"
        labelsOrder: [
          "Groupe"
          "France"
          "Espagne"
          "Italie"
          "Belgique"
          "Pologne"
          "Roumanie"
          "Chine"
          "Taiwan"
          "Brésil"
          "Argentine"
        ]
        groups: "Libellé"
        meta:["Evo VA consolidé","Evo VA Marketplace"]
        legend: true
        groupsOrder: ['VA consolidé','VA Marketplace']
        units:
          "Evo VA consolidé": "%"
          "Evo VA Marketplace": "%"
          Montant: " M€"
        unstackable: false
        hideEmptyGroups: true
      }
    ]
  }
  {
    level: 3
    title: "Mix VA"
    parent_id: 20
    id: 20001
    commentary: "Poids des categories et variation VA %"

    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          $match:
            domain: "VA"
            "Période":"2017.08"
            Compte: $in: ["3XR60PDS", "3XR60TXVH"]
            Secteur: $in: ["Food", "Non Food", "Services"]
            Montant: $ne: 0
        ]

        precision:
          "Var. VA %": '.0f'
        order:
          by: "Libellé Entité"
          custom: [
            "Groupe"
            "France"
            "Espagne"
            "Italie"
            "Belgique"
            "Pologne"
            "Roumanie"
            "Chine"
            "Taiwan"
            "Brésil"
            "Argentine"
          ]
        postprocess:[

          pivot:
            index:["Période", "Libellé Entité", "Secteur", "View"]
            column: "Libellé"
            value: "Montant"

        ]
      chartType:'horizontal-barchart'
      value: "Poids VA"
      variation: "Var. VA %"
      variationLegend: "Evo CA %"
      label:"Secteur"
      packs: "Libellé Entité"

      packNames: true
      units:
        "Poids VA": "%"
        "Var. VA %": "%"
      style: "no-arrow"
  }
  {
    level: 3
    title: "Passage VA"
    parent_id: 20
    id: 20002
    commentary: "Evolution du VA Web total par zone vs. N-1"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [ #Point de départ VA N-1
            $match:
              domain: "VA"
              Compte: "XR60"
              "Secteur": "Total"
              "Libellé Entité": "Groupe"
              "Période":"2016.08"
          ,
            $addFields:
              group: $literal: "Août 2016"
              label: $literal: "Août 2016"
              # label: "$Période"
              Montant: $divide: ["$Montant", 1000]
              order: $sum: [0,0]
              type: $subtract: [0,1]
          ]
          [ #création group et label France
            $match:
              domain: "VA"
              Compte: "3XR60VH"
              "Secteur": "Total"
              "Libellé Entité": "France"
              "Période":"2017.08"
          # ,
          #   $sort: "Période": -1
          # ,
          #   $limit: 2
          ,
            $addFields:
              group: $literal: "France"
              label: $literal: "France"
              Montant: $divide: ["$Montant", 1000]
              order: $sum: [0,1]
              type: $literal: "parent"
          ]
          [ #création group Zones
            $match:
              domain: "VA"
              Compte: "3XR60VH"
              "Secteur": "Total"
              "Libellé Entité": $in: ["Europe du Sud", "Europe du Nord", "Asie", "Amérique Latine"]
              "Période":"2017.08"
          # ,
          #   $sort: "Période": -1
          # ,
          #   $limit: 2
          ,
            $addFields:
              group: "$Libellé Entité"
              label: "$Libellé Entité"
              Montant: $divide: ["$Montant", 1000]
              order: $sum: [0,2]
              type: $literal: "parent"
          ]
          [ #création label pays
            $match:
              domain: "VA"
              Compte: "3XR60VH"
              Secteur: "Total"
              "Libellé Entité": $nin: ["Groupe", "France", "Europe du Sud", "Europe du Nord", "Asie", "Amérique Latine"]
              "Période": "2017.08"
              Zone: $ne: "Toutes Zones"
          ,
            $addFields:
              group: "$Zone"
              # group: $substr: ["$Libellé Entité", 0, 2]
              label: $substr: ["$Libellé Entité", 0, 2]
          ,
            $addFields:
              # group: "$Zone"
              group: $toUpper: "$group"
              label: $toUpper: "$label"
              Montant: $divide: ["$Montant", 1000]
              type: $literal: "child"
              # type: $literal: "parent"
              order:
                $cond: [
                  $eq: ["$Libellé Entité", "Es"]
                  3
                  $cond: [
                    $eq: ["$Libellé Entité", "It"]
                    4
                    $cond: [
                      $eq: ["$Libellé Entité", "Be"]
                      5
                      $cond: [
                        $eq: ["$Libellé Entité", "Po"]
                        6
                        $cond: [
                          $eq: ["$Libellé Entité", "Ro"]
                          7
                          $cond: [
                            $eq: ["$Libellé Entité", "Ch"]
                            8
                            $cond: [
                              $eq: ["$Libellé Entité", "Ta"]
                              9
                              $cond: [
                                $eq: ["$Libellé Entité", "Br"]
                                10
                                11
                              ]
                            ]
                          ]
                        ]
                      ]
                    ]
                  ]
                ]
          ]
          [ #création group et label X Rate
            $match:
              domain: "VA"
              Compte: "3XR60FX"
              Secteur: "Total"
              "Libellé Entité": "Groupe"
              "Période":"2017.08"
          # ,
          #   $sort: "Période": -1
          # ,
          #   $limit: 2
          ,
            $addFields:
              group: $literal: "X rate"
              label: $literal: "X rate"
              Montant: $divide: ["$Montant", 1000]
              order: $sum: [0,12]
              type: $literal: "parent"

          ]
          [ #Point d'arrivée VA N
            $match:
              domain: "VA"
              Compte: "XR60"
              "Secteur": "Total"
              "Libellé Entité": "Groupe"
              "Période":"2017.08"
          # ,
          #   $sort: "Période": -1
          # ,
          #   $limit: 2
          ,
            $addFields:
              group: $literal: "Août 2017"
              # label: "$Période"
              label: $literal: "Août 2017"
              Montant: $divide: ["$Montant", 1000]
              order: $sum: [15,0]
              type: $subtract: [0,1]
          ]
        ]
        multiple_queries: true

        postprocess:[
          rename:
            values:
              "AMéRIQUE LATINE":
                en: "Amlat"
                fr: "Amlat"
              "Amérique Latine":
                en: "Amlat"
                fr: "Amlat"
              "EUROPE DU SUD":
                en: "Europe du Sud"
                fr: "Europe du Sud"
              "Europe du Sud":
                en: "Europe du Sud"
                fr: "Europe du Sud"
              "EUROPE DU NORD":
                en: "Europe du Nord"
                fr: "Europe du Nord"
              "ASIE":
                en: "Asie"
                fr: "Asie"
              "Amerique Latine":
                en: "Amlat"
                fr: "Amlat"

        ]
        precision:
          "Montant":',.0f'
        order:
          by: "Libellé Entité"
          custom: [
            "Groupe"
            "Fr"
            "Es"
            "It"
            "Be"
            "Po"
            "Ro"
            "Ch"
            "Ta"
            "Br"
            "Ar"
          ]
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      dateFormat: "%B %Y"
      value:"Montant"
      label:"label"
      groups: "group"
      groupsOrder:[
        "Août 2016"
        "Groupe"
        "France"
        "Europe du Sud"
        "Europe du Nord"
        "Asie"
        "Amlat"
        "X rate"
        "Août 2017"
      ]
      # variation: "evolution"
      style: "waterfall-no-value"
      units:
        "Montant":' M€'
  }


  {
    title: 'Trafic'
    level: 3
    parent_id: 20
    id: 20004
    commentary: "Evo trafic mensuel LTM"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]

    datasets:
      bars_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR62"
            Secteur: "Total"

            View: "MONTH"
            "Période": $in:[
             "2016.09"
             "2016.10"
             "2016.11"
             "2016.12"
             "2017.01"
             "2017.02"
             "2017.03"
             "2017.04"
             "2017.05"
             "2017.06"
             "2017.07"
             "2017.08"

            ]

        ]
        units: Montant: "%"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          value: ",.0f"
      lines_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR61"
            Secteur: "Total"

            View: "MONTH"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"

            ]
        ]
        postprocess:[

          rename:
            values:
              "Trafic":
                fr: "Nb visites"
                en: "Nb visites"
        ]
        units: Montant: " k"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.0f"

    chartOptions:
      chartType: 'new-barlinechart'
      filters:
        "upper-right":
          on: "Libellé Entité"
          type: "dropdown"
          datasets: ["bars_data", "lines_data"]
          defaultSelected: "Groupe"
          order:
            custom: [
              "Groupe"
              "France"
              "Espagne"
              "Italie"
              "Belgique"
              "Pologne"
              "Roumanie"
              "Chine"
              "Taiwan"
              "Brésil"
              "Argentine"
            ]
      bars:
        dataset: 'bars_data'
        domain: [0, 100]
      label: "Période"
      value: "Montant"
      groups: "Libellé"

      lines:
        dataset: 'lines_data'
        # domain: [0, 25]
        x: "Période"
        y: "Montant"
        serie: "Libellé"

      legend: true
      dateFormat: "%B %Y"
      meta: []
      commonScale: false

  }
  {
    level: 3
    title: "Taux de conversion"
    parent_id: 20
    id: 20005
    commentary: "Evo taux de conversion LTM"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]

    datasets:
      bars_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR64"
            Secteur: "Total"
            View: "MONTH"
            "Période": $in:[

              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]

        ]
        units: Montant: "%"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.1f"

      lines_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR61"
            Secteur: "Total"
            View: "MONTH"
            "Période": $in:[

              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]
        ]
        postprocess:[
          rename:
            values:
              "Trafic":
                fr: "Nb visites"
                en: "Nb visites"
        ]
        units: Montant: " k"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.0f"

    chartOptions:
      chartType: 'new-barlinechart'
      filters:
        "upper-right":
          on: "Libellé Entité"
          type: "dropdown"
          datasets: ["bars_data", "lines_data"]
          defaultSelected: "Groupe"
          order:
            custom: [
              "Groupe"
              "France"
              "Espagne"
              "Italie"
              "Belgique"
              "Pologne"
              "Roumanie"
              "Chine"
              "Taiwan"
              "Brésil"
              "Argentine"
            ]
      bars:
        dataset: 'bars_data'
        # domain: [0, 100]
      label: "Période"
      value: "Montant"
      groups: "Libellé"

      lines:
        dataset: 'lines_data'
        # domain: [0, 25]
        x: "Période"
        y: "Montant"
        serie: "Libellé"

      legend: true
      dateFormat: "%B %Y"
      commonScale: false
      meta: []
  }
  {
    level: 3
    title: "Clients actifs"
    parent_id: 20
    id: 20007
    commentary: "Evo nombre de clients actifs LTM"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]

    datasets:
      bars_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR66"
            Secteur: "Total"
            View: "MONTH"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]
        ,
          $addFields:
            Montant: $divide: ["$Montant", 1000]
        ]
        units: Montant: " k"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          value: ",.0f"
      lines_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR61"
            Secteur: "Total"
            View: "MONTH"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]

        ]
        postprocess:[
          rename:
            values:
              "Trafic":
                fr: "Nb visites"
                en: "Nb visites"
        ]
        units: Montant: " K"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.0f"

    chartOptions:
      chartType: 'new-barlinechart'
      filters:
        "upper-right":
          on: "Libellé Entité"
          type: "dropdown"
          datasets: ["bars_data", "lines_data"]
          defaultSelected: "Groupe"
          order:
            custom: [
              "Groupe"
              "France"
              "Espagne"
              "Italie"
              "Belgique"
              "Pologne"
              "Roumanie"
              "Chine"
              "Taiwan"
              "Brésil"
              "Argentine"
            ]
      bars:
        dataset: 'bars_data'
        # domain: [0, 350000]
      label: "Période"
      value: "Montant"
      groups: "Libellé"

      lines:
        dataset: 'lines_data'
        # domain: [0, 25]
        x: "Période"
        y: "Montant"
        serie: "Libellé"

      legend: true
      dateFormat: "%B %Y"
      commonScale: false
      meta: []

  }
  {
    level: 3
    title: "Commandes"
    parent_id: 20
    id: 20006
    commentary: "Nombre de commandes et panier moyen LTM"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]

    datasets:
      bars_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR63"
            Secteur: "Total"
            View: "MONTH"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]
        ,
          $addFields:
            Montant: $divide: ["$Montant", 1000]
        ]
        units: Montant: " Mds€"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.0f"
      lines_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR65"
            Secteur: "Total"
            View: "MONTH"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]
        ]

        units: Montant: " €"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.0f"


    chartOptions:
      chartType: 'new-barlinechart'
      filters:
        "upper-right":
          on: "Libellé Entité"
          type: "dropdown"
          datasets: ["bars_data", "lines_data"]
          defaultSelected: "Groupe"
          order:
            custom: [
              "Groupe"
              "France"
              "Espagne"
              "Italie"
              "Belgique"
              "Pologne"
              "Roumanie"
              "Chine"
              "Taiwan"
              "Brésil"
              "Argentine"
            ]
      bars:
        dataset: 'bars_data'
        # domain: [0, 350000]
      label: "Période"
      value: "Montant"
      groups: "Libellé"

      lines:
        dataset: 'lines_data'
        # domain: [0, 25]
        x: "Période"
        y: "Montant"
        serie: "Libellé"
        zeroBaseline: 0

      legend: true
      dateFormat: "%B %Y"
      commonScale: false
      meta: []

  }

  {
    level: 3
    title: "Dynamique marge commerciale"
    parent_id: 30
    id: 30000
    commentary: "Evolution du taux de marge"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "comparaison"
        type: "buttons"
        defaultSelected: "vs N-1"

    chartOptions:
      chartType: 'linechart'
      filters:
        "upper-right":
          on: "Libellé Entité"
          type: "dropdown"
          order:
            custom: [
              "Groupe"
              "France"
              "Espagne"
              "Italie"
              "Belgique"
              "Pologne"
              "Roumanie"
              "Chine"
              "Taiwan"
              "Brésil"
              "Argentine"
            ]

      data:
        query:[
          [
            $match:
              domain: "actual"
              Exrecice: "A"
              View: "MONTH"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS"]
              Compte: "3TR210TX"
              Secteur: "3SECD004"
              Flux: "Y99"
              Format: "3MUD000"
          ,
            $project:
              comparaison: $literal: "Vs N-1"
              date: "$Période"
              "Période": 1
              serie: $concat: ["$Libellé", " MONTH"]
              value: "$Montant"
              View: 1
              'Libellé Entité': 1
              "Taux de marge % YTD": 1
              # "Variation taux de marge   ": 1
              # "Variation taux de marge valeur": 1
              value_pct:$divide: ["$Montant", 100]
          ]
        ,
          [
            $match:
              domain: "actual"
              Exrecice: "A"
              View: "MONTH"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS"]
              Compte: "3TR210TXH"
              Secteur: "3SECD004"
              Flux: "Y99"
              Format: "3MUD000"
          ,
            $project:
              comparaison: $literal: "Vs N-1"
              date: "$Période"
              "Période": 1
              serie: $concat: ["$Libellé", " MONTH"]
              value: "$Montant"
              View: 1
              'Libellé Entité': 1
              "Taux de marge % YTD": "$Taux de marge N-1 % YTD"
              value_pct:$divide: ["$Montant", 100]
          ]
        ,
          [
            $match:
              domain: "actual"
              Exrecice: "A"
              View: "MONTH"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS"]
              Compte: "3TR210TX"
              Secteur: "3SECD004"
              Flux: "Y99"
              Format: "3MUD000"
          ,
            $project:
              date: "$Période"
              "Période": 1
              'Libellé Entité': 1
              serie: $literal: "Tx marge MONTH"
              value: "$Montant"
              comparaison: $literal: "Vs Obj"
              "Taux de marge % YTD": 1
              View: 1
              # "Variation taux de marge   ": 1
              # "Variation taux de marge valeur": 1
              value_pct:$divide: ["$Montant", 100]
          ]
        ,
          [
            $match:
              domain: "forecast"
              Exrecice: "FORECAST"
              View: "MONTH"
              Origine: $in:["30F-COUNTRY1", "30F-IFRS"]
              Compte: "3TR210TX"
              Secteur: "3SECD004"
              Flux: "Y99"
              Format: "3MUD000"
          ,
            $project:
              date: "$Période"
              "Période": 1
              serie: $literal: "Tx marge Obj MONTH"
              "Taux de marge % YTD": 1
              value: "$Montant"
              value_pct:$divide: ["$Montant", 100]
              View: 1
              'Libellé Entité': 1
              comparaison: $literal: "Vs Obj"
              # "Variation taux de marge   ": 1
              # "Variation taux de marge valeur": 1
          ]
        ]
        multiple_queries: true
        postprocess:[
          rename:
            columns:
              'Taux de marge % MONTH':
                'en': 'Tx marge MONTH'
                'fr': 'Tx marge MONTH'

              'Taux de marge N-1 % MONTH':
                'en': 'Tx marge N-1 MONTH'
                'fr': 'Tx marge N-1 MONTH'
              'Taux de marge % YTD':
                'en': 'Tx marge YTD'
                'fr': 'Tx marge YTD'
            values:
              'Taux de marge % MONTH':
                'en': 'Tx marge MONTH'
                'fr': 'Tx marge MONTH'

              'Taux de marge N-1 % MONTH':
                'en': 'Tx marge N-1 MONTH'
                'fr': 'Tx marge N-1 MONTH'
              'Taux de marge % YTD':
                'en': 'Tx marge YTD'
                'fr': 'Tx marge YTD'
        ]
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          # value: ",.1f"
          value_pct: ".1%"
          "Tx marge YTD":".1f"

      value:"value_pct"
      date:"Période"
      groups: "serie"
      legend: true
      smoothLine: true
      dateFormat: "%B %Y"
      units:
        "value_pct": ""
        "Tx marge YTD": "%"
      metaSerie: ["Tx marge YTD"]

  }
  {
    level: 3
    title: "Marge commerciale par pays"
    parent_id: 30
    id: 30001
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS"]
              Compte: $in: ["3TR210TXH", "3TR210TX", "3TR210TXVH"]
              "Code Entité": $nin: ["3RUDAMLAADP", "3RUDASIAADP", "3RUDEURADP"]
              Format: "3MUD000"
          ,
            $addFields:
              'Libellé': $concat: ["$Libellé","$Exrecice"]
              Zone: $cond:[
                  $eq: ["$Zone", 'Toutes Zones']
                  ''
                  $cond:[
                    $eq: ["$Zone", 'France']
                    ''
                    '$Zone'
                  ]
                ]
          ]
          [
            $match:
              domain: "forecast"
              "Période": "2016.12"
              Origine:$in:["30F-COUNTRY1", "30F-IFRS"]
              Compte: $in: ["3TR210TX", "3TR210TXVH"]
              Format: "3MUD000"
              "Code Entité": $nin: ["3RUDAMLAADP", "3RUDASIAADP", "3RUDEURADP"]
          ,
            $addFields:
              'Libellé': $concat: ["$Libellé","$Exrecice"]
              Zone: $cond:[
                  $eq: ["$Zone", 'Toutes Zones']
                  ''
                  $cond:[
                    $eq: ["$Zone", 'France']
                    ''
                    '$Zone'
                  ]
                ]
          ]
        ]
        multiple_queries: true
        postprocess: [

          pivot:
            index: ['Libellé Entité','Zone', 'View' ]
            column: 'Libellé'
            value: 'Montant'
        ,
          rename:
            columns:
              'Taux de marge %A':
                'en': 'Tx réel'
                'fr': 'Tx réel'
              'Taux de marge N-1 %A':
                'en': 'Tx N-1'
                'fr': 'Tx N-1'
              'Taux de marge %FORECAST':
                'en': 'Tx obj'
                'fr': 'Tx obj'
              'Variation taux de marge  %A':
                'en': 'Var vs N-1'
                'fr': 'Var vs N-1'
              'Variation taux de marge  %FORECAST':
                'en': 'Var vs obj'
                'fr': 'Var vs obj'
        ,

          rename:
            values:
              'Toutes Zones':
                'en': 'Groupe'
                'fr': 'Groupe'

        ]
        order:
          by: "Libellé Entité"
          custom: [
            "Groupe"
            "France"
            "Espagne"
            "Italie"
            "Belgique"
            "Pologne"
            "Roumanie"
            "Chine"
            "Taiwan"
            "Brésil"
            "Argentine"
          ]
        precision:
          "Tx réel": '.1f'
          "Tx N-1": '.1f'
          'Tx obj': '.1f'
          "Var vs N-1": '.1f'
          'Var vs obj': '.1f'
      chartType: "bulletChart"
      commonScale: true
      label: "Libellé Entité"
      value: "Tx réel"
      target: 'Tx obj'
      comparison: "Tx N-1"
      packs: "Zone"
      packNames: true
      colorTargets: true
      meta: ["Var vs obj", "Var vs N-1"]

      units:
        "Tx réel":'%'
        "Tx N-1":'%'
        "Tx obj":'%'
        "Var vs obj": " pts"
        "Var vs N-1": " pts"
      sentiment:
        "Tx réel":
          domain: ['Tx obj']
          range: ['negative','positive']
  }
  {
    level: 3
    title: "Passage Marge commerciale"
    parent_id: 30
    id: 30002
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"

    chartOptions:
      data:
        query: [
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "3MUD000"
              Flux: "Y99"
              Compte: "3TR210H"
              Secteur: "3SECD004"
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
            ,
              $addFields:
                label: $literal: "Marge co N-1"
                group: $literal: "Marge co N-1"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs N-1"
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "3MUD000"
              Secteur: "3SECD004"
              Flux: "Y99"
              Compte: $in: ["3TR211EFV", "3TR211EFMIX", "3TR211EFTXNE"]
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
            ,
              $addFields:
                label: "$Libellé"
                group: $literal: "Marge de gestion"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs N-1"
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "3SECD004"
              Compte: $in: ["3XP2101VH", "3XP2103VH", "3XP2105VH"]
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
            ,
              $addFields:
                label: "$Libellé"
                group: $literal: "Autres"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs N-1"
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "3MUD000"
              Flux: "Y99"
              Compte: $in: ["3XTP200VH", "3XP2102VH", "3TR210XR"]
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
              Secteur: "3SECD004"
            ,
              $addFields:
                label: "$Libellé"
                group: "$Libellé"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs N-1"
          ]
          [
            $match:
              domain: "actual"
              Format: "3MUD000"
              "Période":"2016.12"
              Secteur: "3SECD004"
              Compte: "TR210"
              Flux: "Y99"
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
          ,
            $addFields:
              label: $literal: "Marge Co N"
              group: $literal: "Marge Co N"
              value_divided: $divide: ["$Montant", 1000]
              type: $literal : "vs N-1"
          ]
          [
            $match:
              domain: "forecast"
              "Période": "2016.12"
              Format: "3MUD000"
              Compte: "TR210"
              Flux: "Y99"
              Secteur: "3SECD004"
              Origine: $in: ["30F-COUNTRY1", "30F-IFRS"]
            ,
              $addFields:
                label: $literal: "Marge co Obj"
                group: $literal: "Marge co Obj"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs Obj"
          ]
          [
            $match:
              domain: "forecast"
              "Période": "2016.12"
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "3SECD004"
              Compte: $in: ["3TR211EFV", "3TR211EFMIX", "3TR211EFTXNE"]
              Origine: $in: ["30F-COUNTRY1", "30F-IFRS"]
            ,
              $addFields:
                label: "$Libellé"
                group: $literal: "Marge de gestion"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs Obj"
          ]
          [
            $match:
              domain: "forecast"
              "Période": "2016.12"
              Format: "3MUD000"
              Secteur: "3SECD004"
              Flux: "Y99"
              Compte: $in: ["3XP2101VH", "3XP2103VH", "3XP2105VH"]
              Origine: $in: ["30F-COUNTRY1", "30F-IFRS"]
            ,
              $addFields:
                label: "$Libellé"
                group: $literal: "Autres"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs Obj"
          ]
          [
            $match:
              domain: "forecast"
              "Période": "2016.12"
              Format: "3MUD000"
              Secteur: "3SECD004"
              Flux: "Y99"
              Compte: $in: ["3XTP200VH", "3XP2102VH", "3TR210XR"]
              Origine: $in: ["30F-COUNTRY1", "30F-IFRS","30F-RATE-BGT","30F-COUN-BUD"]
            ,
              $addFields:
                label: "$Libellé"
                group: "$Libellé"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs Obj"
          ]
          [
            $match:
              domain: "actual"
              Format: "3MUD000"
              "Période":"2016.12"
              Secteur: "3SECD004"
              Compte: "TR210"
              Flux: "Y99"
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
          ,
            $addFields:
              label: $literal: "Marge Co N"
              group: $literal: "Marge Co N"
              value_divided: $divide: ["$Montant", 1000]
              type: $literal : "vs Obj"
          ]

        ]
        multiple_queries: true

        postprocess: [

          rename:
            values:
              "Evo. Shrinkage":
                fr: "Démarque"
                en: "Démarque"
              "Evo. Fidélité":
                fr: "Fid"
                en: "Fid"
              "Evo Autre":
                fr: "Autre"
                en: "Autre"
              "Evo Cts logistique":
                fr: "Log"
                en: "Log"
              "Evo Décote":
                fr: "Décote"
                en: "Décote"
              "Effet volume":
                fr: "Eff Volume"
                en: "Eff Volume"
              "Effet taux net du mix %":
                fr: "Eff Taux"
                en: "Eff Taux"
              "Effet mix %":
                fr: "Eff Mix"
                en: "Eff Mix"
        ]
        precision:
          evolution: ",.1f"
          value_divided: ",.0f"
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      style: "waterfall-no-evol-highlight"
      value: "value_divided"
      label: "label"
      groups: "group"
      groupsOrder:[
        "Marge co N-1"
        "Marge co Obj"
        "Marge de gestion"
        "MARGE DE GESTION"
        "Démarque"
        "Evo. Fidélité"
        "EVO. FIDÉLITÉ"
        "Autres"
        "Effet X rates"
        "Marge co N"
      ]
      # type: "niveau"
      variation: ""
      units:
        evolution: " %"
        value_divided: " M€"
      filters:
        "upper-middle":
          on: "type"
          type: "buttons"
          order: custom: ["vs N-1", "vs Obj"]
        "upper-right":
          on: "Libellé Entité"
          type: "dropdown"
          defaultSelected: "Groupe"
          order:
            custom: [
              "Groupe"
              "France"
              "Espagne"
              "Italie"
              "Belgique"
              "Pologne"
              "Roumanie"
              "Chine"
              "Taiwan"
              "Brésil"
              "Argentine"
            ]
  }
  {
    level: 3
    title: "Mix Promo"
    parent_id: 30
    id: 30003
    commentary: "Poids des promotions sur les hypermarchés intégrés"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          $match:
            domain: "actual"
            "Période":"2016.12"
            Compte: $in: ["3MPROMO", "3MPROMOVH", "3PDSPROMO", "3PDSPROMOVH"]
            Secteur: "3SECT1010"
            Format: "3FORM1011"
            Origine: "30A-ADPLC"
        ,
          $addFields:
            order:
              $switch:
                branches: [
                  case: $eq: ["$Libellé Entité", "Groupe"]
                  then: 1
                ,
                  case: $eq: ["$Libellé Entité", "France"]
                  then: 2
                ,
                  case: $eq: ["$Libellé Entité", "Espagne"]
                  then: 3
                ,
                  case: $eq: ["$Libellé Entité", "Italie"]
                  then: 4
                ,
                  case: $eq: ["$Libellé Entité", "Belgique"]
                  then: 5
                ,
                  case: $eq: ["$Libellé Entité", "Pologne"]
                  then: 6
                ,
                  case: $eq: ["$Libellé Entité", "Roumanie"]
                  then: 7
                ,
                  case: $eq: ["$Libellé Entité", "Chine"]
                  then: 8
                ,
                  case: $eq: ["$Libellé Entité", "Taiwan"]
                  then: 9
                ,
                  case: $eq: ["$Libellé Entité", "Brésil"]
                  then: 10
                ,
                  case: $eq: ["$Libellé Entité", "Argentine"]
                  then: 11
                ]
                default: 12
        ]
        postprocess:[
          fillna:
            column: 'View'
            value: "YTD"
        ,
          pivot:
            index: ['Libellé Entité','View', "Période", "Zone", "order"]
            column: 'Libellé'
            value: 'Montant'
        ,
          rename:
            columns:
              "Margin  Promo %":
                en: "Tx marge Promo"
                fr: "Tx marge Promo"
              "Variation Marge Promo %":
                en: "Var Tx marge Promo"
                fr: "Var Tx marge Promo"
        ]
        order:
          by: "order"
        precision:
          'Tx marge Promo': ",.1f"
          "Poids  Promo %": ",.1f"
          "Variation Poids Promo %": ".1f"
          "Var Tx marge Promo": ".1f"

      chartType: "horizontal-barchart"
      packs: "Zone"
      packNames: true
      value: "Poids  Promo %"
      variation: "Variation Poids Promo %"
      variationLegend: "Var poids<br> vs N-1"
      label: "Libellé Entité"
      meta: ['Tx marge Promo', "Var Tx marge Promo"]
      units:
        'Tx marge Promo': "%"
        "Variation Poids Promo %": " pts"
        "Poids  Promo %" : "%"
        "Var Tx marge Promo %": "%"
      legend: true
      style: "no-value-legend"
      sparklines:
        orderDates: true
        value: "Montant"
        units: Montant : "%"
        legend: "Evo sur<br>12 mois"
        joins: [
          "Libellé Entité"
        ]
        date: "Période"
        data:
          query:
            domain: "actual"
            # Compte: $in: ["3MPROMO", "3MPROMOVH", "3PDSPROMO", "3PDSPROMOVH"]
            Compte: "3MPROMO"
            Secteur: "3SECT1010"
            Format: "3FORM1011"
            Origine: "30A-ADPLC"
            View: "MONTH"

  }

  {
    level: 3
    title: "Mix MN / MDD"
    parent_id: 30
    id: 30004
    commentary: "Poids MN / MDD"

    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"

    chartOptions:
      data:
        query:[
          [
            $match:
              domain:"actual"
              Origine: "30A-ADPLC"
              #Compte: [ "3XR5103TX", "3XR5103TXVH", "3XR5106TX", "3XR5106TXVH", "3XTR511TX", "3XTR511TXVH", "3XTR514TX", "3XTR514TXVH"]
              Compte: $in:[ "3XR5103TX", "3XR5103TXVH", "3XR5106TX", "3XR5106TXVH"]
              "Libellé Entité": $ne: "Groupe"
              Flux: "Y99"
              Format: "3MUD046"
          ,
            $group:
              _id:
                'Libellé Entité': "$Libellé Entité"
                View: "$View"
              "Poids N": $first:"$Poids MN %"
              "Poids N-1" : $first:"$Variation Poids MN %"
              "Var Tx de marge": $first:"$Variation Marge MN %"
              "Tx de marge": $first:"$Marge MN %"
              "Montant": $sum: "$Montant"
          ,
            $project:
              'Libellé Entité': "$_id.Libellé Entité"
              View: "$_id.View"
              label: $literal: "MN"
              "Poids N": 1
              "Poids N-1": $add:["$Poids N", "$Poids N-1"]
              "Var Tx de marge": 1
              "Tx de marge": 1
          ,
            $sort:
              # 'Entité': 1
              label: -1
          ]
        ,
          [
            $match:
              domain:"actual"
              Origine: "30A-ADPLC"
              Compte: $in:["3XTR511TX", "3XTR511TXVH", "3XTR514TX", "3XTR514TXVH"]
              "Libellé Entité": $ne: "Groupe"
              Flux: "Y99"
              Format: "3MUD046"
          ,
            $group:
              _id:
                'Libellé Entité': "$Libellé Entité"
                View: "$View"
              "Poids N": $first:"$Poids MDD %"
              "Poids N-1" : $first:"$Variation Poids MDD %"
              "Var Tx de marge": $first:"$Variation Marge MDD %"
              "Tx de marge": $first:"$Marge MDD %"
              "Montant": $sum: "$Montant"
          ,
            $project:
              'Libellé Entité': "$_id.Libellé Entité"
              View: "$_id.View"
              label: $literal: "MDD"
              "Poids N": 1
              "Poids N-1": $add:["$Poids N", "$Poids N-1"]
              "Var Tx de marge": 1
              "Tx de marge": 1
          ,
            $sort:
              # 'Entité': 1
              label: -1
          ]
        ]
        multiple_queries: true
        precision:
          "Poids N": ".1f"
          "Poids N-1": ".1f"
          "Var Tx de marge": ".1f"
          "Tx de marge": ".1f"

      chartType:'bulletChart'
      value: "Poids N"
      packs:"Libellé Entité"
      packsOrder: [ "Groupe", "France", "Espagne", "Italie", "Belgique", "Pologne", "Roumanie", "Chine", "Taiwan", "Brésil", "Argentine" ]
      commonScale: true
      label: "label"
      target: "Poids N-1"
      meta:[ "Tx de marge", "Var Tx de marge" ]
      units:
        "Poids N": "%"
        "Poids N-1": "%"
        "Var Tx de marge": " pts"
        "Tx de marge": "%"
      legend: true


  }
  {
    level: 3
    title: "Variation démarque"
    parent_id: 30
    id: 30005
    commentary: "Var. Démarque % vs N-1"

    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:
          domain: "actual"
          Exrecice: "A"
          "Période":"2016.12"
          Format: "3MUD000"
          Compte: "3XTP200TXVH"
          Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]

        order:
          by: "Libellé Entité"
          custom: [
            "Groupe"
            "France"
            "Espagne"
            "Italie"
            "Belgique"
            "Pologne"
            "Roumanie"
            "Chine"
            "Taiwan"
            "Brésil"
            "Argentine"
          ]
        precision:
          Montant:".2f"
      chartType:'leaderboardCenteredAverage'
      value: "Montant"
      label:"Libellé Entité"

      hideAverageBox: true
      average: 0
      units:
        Montant: " pts"
  }

  {
    title: 'Dynamique Coûts'
    level: 3
    parent_id: 40
    id: 40001
    commentary: "Evolution coûts de distribution %"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        defaultSelected: "vs N-1"
        order: custom: ["vs N-1","vs Obj"]


    chartOptions:
      chartType: 'linechart'
      filters:
        "upper-right":
          on: "Libellé Entité"
          type: "dropdown"
          defaultSelected: "Groupe"
          order:
            custom: [
              "Groupe"
              "France"
              "Espagne"
              "Italie"
              "Belgique"
              "Pologne"
              "Roumanie"
              "Chine"
              "Taiwan"
              "Brésil"
              "Argentine"
            ]

      data:
        query:[
          [
            $match:
              domain:"actual"
              Format: "3MUD000"

              View: "MONTH"
              Exrecice:"A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Compte: "3TR300TX"
          ,
            $addFields:
              Filtre1: $literal: 'vs Obj'
              "Tx CD YTD": "$Taux de CDD % YTD"
          ]
        ,
          [
            $match:
              domain:"forecast"
              Format: "3MUD000"
              View: "MONTH"
              Exrecice:"FORECAST"
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              'Compte': "3TR300TX"
          ,
            $addFields:
              'Libellé': $literal: 'Taux Budget'
              Filtre1: $literal: 'vs Obj'
              "Tx CD YTD": "$Taux de CDD % YTD"
          ]
        ,
          [
            $match:
              domain:"actual"
              Format: "3MUD000"
              View: "MONTH"
              Exrecice:"A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Compte: "3TR300TX"
          ,
            $addFields:
              Filtre1: $literal: 'vs N-1'
              "Tx CD YTD": "$Taux de CDD % YTD"
          ]
        ,
          [
            $match:
              domain:"actual"
              View: "MONTH"
              Format: "3MUD000"
              Exrecice:"A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Compte: "3TR300TXH"
          ,
            $addFields:
              Filtre1: $literal: 'vs N-1'
              "Tx CD YTD": "$Taux de CDD N-1 % YTD"
          ]

        ]
        multiple_queries: true
        postprocess:[
          rename:
            values:
              "Taux de CDD %":
                en: "Tx CD % MONTH"
                fr: "Tx CD % MONTH"
              "Taux de CDD N-1 %":
                en: "Tx CD N-1 % MONTH"
                fr: "Tx CD N-1 % MONTH"
              "Taux Budget":
                en: "Tx CD Objectif % MONTH"
                fr: "Tx CD Objectif % MONTH"
        ]
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.1f"
          "Tx CD YTD": ",.1f"

      value:"Montant"
      date:"Période"
      groups: "Libellé"
      legend: true
      smoothLine: true
      dateFormat: '%B %Y'
      units:
        "Montant": "%"
        "Taux YTD": " %"
        "Tx CD YTD": "%"
      metaSerie: ["Tx CD YTD"]

  }
  {
    level: 3
    parent_id: 40
    id: 40002
    title: "Coûts de distribution par pays"
    commentary: "Coûts de distribution par pays en %"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "view"
        type: "buttons"
        defaultSelected: "YTD"

    chartOptions:
      data:
        query:[
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              domain: $in: ["actual", "forecast"]
              Compte: $in: ["3TR300TX", "3TR300TXH"]
              Origine: $in: ["30A-IFRS", "30F-IFRS", "30A-COUNTRY1", "30F-COUNTRY1"]
              "Libellé Entité": $in: ["Groupe", "France"]
          ,
            $addFields:
              value_positive: $multiply: ["$Montant", -1]
              label: $concat: ["$Libellé", "$Exrecice"]
          ,
            $sort:
              "Compte": 1
          ,
            $group:
              _id:
                pack: "$Libellé Entité"
                period: "$Période"
                view: "$View"

              kpi:
                $push: "$label"
              value_kpi:
                $push: "$value_positive"
          ,
            $addFields:
              pack: "$_id.pack"
              period: "$_id.period"
              view: "$_id.view"
              "Taux N-1":
                $arrayElemAt: [
                  "$value_kpi"
                  2
                ]
              "Taux réel":
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              "Taux objectif":
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              Filtre1: $literal: "vs N-1"
              entite: $literal: ""
              "NB": $literal: "Le % présenté est un % négatif"
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              domain: $in: ["actual", "forecast"]
              Compte: $in: ["3TR300TX", "3TR300TXH"]
              Origine: $in: ["30A-COUNTRY1", "30F-COUNTRY1"]
              "Libellé Entité": $nin: ["Groupe", "France"]
          ,
            $addFields:
              value_positive: $multiply: ["$Montant", -1]
              label: $concat: ["$Libellé", "$Exrecice"]
          ,
            $sort:
              "Compte": 1
          ,
            $group:
              _id:
                entite: "$Libellé Entité"
                period: "$Période"
                view: "$View"
              pack: $first: "$Zone"

              kpi:
                $push: "$label"
              value_kpi:
                $push: "$value_positive"

          ,
            $addFields:
              entite: "$_id.entite"
              period: "$_id.period"
              view: "$_id.view"
              "Taux N-1":
                $arrayElemAt: [
                  "$value_kpi"
                  2
                ]
              "Taux réel":
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              "Taux objectif":
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              Filtre1: $literal: "vs N-1"
              "NB": $literal: "Le % présenté est un % négatif"
              pack: "$pack"
          ]
        ]
        multiple_queries: true
        precision:
          "Evolution vs N-1": "+,.1f"
          "Taux réel":",.1f"
          "Taux N-1":",.1f"
          "Taux objectif":",.1f"
        order:
          by: "entite"
          custom: [
            "Groupe"
            "France"
            "Espagne"
            "Italie"
            "Belgique"
            "Pologne"
            "Roumanie"
            "Chine"
            "Taiwan"
            "Brésil"
            "Argentine"
          ]

      chartType: "bulletChart"

      commonScale: true
      label: "entite"
      value: "Taux réel"
      target: "Taux objectif"
      comparison: "Taux N-1"
      packs: "pack"
      packNames: true
      packsOrder:[
        "Groupe"
        "France"

        "Europe du Sud"
        "Europe du Nord"
        "Asie"
        "Amérique latine"
      ]
      colorTargets: true
      # meta: ["Variation vs N-1", "Variation vs objectif"]
      # meta: ["NB"]
      units:
        "Taux réel":' %'
        "Taux N-1":' %'
        "Taux objectif":' %'
        "Variation vs N-1": " pts"
        "Variation vs objectif": " pts"

      sentiment:
        "Taux réel":
          domain: ['Objectif']
          range: ['positive','negative']
  }
  {
    level:3
    parent_id:40
    id:40003
    title: "Passage couts de distribution par pays"
    commentary: "Contribution par pays à la var. du taux de coûts de distribution"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query: [
          [
            $match:
              domain: "actual"
              Format: "3MUD000"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300TXH"
              Origine: "30A-IFRS"
              Exrecice: "A"
          ,
            $addFields:
              niveau: $literal: -1
              Filtre1: $literal: "vs N-1"
              Zone: $literal: "Tx CDD N-1"
              Pays: $literal: "Tx CDD N-1"
              value_divided: "$Montant"
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "3MUD000"
              # "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300CONTRI"
              Origine: "30A-COUNTRY1"
              Exrecice: "A"
          ,
            $addFields:
              Filtre1: $literal: "vs N-1"
              Pays: $toUpper: $substr: ["$Libellé Entité", 0, 2]
              Zone: "$Zone"
              value_divided: "$Montant"
              niveau: $literal: "child"

          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "3MUD000"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300EFMIX"
              Origine: "30A-IFRS"
              Exrecice: "A"
          ,
            $addFields:
              niveau: $literal: "parent"
              Filtre1: $literal: "vs N-1"
              Zone: $literal: "Effet Mix"
              Pays: $literal: "Effet Mix"
              value_divided: "$Montant"
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "3MUD000"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300TX"
              Origine: "30A-IFRS"
              Exrecice: "A"
          ,
            $addFields:
              niveau: $literal: -1
              Filtre1: $literal: "vs N-1"
              Zone: $literal: "Tx CDD N"
              Pays: $literal: "Tx CDD N"
              value_divided: "$Montant"
          ]


          [
            $match:
              domain: "forecast"
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300TX"
              Origine: "30F-IFRS"
              Exrecice: "FORECAST"
          ,
            $addFields:
              niveau: $literal: -1
              Filtre1: $literal: "vs Obj"
              Zone: $literal: "Tx CDD Objectif"
              Pays: $literal: "Tx CDD Objectif"
              value_divided: "$Montant"
          ]
          [
            $match:
              domain: "forecast"
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              # "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300CONTRI"
              Origine: "30F-COUNTRY1"
              Exrecice: "FORECAST"
          ,
            $addFields:
              Filtre1: $literal: "vs Obj"
              Pays: $toUpper: $substr: ["$Libellé Entité", 0, 2]
              Zone: "$Zone"
              value_divided: "$Montant"
              niveau: $literal: "child"

          ]
          [
            $match:
              domain: "forecast"
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300EFMIX"
              Origine: "30F-IFRS"
              Exrecice: "FORECAST"
          ,
            $addFields:
              niveau: $literal: "parent"
              Filtre1: $literal: "vs Obj"
              Zone: $literal: "Effet Mix"
              Pays: $literal: "Effet Mix"
              value_divided: "$Montant"
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "3MUD000"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300TX"
              Origine: "30A-IFRS"
              Exrecice: "A"
          ,
            $addFields:
              niveau: $literal: -1
              Filtre1: $literal: "vs Obj"
              Zone: $literal: "Tx CDD N"
              Pays: $literal: "Tx CDD N"
              value_divided: "$Montant"
          ]

        ]
        multiple_queries: true
        postprocess:[
          rename:
            values:
              "FR":
                fr: "France"
                en: "France"
        ]
        order:
          by: "Zone"
          custom: [
            "Tx CDD N-1"
            "Tx CDD Objectif"
            "France"
            "Europe du Sud"
            "Europe du Nord"
            "Asie"
            "Amérique latine"
            "Effet Mix"
            "Tx CDD N"
          ]
        precision:
          evolution: ",.1f"
          value_divided: ",.2f"
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      filters:
        "upper-middle":
          on: "Filtre1"
          type: "buttons"
          defaultSelected: "YTD"
      value: "value_divided"
      label: "Pays"
      groups: "Zone"
      # type: "Niveau"

      variation: ""
      units:
        evolution: " %"
        value_divided: " %"
      style: "waterfall-no-value"

    highlightedKpis: [
      name: "YTD vs N-1"
      ###attention il faudra rendre les highlighted filtrable par MTD / YTD ###
      value: "value"
      badge: "value"
      # comment: "commentary shown bellow KPI"
      sentiment:
        value:
          domain: [0]
          range: ['negative','positive']
      precision:
        value: '+,.2f'
      units: value: " Pts"

      data:
        value:
          query:
            domain: "actual"
            "Période":"2016.12"
            Compte: "3TR300TXVH"
            Origine: "30A-IFRS"
            Exrecice: "A"
            View: "YTD"

          field: "Montant"
    ,
      name: "YTD vs Obj"
      value: "value"
      badge: "value"
      # comment: "commentary shown bellow KPI"
      sentiment:
        value:
          domain: [0]
          range: ['negative','positive']
      precision:
        value: '+,.2f'
      units: value: " Pts"

      data:
        value:
          query:
            domain: "forecast"
            "Période": $in: [ "2016.12",2016.12]
            Compte: "3TR300TXVH"
            Origine: "30F-IFRS"
            Exrecice: "FORECAST"
            View: "YTD"

          field: "Montant"


    ]
  }
  {
    title:"Variation Frais de Personnel"
    level:3
    id:40004
    parent_id: 40
    commentary: "Var. Frais de Personnel % YTD"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        defaultSelected: "N-1"
        order: custom: ["vs N-1", "vs Obj"]
    chartOptions:
      data:
        query:[
          [
            $match:
              domain:"actual"
              "Période":"2016.12"
              Format: "3MUD000"
              Compte: $in: ["3TR310TXVH", "3TR310VH"]
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              # "Libellé Entité": "{{ report.entityName }}"
              "View": $ne: "MONTH"
          ,
            $group:
              _id:
                entite: "$Libellé Entité"
                period: "$Période"
                view: "$View"

              kpi:
                $push: "$Libellé"
              value_kpi:
                $push: "$Montant"
          ,
            $addFields:
              entite: "$_id.entite"
              period: "$_id.period"
              view: "$_id.view"
              evol:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              Filtre1: $literal: "vs N-1"
          ,
            $addFields:
              value_divided: $divide: ["$value", 1000]
          ]
          [
            $match:
              domain:"forecast"
              "Période": "2016.12"
              Format: "3MUD000"
              Compte: $in: ["3TR310TXVF", "3TR310VF"]
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              # "Libellé Entité": "{{ report.entityName }}"
              # "Libellé entité ": "Groupe"
              # "Libellé": "Variation FP vs N-1 %"
              "View": $ne: "MONTH"
          ,
            $group:
              _id:
                entite: "$Libellé Entité"
                period: "$Période"
                view: "$View"

              kpi:
                $push: "$Libellé"
              value_kpi:
                $push: "$Montant"
          ,
            $addFields:
              entite: "$_id.entite"
              period: "$_id.period"
              view: "$_id.view"
              evol:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              Filtre1: $literal: "vs Obj"
          ,
            $addFields:
              value_divided: $divide: ["$value", 1000]
          ]

        ]
        multiple_queries: true

        order:
          by: "entite"
          custom: [
            "Groupe"
            "France"
            "Espagne"
            "Italie"
            "Belgique"
            "Pologne"
            "Roumanie"
            "Chine"
            "Taiwan"
            "Brésil"
            "Argentine"
          ]
        precision:
          "evol": ",.1f"
          "value": ",.0f"

      chartType: "leaderboardCenteredAverage"
      value:"evol"
      label:"entite"
      labelsOrder: [
        "Groupe"
        "France"
        "Espagne"
        "Italie"
        "Belgique"
        "Pologne"
        "Roumanie"
        "Chine"
        "Taiwan"
        "Brésil"
        "Argentine"
      ]
      average:0
      variation: "value_divided"
      variationLegend: "Var. en M€"
      hideAverageBox: true
      units:
        "value_divided": " M€"
        "evol": " pts"
      style: "no-arrow"

  }

  {
    title:"Variation Frais Généraux"
    level:3
    id:40005
    parent_id: 40
    commentary: "Var. Frais généraux % YTD"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        defaultSelected: "N-1"
        order: custom: ["vs N-1", "vs Obj"]
    chartOptions:
      data:
        query:[
          [
            $match:
              domain:"actual"
              "Période":"2016.12"
              Format: "3MUD000"
              Compte: $in: ["3TR330TXVH", "3TR330VH"]
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              # "Libellé Entité": "{{ report.entityName }}"
              "View": $ne: "MONTH"
          ,
            $group:
              _id:
                entite: "$Libellé Entité"
                period: "$Période"
                view: "$View"

              kpi:
                $push: "$Libellé"
              value_kpi:
                $push: "$Montant"
          ,
            $addFields:
              entite: "$_id.entite"
              period: "$_id.period"
              view: "$_id.view"
              evol:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              Filtre1: $literal: "vs N-1"
          ,
            $addFields:
              value_divided: $divide: ["$value", 1000]
          ]
          [
            $match:
              domain:"forecast"
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              Compte: $in: ["3TR330TXVF", "3TR330VF"]
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              # "Libellé Entité": "{{ report.entityName }}"
              # "Libellé entité ": "Groupe"
              # "Libellé": "Variation FP vs N-1 %"
              "View": $ne: "MONTH"
          ,
            $group:
              _id:
                entite: "$Libellé Entité"
                period: "$Période"
                view: "$View"

              kpi:
                $push: "$Libellé"
              value_kpi:
                $push: "$Montant"
          ,
            $addFields:
              entite: "$_id.entite"
              period: "$_id.period"
              view: "$_id.view"
              evol:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              Filtre1: $literal: "vs Obj"
          ,
            $addFields:
              value_divided: $divide: ["$value", 1000]
          ]

        ]
        multiple_queries: true

        order:
          by: "entite"
          custom: [
            "Groupe"
            "France"
            "Espagne"
            "Italie"
            "Belgique"
            "Pologne"
            "Roumanie"
            "Chine"
            "Taiwan"
            "Brésil"
            "Argentine"
          ]
        precision:
          "evol": ",.1f"
          "value": ",.0f"

      chartType: "leaderboardCenteredAverage"
      value:"evol"
      label:"entite"
      labelsOrder: [
        "Groupe"
        "France"
        "Espagne"
        "Italie"
        "Belgique"
        "Pologne"
        "Roumanie"
        "Chine"
        "Taiwan"
        "Brésil"
        "Argentine"
      ]
      average:0
      variation: "value_divided"
      variationLegend: "Var. en M€"
      hideAverageBox: true
      units:
        "value_divided": " M€"
        "evol": " pts"
      style: "no-arrow"

  }


  {
    level: 3
    parent_id: 50
    id: 50001
    title: "Profitabilité ROC par pays"
    comment: "Profitabilité par Pays vs Objectif et N-1 (en M€)"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              Compte: $in: ["TR160", "3TR160H"]
              "Libellé Entité": $in: ["Groupe", "France"]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              Zone: "$Libellé Entité"
              "Libellé Entité": $literal: ""
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              Compte: $in: ["TR160", "3TR160H"]
              "Libellé Entité": $nin: ["Groupe", "France"]
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              Compte: $in: ["3TR160TXVH", "3TR160TXVF"]
              "Libellé Entité": $in: ["Groupe", "France"]
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              Zone: "$Libellé Entité"
              "Libellé Entité": $literal: ""
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: "$Montant"
          ]
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              Compte: $in: ["3TR160TXVH", "3TR160TXVF"]
              "Libellé Entité": $nin: ["Groupe", "France"]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: "$Montant"
          ]
        ]
        multiple_queries: true
        postprocess: [

          pivot:
            index: ['Libellé Entité','Zone', 'View', 'Période']
            column: 'LibelléA'
            value: 'value_divided'
        ,
          rename:
            values:
              "Toutes Zones":
                fr: "Groupe"
                en: "Groupe"
            columns:
              'ROC - Recurring operating resultA':
                'en': 'Réel'
                'fr': 'Réel'
              "ROC  N-1A":
                'en': 'N-1'
                'fr': 'N-1'
              'ROC - Recurring operating resultFORECAST':
                'en': 'Obj'
                'fr': 'Obj'
              'Variation ROC vs N-1 %A':
                'en': 'Var vs N-1'
                'fr': 'Var vs N-1'
              'Variation ROC vs Budget %FORECAST':
                'en': 'Var vs Obj'
                'fr': 'Var vs Obj'
        ]
        precision:
          "Réel": '.0f'
          "N-1": '.0f'
          'Obj': '.0f'
          "Var vs N-1": '+.1f'
          'Var vs Obj': '+.1f'

        order:
          by: "Libellé Entité"
          custom: [
            "Groupe"
            "France"
            "Espagne"
            "Italie"
            "Belgique"
            "Pologne"
            "Roumanie"
            "Chine"
            "Taiwan"
            "Brésil"
            "Argentine"
          ]

      chartType: "bulletChart"
      commonScale: true
      label: "Libellé Entité"
      value: "Réel"
      target: "Obj"
      comparison: 'N-1'
      packs: "Zone"
      packsOrder: [
        "Groupe"
        "France"
        "Europe du Sud"
        "Europe du Nord"
        "Asie"
        "Amérique latine"
      ]
      packNames: true
      colorTargets: true
      meta: [
        "Var vs Obj"
        "Var vs N-1"
      ]
      units:
        "Réel":' M€'
        "N-1":' M€'
        "Obj":' M€'
        "Var vs N-1": " pts"
        "Var vs Obj": " pts"

      sentiment:
        "Réel":
          domain: ['objectif']
          range: ['negative','positive']
  }
  {
    level: 3
    parent_id: 50
    id: 50004
    title: "Profitabilité ROCDA par pays"
    comment: "Profitabilité par Pays vs Objectif et N-1 (en M€)"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              Compte: $in: ["3TR180NH", "3TR180N"]
              "Libellé Entité": $in: ["Groupe", "France"]
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              Zone: "$Libellé Entité"
              "Libellé Entité": $literal: ""
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Format: "3MUD000"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              "Libellé Entité": $nin: ["Groupe", "France"]
              Compte: $in: ["3TR180NH", "3TR180N"]
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Format: "3MUD000"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              "Libellé Entité": $in: ["Groupe", "France"]
              Compte: $in: ["3TR180NTXVF", "3TR180NTXVH"]
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              Zone: "$Libellé Entité"
              "Libellé Entité": $literal: ""
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: "$Montant"
          ]
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              "Libellé Entité": $nin: ["Groupe", "France"]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Compte: $in: ["3TR180NTXVF", "3TR180NTXVH"]
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: "$Montant"
          ]
        ]
        multiple_queries: true
        postprocess: [

          pivot:
            index: ['Libellé Entité','Zone', 'View', 'Période']
            column: 'LibelléA'
            value: 'value_divided'
        ,
          rename:
            values:
              values:
                "Toutes Zones":
                  fr: "Groupe"
                  en: "Groupe"
            columns:
              'ROCDA Net Amort LogA':
                'en': 'Réel'
                'fr': 'Réel'
              'ROCDA  Net Amort Log N-1A':
                'en': 'N-1'
                'fr': 'N-1'
              'ROCDA Net Amort LogFORECAST':
                'en': 'Obj'
                'fr': 'Obj'
              'Variation ROCDA Net Amort Log en taux vs N-1 %A':
                'en': 'Var vs N-1'
                'fr': 'Var vs N-1'
              'Variation ROCDA Net Amort Log en taux vs Budget %FORECAST':
                'en': 'Var vs Obj'
                'fr': 'Var vs Obj'
        ]
        precision:
          "Réel": '.0f'
          "N-1": '.0f'
          'Obj': '.0f'
          "Var vs N-1": '+.1f'
          'Var vs Obj': '+.1f'

        order:
          by: "Libellé Entité"
          custom: [
            "Groupe"
            "France"
            "Espagne"
            "Italie"
            "Belgique"
            "Pologne"
            "Roumanie"
            "Chine"
            "Taiwan"
            "Brésil"
            "Argentine"
          ]

      chartType: "bulletChart"
      commonScale: true
      label: "Libellé Entité"
      value: "Réel"
      target: "Obj"
      comparison: 'N-1'
      packs: "Zone"
      packsOrder: [
        "Groupe"
        "France"
        "Europe du Sud"
        "Europe du Nord"
        "Asie"
        "Amérique latine"
      ]
      packNames: true
      colorTargets: true
      meta: [
        "Var vs Obj"
        "Var vs N-1"
      ]
      units:
        "Réel":' M€'
        "N-1":' M€'
        "Obj":' M€'
        "Var vs N-1": " pts"
        "Var vs Obj": " pts"

      sentiment:
        "Réel":
          domain: ['objectif']
          range: ['negative','positive']
  }
  {
    level: 3
    title: "Constitution ROC"
    parent_id: 50
    id: 50002
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "Vs N-1"
    chartOptions:
      chartType: "score-card"
      filters:
        "upper-right":
          on: "Filtre1"
          type: "buttons"
          defaultSelected: "YTD"
        "upper-middle":
          on: "Libellé Entité"
          type: "dropdown"
          defaultSelected: "Groupe"
          order:
            custom:["Groupe", "France", "Espagne", "Italie", "Belgique", "Pologne", "Roumanie", "Chine", "Taiwan", "Brésil", "Argentine"]
      value: "value_divided"
      label: "Libellé"
      variation: "variation"
      variationLegend: 'Ecart'
      packs: "Filtre2"
      packNames: true
      groups: "pack"
      data:
        query:[
  # Taux constants N-1 var €
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "R50000"
              # View: "MONTH"
          ,
            $addFields:
              value_divided: $divide: ["$Montant", 1000]
              "Libellé": $literal: "CA"
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "€"
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Compte: "TR210"

              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Marge Co"
              value_divided: $divide: ["$Montant", 1000]
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "€"
              variation: $divide: ["$Variation de marge valeur  N vs N-1", 1000]
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Compte:"3TR205"

              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Autres revenus"
              value_divided: $divide: ["$Montant", 1000]
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "€"
              variation: $divide: ["$Variation valeur d'Autres Rev vs N-1", 1000]
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR310"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Frais de personnel"
              value_divided: $divide: ["$Montant", 1000]
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "€"
              variation: $divide: ["$Variation FP vs N-1 valeur", 1000]
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte:"3TR350"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Frais généraux"
              value_divided: $divide: ["$Montant", 1000]
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "€"
              variation: $divide: ["$Variation valeur de FG vs N-1", 1000]
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR340"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Loyers"
              value_divided: $divide: ["$Montant", 1000]
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "€"
              variation: $divide: ["$Variation valeur loyers vs N-1", 1000]
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR400"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Dépréciations"
              value_divided: $divide: ["$Montant", 1000]
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "€"
              variation: $divide: ["$Variation valeur d'Am&D vs N-1", 1000]
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR160"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "ROC"
              value_divided: $divide: ["$Montant", 1000]
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "€"
              variation: $divide: ["$Variation Valeur ROC vs N-1", 1000]
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR180N"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "ROCDA"
              value_divided: $divide: ["$Montant", 1000]
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "€"
              variation: $divide: ["$Variation Valeur ROCDA Net Amort Log vs N-1", 1000]
          ]
  # Taux courants N-1 var €

           [
             $match:
               domain: 'actual'
               "Période":"2016.12"
               # "Libellé Entité": "{{ report.entityName }}"
               Exrecice: "A"
               Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
               Format: "3MUD000"
               Compte: "3TR160"
               Flux: "Y99"
               Secteur: "Tous secteurs"
              #  View: "MONTH"
           ,
             $addFields:
               "Libellé": $literal: "ROC (taux courants)"
               value_divided: $literal: null
               pack: $literal: ""
               Filtre1: $literal: "Vs N-1"
               Filtre2: "€"
               variation: $divide: ["$Variation Valeur ROC vs N-1 courant", 1000]
           ]
           [
             $match:
               domain: 'actual'
               "Période":"2016.12"
               # "Libellé Entité": "{{ report.entityName }}"
               Exrecice: "A"
               Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
               Format: "3MUD000"
               Compte: "3TR180N"
               Flux: "Y99"
               Secteur: "Tous secteurs"
              #  View: "MONTH"
           ,
             $addFields:
               "Libellé": $literal: "ROCDA (taux courants)"
               value_divided: $literal: null
               pack: $literal: ""
               Filtre1: $literal: "Vs N-1"
               Filtre2: "€"
               variation: $divide: ["$Variation Valeur ROCDA Net Amort Log vs N-1 courant", 1000]
           ]
  # Taux constants N-1 % + var pts
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3R50000TX"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              value_divided: "$Montant"
              "Libellé": $literal: "CA"
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "%"
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR210TX"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Marge Co"
              value_divided: "$Montant"
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "%"
              variation: "$Variation taux de marge  %"
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR205TX"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Autres revenus"
              value_divided: "$Montant"
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "%"
              variation: "$Variation d'Autres Rev vs N-1%"
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR310TX"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Frais de personnel"
              value_divided: "$Montant"
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "%"
              variation: "$Variation FP vs N-1 %"
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR350TX"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Frais généraux"
              value_divided: "$Montant"
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "%"
              variation: "$Variation de FG  vs N-1%"
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR340TX"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Loyers"
              value_divided:  "$Montant"
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "%"
              variation: "$Variation loyers vs N-1%"
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR400TX"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "Dépréciations"
              value_divided: "$Montant"
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "%"
              variation: "$Variation d'Am&D vs N-1%"
          ]
          [
            $match:
              domain: 'actual'
              "Période":"2016.12"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR160TX"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "ROC"
              value_divided: "$Montant"
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "%"
              variation: "$Variation ROC vs N-1 %"
          ]
          [
            $match:
              domain: 'actual'
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Format: "3MUD000"
              Compte: "3TR180NTX"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # View: "MONTH"
          ,
            $addFields:
              "Libellé": $literal: "ROCDA"
              value_divided: "$Montant"
              pack: $literal: "Tx constants"
              Filtre1: $literal: "Vs N-1"
              Filtre2: "%"
              variation: "$Variation ROCDA Net Amort Log vs N-1 %"
          ]
  # Taux courants N-1 % var pts

           [
             $match:
               domain: 'actual'
               "Période":"2016.12"
               # "Libellé Entité": "{{ report.entityName }}"
               Exrecice: "A"
               Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
               Format: "3MUD000"
               Compte: "3TR160TX"
               Flux: "Y99"
               Secteur: "Tous secteurs"
              #  View: "MONTH"
           ,
             $addFields:
               "Libellé": $literal: "ROC (taux courants)"
               value_divided: $literal: null
               pack: $literal: ""
               Filtre1: $literal: "Vs N-1"
               Filtre2: "%"
               variation: "$Variation ROC vs N-1 % courant"
           ]
           [
             $match:
               domain: 'actual'
               "Période":"2016.12"
               # "Libellé Entité": "{{ report.entityName }}"
               Exrecice: "A"
               Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
               Format: "3MUD000"
               Compte: "3TR180NTX"
               Flux: "Y99"
               Secteur: "Tous secteurs"
              #  View: "MONTH"
           ,
             $addFields:
               "Libellé": $literal: "ROCDA (taux courants)"
               value_divided: $literal: null
               pack: $literal: ""
               Filtre1: $literal: "Vs N-1"
               Filtre2: "%"
               variation:"$Variation ROCDA Net Amort Log vs N-1 % courant"
           ]

  # Taux constants Obj €
          [
            $match:
              # domain:"forecast"
              "Période": $in: [ "2016.12",2016.12]
              $or: [
                {
                  'domain': 'actual'
                  Compte: "R50000"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3R5000H"
                  Flux: "Y99"
                  Secteur: "Tous secteurs"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"

                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "CA"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              # domain:"forecast"
              "Période": $in: [ "2016.12",2016.12]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "TR210"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR210VH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Marge Co"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              # domain:"forecast"
              "Période": $in: [ "2016.12",2016.12]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3TR205"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR205VH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Autres revenus"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              # domain:"forecast"
              "Période": $in: [ "2016.12",2016.12]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "TR310"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR310VH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Frais de personnel"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              # domain:"forecast"
              "Période": $in: [ "2016.12",2016.12]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3TR350"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR350VH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                "Libellé Entité": "$_id.entite"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Frais généraux"
              zone: "$_id.zone"
              View: "$_id.View"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              # domain:"forecast"
              "Période": $in: [ "2016.12",2016.12]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "TR340"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR340VH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Loyers"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              # domain:"forecast"
              "Période": $in: [ "2016.12",2016.12]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "TR400"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR400VH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Dépréciations"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              # domain:"forecast"
              "Période": $in: [ "2016.12",2016.12]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "TR160"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR160VH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "ROC"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              # domain:"forecast"
              "Période": $in: [ "2016.12",2016.12]
              Flux: "Y99"
              Secteur: "Tous secteurs"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "TR180N"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR180NVH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "ROCDA"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
  # Taux courants Obj €
          [
            $match:
              'domain': 'forecast'
              "Période": $in: [ "2016.12",2016.12]
              Compte: "3TR160VHCR"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              Format: "3MUD000"
              # View: "MONTH"

          ,
            $addFields:
              variation: "$Montant"
              "Libellé": $literal: "ROC (taux courants)"
              pack: $literal: ""
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"

          ]
          [
            $match:
              'domain': 'forecast'
              "Période": $in: [ "2016.12",2016.12]
              Compte: "3TR180NVHCR"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              Format: "3MUD000"
              # View: "MONTH"

          ,
            $addFields:
              variation: "$Montant"
              "Libellé": $literal: "ROCDA (taux courants)"
              pack: $literal: ""
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"

          ]
  # Taux constants Obj % var pts

          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3TR210TX"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR210TXVH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: "$Montant"
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Marge Co"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "%"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3TR205TX"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR205TXVH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: "$Montant"
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Autres revenus"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "%"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3TR310TX"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR310TXVH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: "$Montant"
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Frais de personnel"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "%"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3TR350TX"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR350TXVH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: "$Montant"
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Frais généraux"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "%"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3TR340TX"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR340TXVH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: "$Montant"
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Loyers"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "%"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3TR400TX"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR400TXVH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: "$Montant"
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "Dépréciations"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "€"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3TR160TX"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR160TXVH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: "$Montant"
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "ROC"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "%"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3TR180NTX"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "A"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
                {
                  'domain': 'forecast'
                  Compte: "3TR180TXVH"
                  # "Libellé Entité": "{{ report.entityName }}"
                  Exrecice: "FORECAST"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                  Format: "3MUD000"
                  # View: "MONTH"
                }
              ]
          ,
            $addFields:
              montant2: "$Montant"
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                View: "$View"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Libellé"
              value_kpi: $push: "$montant2"

          ,
            $project:
              "Libellé": $literal: "ROCDA"
              zone: "$_id.zone"
              View: "$_id.View"
              "Libellé Entité": "$_id.entite"

              # value: 1
              "Période": "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "%"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value_divided:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
  # Taux courants Obj % var pts
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              'domain': 'forecast'
              Compte: "3TR160TXVHCR"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              Format: "3MUD000"
              # View: "MONTH"

          ,
            $addFields:
              variation: "$Montant"
              "Libellé": $literal: "ROC (taux courants)"
              pack: $literal: ""
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "%"

          ]
          [
            $match:
              'domain': 'forecast'
              "Période": $in: [ "2016.12",2016.12]
              Compte: "3TR180NTXVHCR"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              Format: "3MUD000"
              # View: "MONTH"

          ,
            $addFields:
              variation: "$Montant"
              "Libellé": $literal: "ROCDA (taux courants)"
              pack: $literal: ""
              Filtre1: $literal: "Vs Obj"
              Filtre2: $literal: "%"

          ]
        ]
        multiple_queries: true

        precision:
          value_divided:[
            precision: ",.1f"
            where: Filtre2: "%"
          ,
            precision: ",.0f"
            where: Filtre2: "€"
            ]
          variation:[
            precision: ",.1f"
            where: Filtre2: "%"
          ,
            precision: ",.0f"
            where: Filtre2: "€"
            ]

      units:
        value_divided:[
          unit: "%"
          where: Filtre2: "%"
        ,
          unit: " M€"
          where: Filtre2: "€"
          ]
        variation:[
          unit: " pts"
          where: Filtre2: "%"
        ,
          unit: " M€"
          where: Filtre2: "€"
          ]
    # highlightedKpis: [
    #   name: " de variation du ROC"
    #   value: "value"
    #   unit: "%"
    #   badge: 'value'
    #   comment: "vs N-1"
    #   sentiment:
    #     value:
    #       domain: [0]
    #       range: ['negative','positive']
    #   precision:
    #     value: '+,.2f'
    #     variation: '+,.2f'
    #   data:
    #     value:
    #       query:
    #         domain: 'funnel'
    #         label: "Marge Commerciale"
    #       field: 'variation'
    # ]

  }

  {
    level: 3
    parent_id: 50
    id: 50003
    title: "Passage ROC"
    commentary: "Evolution ROC par pays M€"
    restrictVisibility:
      reportEntry: "entityGroup"
      allowedReports: [
        "Groupe"
      ]
    filters:
      "bottom-right":
        on: "Consolidation"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query: [
          [
            $match:
              domain: "7C_Bridge_ROC"
              Indicateurs: $regex: '^ROC.*'
          ,
            $addFields:
              Pays: $literal: "ROC N-1"
              Zone: $literal: "ROC N-1"
              value_divided: $divide: ["$Montant", 1000]
          ,
            $sort:
              Phase: -1
          ,
            $limit: 2
          ]
          [
            $match:
              domain: "7C_Bridge_ROC"
              Niveau: $in: ["parent", "child"]
              Indicateurs: $regex: '^Non-Recurring.*'
          ,
            $addFields:
              Pays: "$Indicateurs"
              Zone: "$Indicateurs"
              value_divided: $divide: ["$Montant", 1000]
          ,
            $sort:
              Indicateurs: 1
          ,
            $limit: 2
          ]

          [
            $match:
              domain: "7C_Bridge_ROC"
              Niveau: $in: ["parent", "child"]
              Indicateurs: "Variation ROC"
          ,
            $addFields:
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "7C_Bridge_ROC"
              Niveau: $in: ["parent", "child"]
              Indicateurs: $regex: '^Non-Recurring.*'
          ,
            $addFields:
              Pays: "$Indicateurs"
              Zone: "$Indicateurs"
              value_divided: $divide: ["$Montant", 1000]
          ,
            $sort:
              Indicateurs: -1
          ,
            $limit: 2
          ]
          [
            $match:
              domain: "7C_Bridge_ROC"
              Niveau: $in: ["parent", "child"]
              Indicateurs: "X-rates effect"
          ,
            $addFields:
              Pays: "$Indicateurs"
              Zone: "$Indicateurs"
              value_divided: $divide: ["$Montant", 1000]
          ]

          [
            $match:
              domain: "7C_Bridge_ROC"
              Indicateurs: $regex: '^ROC.*'
          ,
            $addFields:
              Pays: $literal: "ROC N"
              Zone: $literal: "ROC N"
              value_divided: $divide: ["$Montant", 1000]
          ,
            $sort:
              Phase: 1
          ,
            $limit: 2
          ]
        ]
        multiple_queries: true
        precision:
          evolution: ",.0f"
          value_divided: ",.0f"
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      value: "value_divided"
      label: "Pays"
      groups: "Zone"
      type: "Niveau"
      steps: [
        {
          label: "Non-Recurring 2016", step: "Comp. ROC YTD N-1"}
        {
          label: "Holding",step: "Comp. ROC YTD N"}]
      variation: ""
      units:
        evolution: " %"
        value_divided: " M€"
      style: "waterfall-no-evol-highlight"
  }
  {
    title: 'Dynamique Dette Nette'
    level: 3
    parent_id: 60
    id: 60001
    commentary: "Evolution Dette Nette fin de mois"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        defaultSelected: "vs N-1"
        order:
          custom:[
            "vs N-1"
            "vs Obj"
          ]

    chartOptions:
      chartType: 'linechart'
      filters:
        "upper-right":
          on: "Libellé Entité"
          type: "dropdown"
          defaultSelected: "Groupe"
          order:
            custom: [
              "Groupe"
              "France"
              "Espagne"
              "Italie"
              "Belgique"
              "Pologne"
              "Roumanie"
              "Chine"
              "Taiwan"
              "Brésil"
              "Argentine"
            ]

      data:
        query:[
          [
            $match:
              domain:"actual"
              Compte: "3SCF7010ADP"
              Format: "Tous Formats"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Exrecice: "A"
              Flux: "Y99"
              Secteur: "Tous secteurs"

          ,
            $addFields:
              Filtre1: "vs N-1"
              serie: "$Libellé"
              value_divided: $divide: ["$Montant", 1000]
              "Evo": $divide: ["$Evo Dette nette vs histo", 1000]
          ]
          [
            $match:
              domain:"actual"
              Compte: "3SCF7010ADPH"
              Format: "Tous Formats"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Exrecice: "A"
              Flux: "Y99"
              Secteur: "Tous secteurs"

          ,
            $addFields:
              Filtre1: "vs N-1"
              serie: "$Libellé"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain:"forecast"
              Compte: "3SCF7010ADP"
              Format: "Tous Formats"
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              Exrecice: "FORECAST"
              Flux: "Y99"
              Secteur: "Tous secteurs"

          ,
            $addFields:
              Filtre1: "vs Obj"
              serie: $concat: ["$Libellé", "A"]
              value_divided: $divide: ["$Montant", 1000]
              "Evo": $divide: ["$Evo Dette nette vs Forecast", 1000]
          ]
          [
            $match:
              domain:"forecast"
              Format: "Tous Formats"
              Compte:  "3SCF7010ADPH"
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              Exrecice: "FORECAST"
              Flux: "Y99"
              Secteur: "Tous secteurs"

          ,
            $addFields:
              Filtre1: "vs Obj"
              serie: $concat: ["$Libellé", "A"]
              value_divided: $divide: ["$Montant", 1000]
          ]
        ]
        multiple_queries: true
        postprocess:[
          rename:
            values:
              # "Dette nette N-1":
              #   fr: "Dette nette N-1 MONTH"
              #   en: "Dette nette N-1 MONTH"
              "Dette nette":
                fr: "Dette nette"
                en: "Dette nette"
              "Dette netteA":
                fr: "Dette nette Obj"
                en: "Dette nette Obj"
              "Dette nette N-1A":
                fr: "Dette Nette Obj"
                en: "Dette Nette Obj"
              "Dette nette cloture A":
                fr: "Dette nette N"
                en: "Dette nette N"
              "Dette nette cloture ":
                fr: "Dette nette N"
                en: "Dette nette N"
            # columns:
            #   "Evo Dette nette vs Forecast":
            #     fr: "Var. dette nette"
            #     en: "Var. dette nette"
            #   "Evo Dette nette vs histo":
            #     fr: "Var. dette nette"
            #     en: "Var dette nette"

        ]
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          value: ",.1f"
          evo: "+,.0f"
        order:
          by: "serie"
          custom: [
            "Dette nette cloture"
            "Dette nette Obj"
            "Dette nette N-1"
            ]

      value:"value_divided"
      date:"Période"
      groups: "serie"
      legend: true
      yLegend: "M€"
      smoothLine: true
      style: "no-meta-empty"
      units:
        "value_divided": " M€"
        "Evo": " M€"
      dateFormat: "%B %Y"
      metaSerie: ["Evo"]
  }
  {
    level:3
    parent_id:60
    id:60002
    title: "Passage Free Cash Flow"
    commentary: "Passage Free Cash Flow YTD"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        order: custom: [
          "Vs N-1"
          "Vs Obj"
        ]
        defaultSelected: "Vs N-1"

    chartOptions:
      data:
        query:[
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: "3AND-FCF-BH"
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              # Origine: $in: ["30A-IFRS", "30F-COUNTRY1"]
          ,
            $addFields:
              label: "$Libellé"
              group: "$Libellé"
              type: $literal: "-1"
              Filtre1: "Vs N-1"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: $in: ["3SCF1000ADPV", "3SCF1100ADP"]
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
          ,
            $addFields:
              label: "$Libellé"
              group: $literal: "Autofi"
              type: $literal: "child"
              Filtre1: "Vs N-1"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: $in: ["3SCF1300VH", "3SCF3006ADPV", "3SCF3058ADPV"]
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
          ,
            $addFields:
              label: "$Libellé"
              group: $literal: "TM"
              type: $literal: "child"
              Filtre1: "Vs N-1"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: $in: ["3AN1-SCF3VH", "3AN1-SCF4VH", "3AN1-SCF2VH"]
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
          ,
            $addFields:
              label: "$Libellé"
              group: "$Libellé"
              type: $literal: "parent"
              Filtre1: "Vs N-1"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: "3AND-FCF-B"
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
          ,
            $addFields:
              label: $literal: "FCF N"
              group: $literal: "FCF N"
              type: $literal: "-1"
              Filtre1: "Vs N-1"
              value_divided: $divide: ["$Montant", 1000]
          ]

          [
            $match:
              domain: "forecast"
              "Période": "2016.12"
              Compte: "3AND-FCF-B"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
              Format: "Tous Formats"
          ,
            $addFields:
              label: $literal: "FCF Obj"
              group: $literal: "FCF Obj"
              type: $literal: "-1"
              Filtre1: "Vs Obj"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "forecast"
              "Période": $in: [ "2016.12",2016.12]
              Compte: $in: ["3AN1-SCF1VF", "3SCF1000ADPF"]
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
          ,
            $addFields:
              label: "$Libellé"
              group: $literal: "Autofi"
              type: $literal: "child"
              Filtre1: "Vs Obj"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "forecast"
              "Période": $in: [ "2016.12",2016.12]
              Compte: $in: ["3SCF3058ADPF", "3SCF3006ADPF","3SCF1300VF"]
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
          ,
            $addFields:
              label: "$Libellé"
              group: $literal: "TM"
              type: $literal: "child"
              Filtre1: "Vs Obj"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "forecast"
              "Période": $in: [ "2016.12",2016.12]
              Compte: $in: ["3AN1-SCF3VF", "3AN1-SCF4VF", "3AN1-SCF2VF"]
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
          ,
            $addFields:
              label: "$Libellé"
              group: "$Libellé"
              type: $literal: "parent"
              Filtre1: "Vs Obj"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: "3AND-FCF-B"
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
          ,
            $addFields:
              label: $literal: "FCF N"
              group: $literal: "FCF N"
              type: $literal: "-1"
              Filtre1: "Vs Obj"
              value_divided: $divide: ["$Montant", 1000]
          ]

        ]
        multiple_queries: true
        postprocess: [
        #   argmax: "Période"
        # ,
          rename:
            values:
              "Var Rocda vs N-1":
                fr: "Var. ROCDA"
                en: "Var. ROCDA"
              "Var Rocda vs budget":
                fr: "Var. ROCDA"
                en: "Var. ROCDA"
              "Var Autre Autofi":
                fr: "Autres"
                en: "Autres"
              "Var Autofi vs budget":
                fr: "Autres"
                en: "Autres"
              "Var Dette vs N-1":
                fr: "Dette fournisseurs"
                en: "Dette fournisseurs"
              "Var créances vs N-1":
                fr: "Créances"
                en: "Créances"
              "Var créances vs budget":
                fr: "Créances"
                en: "Créances"
              "Var Stock vs N-1":
                fr: "Stocks"
                en: "Stocks"
              "Var Stock vs budget":
                fr: "Stocks"
                en: "Stocks"
              "Var Autre BFR vs  N-1":
                fr: "Autres El. BFR"
                en: "Autres El. BFR"
              "Var Autre BFR vs  budget":
                fr: "Autres El. BFR"
                en: "Autres El. BFR"
              "Var capex vs N-1":
                fr: "Capex"
                en: "Capex"
              "Var capex vs budget":
                fr: "Capex"
                en: "Capex"
              "Var Autre vs N-1":
                fr: "Autres"
                en: "Autres"
              "Var Autre vs budget":
                fr: "Autres"
                en: "Autres"
        ]
        order:
          by: "group"
          custom: [
            "FCF N-1"
            "FCF Obj"
            "Autofi"
            "TM"
            "Autres El. BFR"
            "Capex"
            "Autres"
            "FCF N"
          ]

        precision:
          "evolution":',.1f'
          "value":',.1f'
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      filters:
        "upper-right":
          on: "Libellé Entité"
          type: "dropdown"
          defaultSelected: "Groupe"
          order:
            custom:["Groupe", "France", "Espagne", "Italie", "Belgique", "Pologne", "Roumanie", "Chine", "Taiwan", "Brésil", "Argentine"]

      value:"value_divided"
      label:"label"
      groups: "group"
      # type: "type"
      # variation: "evolution"
      style: "waterfall-no-evol-highlight"
      units:
        "evolution":' %'
        "value_divided":' M€'

  }
  {
    title: 'Dynamique Dette Nette'
    level: 3
    parent_id: 60
    id: 60101
    commentary: "Evolution Dette Nette fin de mois"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        defaultSelected: "vs N-1"
        order:
          custom:[
            "vs N-1"
            "vs Obj"
          ]

    chartOptions:
      chartType: 'linechart'
      data:
        query:[
          [
            $match:
              domain:"actual"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3SCF7010ADP", "3SCF7010ADPH"]
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Exrecice: "A"

          ,
            $addFields:
              Filtre1: "vs N-1"
              serie: "$Libellé"
              value_divided: $divide: ["$Montant", 1000]
              "Evo": $divide: ["$Evo Dette nette vs histo", 1000]
          ]
          [
            $match:
              domain:"forecast"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3SCF7010ADP", "3SCF7010ADPH"]
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              Exrecice: "FORECAST"

          ,
            $addFields:
              Filtre1: "vs Obj"
              serie: $concat: ["$Libellé", "A"]
              value_divided: $divide: ["$Montant", 1000]
              "Evo": $divide: ["$Evo Dette nette vs Forecast", 1000]
          ]
        ]
        multiple_queries: true
        postprocess:[
          rename:
            values:
              # "Dette nette N-1":
              #   fr: "Dette nette N-1 MONTH"
              #   en: "Dette nette N-1 MONTH"
              "Dette nette":
                fr: "Dette nette"
                en: "Dette nette"
              "Dette netteA":
                fr: "Dette nette Obj"
                en: "Dette nette Obj"
              "Dette nette N-1A":
                fr: "Dette Nette Obj"
                en: "Dette Nette Obj"
              "Dette nette cloture A":
                fr: "Dette nette N"
                en: "Dette nette N"
              "Dette nette cloture ":
                fr: "Dette nette N"
                en: "Dette nette N"
              "All formats":
                fr: "Tous formats"
                en: "Tous formats"
        ]
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          value: ",.1f"
        order:
          by: "serie"
          custom: [
            "Dette nette cloture"
            "Dette nette Obj"
            "Dette nette N-1"
            ]

      value:"value_divided"
      date:"Période"
      groups: "serie"
      legend: true
      smoothLine: true
      units:
        "value_divided": " M€"
        "Evo": " M€"
      dateFormat: "%B %Y"
      metaSerie: ["Evo"]
      style: "no-meta-empty"

  }
  {
    level:3
    parent_id:60
    id:60102
    title: "Passage Free Cash Flow"
    commentary: "Passage Free Cash Flow YTD"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        order: custom: [
          "Vs N-1"
          "Vs Obj"
        ]
        defaultSelected: "Vs N-1"

    chartOptions:
      data:
        query:[
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: "3AND-FCF-BH"
              Secteur: "Tous secteurs"
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              # Origine: $in: ["30A-IFRS", "30F-COUNTRY1"]
          ,
            $addFields:
              label: "$Libellé"
              group: "$Libellé"
              type: $literal: "-1"
              Filtre1: "Vs N-1"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: $in: ["3SCF1000ADPV", "3SCF1100ADP"]
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Secteur: "Tous secteurs"
          ,
            $addFields:
              label: "$Libellé"
              group: $literal: "Autofi"
              type: $literal: "child"
              Filtre1: "Vs N-1"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: $in: ["3SCF1300VH", "3SCF3006ADPV", "3SCF3058ADPV"]
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Secteur: "Tous secteurs"
          ,
            $addFields:
              label: "$Libellé"
              group: $literal: "TM"
              type: $literal: "child"
              Filtre1: "Vs N-1"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: $in: ["3AN1-SCF3VH", "3AN1-SCF4VH", "3AN1-SCF2VH"]
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Secteur: "Tous secteurs"
          ,
            $addFields:
              label: "$Libellé"
              group: "$Libellé"
              type: $literal: "parent"
              Filtre1: "Vs N-1"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: "3AND-FCF-B"
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Secteur: "Tous secteurs"
          ,
            $addFields:
              label: $literal: "FCF N"
              group: $literal: "FCF N"
              type: $literal: "-1"
              Filtre1: "Vs N-1"
              value_divided: $divide: ["$Montant", 1000]
          ]




          [
            $match:
              domain: "forecast"
              "Période":"2016.12"
              Compte: "3AND-FCF-B"
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
              Secteur: "Tous secteurs"
          ,
            $addFields:
              label: $literal: "FCF Obj"
              group: $literal: "FCF Obj"
              type: $literal: "-1"
              Filtre1: "Vs Obj"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "forecast"
              "Période":"2016.12"
              Compte: $in: ["3AN1-SCF1VF", "3SCF1000ADPF"]
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
              Secteur: "Tous secteurs"
          ,
            $addFields:
              label: "$Libellé"
              group: $literal: "Autofi"
              type: $literal: "child"
              Filtre1: "Vs Obj"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "forecast"
              "Période":"2016.12"
              Compte: $in: ["3SCF3058ADPF", "3SCF3006ADPF","3SCF1300VF"]
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
              Secteur: "Tous secteurs"
          ,
            $addFields:
              label: "$Libellé"
              group: $literal: "TM"
              type: $literal: "child"
              Filtre1: "Vs Obj"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "forecast"
              "Période":"2016.12"
              Compte: $in: ["3AN1-SCF3VF", "3AN1-SCF4VF", "3AN1-SCF2VF"]
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "FORECAST"
              Secteur: "Tous secteurs"
          ,
            $addFields:
              label: "$Libellé"
              group: "$Libellé"
              type: $literal: "parent"
              Filtre1: "Vs Obj"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: "3AND-FCF-B"
              "Libellé Entité": "{{ report.entityName }}"
              Exrecice: "A"
              Secteur: "Tous secteurs"
          ,
            $addFields:
              label: $literal: "FCF N"
              group: $literal: "FCF N"
              type: $literal: "-1"
              Filtre1: "Vs Obj"
              value_divided: $divide: ["$Montant", 1000]
          ]

        ]
        multiple_queries: true
        postprocess: [

          rename:
            values:
              "Var Rocda vs N-1":
                fr: "Var. ROCDA"
                en: "Var. ROCDA"
              "Var Rocda vs budget":
                fr: "Var. ROCDA"
                en: "Var. ROCDA"
              "Var Autre Autofi":
                fr: "Autres"
                en: "Autres"
              "Var Autofi vs budget":
                fr: "Autres"
                en: "Autres"
              "Var Dette vs N-1":
                fr: "Dette fournisseurs"
                en: "Dette fournisseurs"
              "Var créances vs N-1":
                fr: "Créances"
                en: "Créances"
              "Var créances vs budget":
                fr: "Créances"
                en: "Créances"
              "Var Stock vs N-1":
                fr: "Stocks"
                en: "Stocks"
              "Var Stock vs budget":
                fr: "Stocks"
                en: "Stocks"
              "Var Autre BFR vs  N-1":
                fr: "Autres El. BFR"
                en: "Autres El. BFR"
              "Var Autre BFR vs  budget":
                fr: "Autres El. BFR"
                en: "Autres El. BFR"
              "Var capex vs N-1":
                fr: "Capex"
                en: "Capex"
              "Var capex vs budget":
                fr: "Capex"
                en: "Capex"
              "Var Autre vs N-1":
                fr: "Autres"
                en: "Autres"
              "Var Autre vs budget":
                fr: "Autres"
                en: "Autres"
        ]
        order:
          by: "group"
          custom: [
            "FCF N-1"
            "FCF Obj"
            "Autofi"
            "TM"
            "Autres El. BFR"
            "Capex"
            "Autres"
            "FCF N"
          ]

        precision:
          "evolution":',.1f'
          "value":',.1f'
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      # filters:
      #   "upper-right":
      #     on: "pays"
      #     type: "dropdown"
      #     defaultSelected: "Toucan Groupe"

      value:"value_divided"
      hideParenthesisEvolution: true
      label:"label"
      groups: "group"
      # type: "type"
      # variation: "evolution"
      style: "waterfall-no-evol-highlight"
      units:
        "evolution":' %'
        "value_divided":' M€'

  }
  {
    title:"Evolution TM"
    level:3
    id:60003
    parent_id:60
    commentary: "Evolution TM en nombre de jours"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        order:
          custom: [
            "Vs N-1"
            "Vs Obj"
          ]
    chartOptions:
      data:
        query:[
          [
            $match:
              domain:"actual"
              "Période":"2016.12"
              Compte: $in: ["3TMJVH", "3CRJVH", "3DFJVH", "3STJVH"]
              Exrecice: "A"
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"

          ,
            $addFields:
              Filtre1: $literal: "Vs N-1"
          ]
          [
            $match:
              domain:"forecast"
              "Période": "2016.12"
              Compte: $in: ["3TMJVH", "3CRJVH", "3DFJVH", "3STJVH"]
              Exrecice: "FORECAST"
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"

          ,
            $addFields:
              Filtre1: $literal: "Vs Obj"
          ]

        ]
        multiple_queries: true
        postprocess:[
          rename:
            values:
              "Evo TM en jours N-1":
                fr: "Trésorerie Marchandise"
                en: "Trésorerie Marchandise"
              "Evo Créances en jours N-1":
                fr: "Créances"
                en: "Créances"
              "Evo Dette Fourni en jours N-1":
                fr: "Dette fournisseurs"
                en: "Dette fournisseurs"
              "Evo Stock en jours N-1":
                fr: "Stock"
                en: "Stock"
        ]
        order:
          by: "Libellé Entité"
          custom:["Groupe", "France", "Espagne", "Italie", "Belgique", "Pologne", "Roumanie", "Chine", "Taiwan", "Brésil", "Argentine"]
        precision:
          "Montant": ",.1f"

      chartType: "leaderboardCenteredAverage"
      filters:
        "upper-middle":
          on: "Libellé"
          type: "dropdown"
          defaultSelected: "Trésorerie Marchandise"
      value:'Montant'
      label:'Libellé Entité'
      reverse: false
      average:0
      # variation: "BFR"
      # variationLegend: "Variation BFR"
      hideAverageBox: true
      units:
        Montant: " jour(s)"

  }
  {
    title: "Capex par pays"
    level: 3
    parent_id: 60
    id:60004
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"

    chartOptions:
      data:
        query: [
          [
            $match:
              domain:"actual"
              "Période":"2016.12"
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Compte: $in: ["3CAPVH","3CAP"]
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
              "Compte": $concat: ["$Compte", "$Exrecice"]
          ,
            $sort:
              "Compte": 1
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: "$_id.entite"
              zone: "$_id.zone"
              # value: 1
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs N-1"
              # Variation: "$_id.order"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              parent: ""
              id:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                ]
          ]
          [
            $match:
              domain:"actual"
              Format: "3MUD000"
              "Période":"2016.12"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Compte: $in: ["3CAP-EXP", "3CAP-EXPVH"]
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
              "Compte": $concat: ["$Compte", "$Exrecice"]
          ,
            $sort:
              "Compte": 1
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Expansion"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs N-1"
              parent:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              domain:"actual"
              "Période":"2016.12"
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Compte: $in: ["3CAP-REM", "3CAP-REMVH"]
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
              "Compte": $concat: ["$Compte", "$Exrecice"]
          ,
            $sort:
              "Compte": 1
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Remodeling & On-going"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs N-1"
              parent:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              domain:"actual"
              "Période":"2016.12"
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Compte: $in: ["3CAP-AUT", "3CAP-AUTVH"]
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
              "Compte": $concat: ["$Compte", "$Exrecice"]
          ,
            $sort:
              "Compte": 1
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Autres"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs N-1"
              parent:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]

          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3CAP"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                }
                {
                  'domain': 'forecast'
                  Compte: "3CAPVF"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
              "Compte": $concat: ["$Compte", "$Exrecice"]
          ,
            $sort:
              "Compte": 1
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: "$_id.entite"
              zone: "$_id.zone"

              # value: 1
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              # Variation: "$_id.order"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              parent: ""
              id:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3CAP-EXP"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                }
                {
                  'domain': 'forecast'
                  Compte: "3CAP-EXPVF"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
              "Compte": $concat: ["$Compte", "$Exrecice"]
          ,
            $sort:
              "Compte": 1
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Expansion"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              parent:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3CAP-REM"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                }
                {
                  'domain': 'forecast'
                  Compte: "3CAP-REMVF"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
              "Compte": $concat: ["$Compte", "$Exrecice"]
          ,
            $sort:
              "Compte": 1
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Remodeling & On-going"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              parent:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              Format: "3MUD000"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # domain:"forecast"
              $or: [
                {
                  'domain': 'actual'
                  Compte: "3CAP-AUT"
                  Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
                }
                {
                  'domain': 'forecast'
                  Compte: "3CAP-AUTVF"
                  Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
                }
              ]
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
              "Compte": $concat: ["$Compte", "$Exrecice"]
          ,
            $sort:
              "Compte": 1
          ,
            $group:
              _id:
                periode: "$Période"
                entite: "$Libellé Entité"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Autres"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              parent:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.entite"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
          ]

        ]
        multiple_queries: true

        precision:
          value: ",.0f"
          variation: ",.0f"
        order:
          by: "label"
          custom:["Groupe", "France", "Espagne", "Italie", "Belgique", "Pologne", "Roumanie", "Chine", "Taiwan", "Brésil", "Argentine", "Expansion", "Remodeling & On-going", "Autres"]
      chartType:'horizontal-barchart'
      value: "value"
      variation: "variation"
      variationLegend: "Evo. tx constants"
      # domain: [0, 100]
      label:"label"

      # packs: "pays"
      # packNames: true
      'children':
            'root': ''
            'id': 'id'
            'parent': 'parent'
      units:
        value: " M€"
        variation: " M€"
      legend: true
      reverse: true
      style: "no-value-legend"

  }

  {
    level:3
    parent_id:60
    id:60005
    title: "Passage Dette Nette"
    # commentary: "Passage Dette Nette en M€"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]

    chartOptions:
      data:
        query:[
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Compte: "3SCF7005ADP"
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Origine": "30A-IFRS"
              # "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              order: $literal: 1
              niveau: $literal: -1
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "Tous Formats"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Compte: $in: ["3SCF5045ADP", "3SCF1200ADP", "3AND-FCF-B", "3AN1-SCF6", "3AN1-SCF5"]
              # "Origine": "30A-IFRS"
              # "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              order: $literal: 2
              niveau: $literal: "parent"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "Tous Formats"
              Compte: "3SCF7010ADP"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Origine": "30A-IFRS"
              # "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              order: $literal: 3
              niveau: $literal: -1
              value_divided: $divide: ["$Montant", 1000]
          ]

        ]
        multiple_queries: true
        postprocess:[
        #   argmax: "Période"
        # ,
          rename:
            values:
              "Cout de la dette":
                fr: "Coût de la dette"
                en: "Coût de la dette"
              "Autre Dette":
                fr: "Autres"
                en: "Autres"
        ]
        order:
          by: "Compte"
          custom: [
            "3SCF7005ADP"
            "3AND-FCF-B"
            "3AN1-SCF5"
            "3AN1-SCF6"
            "3SCF5045ADP"
            "3SCF1200ADP"
            "3SCF7010ADP"
          ]

        precision:
          "evolution":',.1f'
          "value":',.1f'
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      filters:
        "upper-middle":
          on: "Libellé Entité"
          type: "dropdown"
          defaultSelected: "Groupe"
          order:
            custom:["Groupe", "France", "Espagne", "Italie", "Belgique", "Pologne", "Roumanie", "Chine", "Taiwan", "Brésil", "Argentine"]
      value:"value_divided"
      label:"Libellé"
      groups: "Libellé"
      hideParenthesisEvolution: true
      # type: "niveau"
      # variation: "evolution"
      style: "waterfall-no-evol-highlight"
      units:
        "evolution":' %'
        "value_divided":' M€'

  }
  {
    level: 3
    title: "Tendance Pays"
    parent_id: 60
    id: 60006
    commentary: "Dette Nette Moyenne par pays"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Groupe'
      ]
    filters:
      "bottom-right":
        on: "consolidation"
        type: "buttons"
        defaultSelected: "YTD"
        # datasets: [0]
    chartOptions:
      # {
      #
      #   chartType: "barchart"
      #   # groups: "cat"
      #   value: "N-1"
      #   label: "pays"
      #   labelsOrder: [
      #     "France"
      #     "Allemagne"
      #     "Espagne"
      #   ]
      #   sort: 'asc'
      #   variation: "evolution"
      #   variationLegend: "Ecart N-1"
      #
      #   data:
      #     query:[
      #       [
      #         $match:
      #           domain: "bullet-chart"
      #           pays: $ne: "Toucan Groupe"
      #           consolidation: "MTD"
      #       ,
      #         $addFields:
      #           consolidation: $literal: "MTD"
      #       ,
      #         $sort: {"N-1": -1}
      #
      #       ]
      #       [
      #         $match:
      #           domain: "bullet-chart"
      #           pays: $ne: "Toucan Groupe"
      #           consolidation: "YTD"
      #       ,
      #         $addFields:
      #           consolidation: $literal: "YTD"
      #           'N-1': $divide: ["$N-1", 10]
      #       ,
      #         $sort: {"N-1": -1}
      #
      #       ]
      #     ]
      #     multiple_queries: true
      #     precision:
      #       'N-1': ",.1f"
      #       'evolution': ",.1f"
      #   units:
      #     'N-1': "M€"
      #     evolution: "pts"
      #   crossfilter:
      #     on: 'pays'
      #     datasets: [1]
      #   id: 0
      #   size: 0.5
      #
      # }

      chartType: 'linechart'
      filters:
        "upper-right":
          on: "pays"
          type: "dropdown"
      data:
        query:
          domain:"sparklines"
          group: "Variation vs N-1"
        date:
          'format': "%Y.%m"
          'selector': "period"
        precision:
          value: ",.2f"

      value:"value"
      date:"period"
      # groups: "serie"
      legend: true
      smoothLine: true
      # showValues: true
      units: "value": " M€"
      # id: 1
      # size: 0.5


  }


  # ECRANS PAYS -->
  {
    title: 'Dynamique CA'
    level: 3
    parent_id: 101
    id: 10101
    # commentary: "Variation du CA LTM %"

    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    chartOptions:
      chartType: 'linechart'
      filters:
        "upper-right":
          on: "Libellé Format"
          type: "dropdown"
          defaultSelected: "Tous formats"
          order:
            custom:[
              "Tous formats"
              "Hyper"
              "Hyper int."
              "Hyper Fr."
              "Super"
              "Super Int."
              "Super Fr."
              "Proxi"
              "Proxi Int."
              "Proxi Fr."
              "C&C"

            ]

      data:
        query:[
          [
            $match:
              domain:"SA"
              Compte: "3XR55LFLTX"
              "Code Entité": $nin: ["3RUD2100", "3RUDASIAADP", "3RUDEURADP", "3RUDAMLAADP"]
              "Secteur": "3SECD004"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in: [
                "3MUD006"
                "3MUD1000"
                "3MUD1010"
                "3MUD1020"
                "3MUD1100"
                "3MUD1110"
                "3MUD1120"
                "3MUD1200"
                "3MUD1210"
                "3MUD1220"
                "3MUD1300"
                ]
              View: "MONTH"
              Origine: "30SA-CALC"
          ,
            $addFields:
              serie: $literal: "CA LFL Month"
              value: $divide: ["$Montant", 100]
              "Evo YTD": "$Evo LFL net (hors TWRK & Cal) groupe vs histo % YTD"
          ]
          [
            $match:
              domain:"SA"
              Compte: "3XR55TXEH1"
              "Code Entité": $nin: ["3RUDASIAADP", "3RUDEURADP", "3RUDAMLAADP", "3RUDFRA09"]
              "Secteur": "3SECD004"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in: [
                "3MUD006"
                "3MUD1000"
                "3MUD1010"
                "3MUD1020"
                "3MUD1100"
                "3MUD1110"
                "3MUD1120"
                "3MUD1200"
                "3MUD1210"
                "3MUD1220"
                "3MUD1300"
                ]
              View: "MONTH"
              Origine: "30SA-CALC"
          ,
            $addFields:
              serie: $literal: "CA Total Month"
              value: $divide: ["$Montant", 100]
              "Evo YTD": "$Evo CA TOT vs histo % cstt YTD"
          ]
        ]
        multiple_queries: true
        postprocess:[
          rename:
            values:
              "Petrol excluded":
                en: "Tous formats"
                fr: "Tous formats"
        ]
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          value: ".1%"
          "Evo YTD": ".1f"

      value:"value"
      metaSerie: ["Evo YTD"]
      date:"Période"
      groups: "serie"
      legend: true
      smoothLine: true
      units:
        "value": ""
        "Evo YTD": "%"

  }
  {
    level: 3
    title: "Tendance LFL Formats"
    parent_id: 101
    id: 10102
    # commentary: "Variation du CA LFL par formats"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:
          domain:"SA"
          "Période":"2016.12"
          "Libellé Entité": "{{ report.entityName }}"
          Compte: $in: ["3XR55LFLTX","3XR55LFLTXVH"]
          "Code Entité": $nin: ["3RUDASIAADP", "3RUDEURADP", "3RUDAMLAADP"]
          "Secteur": "3SECD004"
          "Libellé Format": $in: ["Petrol excluded","Hyper", "Super", "Proxi", "Autres", "C&C"]
          Origine: "30SA-CALC"
        postprocess:[
          fillna:
            column: 'View'
            value: "YTD"
        ,
          pivot:
            index: ['Libellé Format',"Période", 'View']
            column: 'Libellé'
            value: 'Montant'
        ,
          rename:
            values:
              "Petrol excluded":
                en: "{{ report.entityName }}"
                fr: "{{ report.entityName }}"
        ]
        order:
          by: "Libellé Format"
          defaultSelected: "{{ report.entityName }}"
          custom: [
            "{{ report.entityName }}"
            "Hyper"
            "Super"
            "Proxi"
            "C&C"
            "Autres"
          ]

        precision:
          'Evo LFL net (hors TWRK & Cal) groupe vs histo %': ",.1f"
          'Var. LFL vs n-1': ",.1f"

      chartType: "leaderboardCenteredAverage"
      value: "Evo LFL net (hors TWRK & Cal) groupe vs histo %"
      label: "Libellé Format"

      variation: "Var. LFL vs n-1"
      variationLegend: "Ecart N-1"
      average: 0
      averageText: " "
      hideAverageBox: true

      units:
        'Evo LFL net (hors TWRK & Cal) groupe vs histo %': "%"
        "Var. LFL vs n-1": "pts"

      sparklines:
        orderDates: true
        value: "Evo LFL net (hors TWRK & Cal) groupe vs histo %"
        units: "Evo LFL net (hors TWRK & Cal) groupe vs histo %" : "%"
        legend: "Evo sur<br>12 mois"
        joins: [
          "Libellé Format"
        ]
        date: "Période"
        data:
          query:
            domain:"SA"
            "Libellé Entité": "{{ report.entityName }}"
            Compte: $in: ["3XR55LFLTX","3XR55LFLTXVH"]
            "Secteur": "3SECD004"
            "Libellé Format": $in: ["Petrol excluded","Hyper", "Super", "Proxi", "Autres","C&C"]
            Origine: "30SA-CALC"
            View: "MONTH"
          postprocess:[
            rename:
              values:
                "Petrol excluded":
                  en: "{{ report.entityName }}"
                  fr: "{{ report.entityName }}"
          ]
          precision:
            "Evo LFL net (hors TWRK & Cal) groupe vs histo %": '.1f'
  }
  {
    level: 3
    title: "Poids catégories & LFL"
    parent_id: 101
    id: 10113
    commentary: "Poids des catégories par pays et variation LFL"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"

    chartOptions:
      data:
        query: [
          [
            $match:
              domain:"SA"
              Compte: "3XR55PDS"
              Secteur: $in: ["3SECD100", "3SECD007"]
              Flux: "Y99"
              "Format": $in: ["3MUD006","3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              id:
                $concat: [
                  "$Libellé Secteur"
                  "_"
                  "$Libellé Format"
                ]
              parent: ""
          ]
          [
            $match:
              domain:"SA"
              Compte: "3XR55PDS"
              Secteur: $in: ["SECT1010", "SECT1020"]
              Flux: "Y99"
              "Format": $in: ["3MUD006","3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              parent:
                $concat: [
                  "Food_"
                  "$Libellé Format"
                ]
              id:
                $concat: [
                  "Food_"
                  "$Libellé Format"
                  "$Libellé Secteur"
                ]
              order:
                $cond:[
                  $eq: ["$Libellé Secteur", "Cons. Goods"]
                  1
                  $cond:[
                    $eq: ["$Libellé Secteur", "Fresh"]
                    2
                    3
                  ]
                ]
          ]
          [
            $match:
              domain:"SA"
              Compte: "3XR55PDS"
              Secteur: $in: ["SECT1110", "SECT1120", "SECT1130"]
              Flux: "Y99"
              "Format": $in: ["3MUD006","3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              parent:
                $concat: [
                  "Non Food_"
                  "$Libellé Format"
                ]
              id:
                $concat: [
                  "Non Food_"
                  "$Libellé Format"
                  "$Libellé Secteur"
                ]
              order:
                $cond:[
                  $eq: ["$Libellé Secteur", "Bazar"]
                  4
                  $cond:[
                    $eq: ["$Libellé Secteur", "Textile"]
                    5
                    $cond:[
                      $eq: ["$Libellé Secteur", "Appliance"]
                      6
                      7
                    ]
                  ]
                ]
          ]
        ]
        order:
          by: "order"
        postprocess:[
          rename:
            values:
              "Petrol excluded":
                en: "Tous Formats"
                fr: "Tous Formats"
              "Fresh":
                en: "PFT"
                fr: "PFT"
              "Cons. Goods":
                en: "PGC"
                fr: "PGC"
              "Appliance":
                en: "EPCS"
                fr: "EPCS"
              "Tous Formats":
                en: "{{ report.entityName }}"
                fr: "{{ report.entityName }}"
        ]
        multiple_queries: true
      chartType:'horizontal-barchart'
      value: "Montant"
      variation: "Evo LFL net (hors TWRK & Cal) groupe vs histo %"
      variationLegend: "Var. CA LFL%"
      domain: [0, 100]
      label:"Libellé Secteur"
      packs: "Libellé Format"
      # sort: 'desc'
      packNames: true
      'children':
            'root': ''
            'id': 'id'
            'parent': 'parent'
      units:
        Montant: "%"
        "Evo LFL net (hors TWRK & Cal) groupe vs histo %": "%"
      legend: true
      style: "no-value-legend no-arrow"
  }
  {
    level: 3
    title: "Poids Format"
    parent_id: 101
    id: 10104
    commentary: "Poids formats et évolution LFL %"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          $match:
            domain: "SA"
            "Période":"2016.12"
            Compte: $in: ["3XR55LFLTX", "3XR55PDF"]
            Secteur: "3SECD004"
            Format: $in: ["3MUD1000","3MUD1100", "3MUD1200","3MUD1300"]
            Exrecice: "SALES"
            Origine: "30SA-CALC"
            "Libellé Entité": "{{ report.entityName }}"
        ,
          $addFields:
            order:
              $switch:
                branches: [
                  case: $eq: ["$Libellé Format", "Hyper"]
                  then: 1
                ,
                  case: $eq: ["$Libellé Format", "Super"]
                  then: 2
                ,
                  case: $eq: ["$Libellé Format", "Proxi"]
                  then: 3
                ,
                  case: $eq: ["$Libellé Format", "C&C"]
                  then: 4
                ]
                default: 10
        ,
          $sort: order : 1
        ]
        precision:
          "Evo LFL net (hors TWRK & Cal) groupe vs histo %": '.1f'

        postprocess:[

          pivot:
            index: ['Libellé Entité','Libellé Format', 'View', "Période", "order"]
            column: 'Libellé'
            value: 'Montant'
        ]
        order:
          by: "order"
        #   custom: ["Groupe", "France", "Espagne", "Italie", "Belgique", "Pologne", "Roumanie", "Chine", "Taiwan", "Brésil", "Argentine"]
      chartType:'horizontal-barchart'
      value: "Poids Format"
      variation: "Evo LFL net (hors TWRK & Cal) groupe vs histo %"
      variationLegend: "Evo LFL%"
      label:"Libellé Format"
      packs: "Libellé Entité"
      # packsOrder: ["Groupe", "France", "Espagne", "Italie", "Belgique", "Pologne", "Roumanie", "Chine", "Taiwan", "Brésil", "Argentine"]
      packNames: true
      units:
        "Poids Format": "%"
        "Evo LFL net (hors TWRK & Cal) groupe vs histo %": "%"
      style: "no-arrow"
  }
  {
    level:3
    parent_id:101
    id:10107
    title: "Passage CA"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    requesters:
      "bottom-right":
        type: "buttons"
        id: 'period'
        values: [
          View: 'MONTH'
          # name: 'MONTH'
        ,
          View: 'YTD'
          # name: 'YTD'
        ]
        fields: ['View']
        completeObjectMode: true
    # filters:
    #   "bottom-right":
    #     on: "View"
    #     type: "buttons"
    #     defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [#point de départ CA N-1
            $match:
              domain: "SA"
              Compte: "3XR55H"
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              type: $subtract: [0, 1]
              label: $literal: "N-1"
              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: "$label"
              order: $sum: [0,0]
          ]
          [ #création group LFL
            $match:
              domain: "SA"
              Compte: $in:["3XR55LFLV","3XR55LFLTX"]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
          ,
            $project:
              type: $literal: "parent"
              label: $literal: 'LFL'
              value: $divide:["$value", 1000]
              group: $literal: 'LFL'
              variation: $divide:["$variation", 100]
              "Période": "$_id"
              order: $literal: 1
          ]
          [ #création labels formats
            $match:
              domain: "SA"
              Compte: $in:["3XR55LFLV","3XR55LFLTX"]
              Secteur: "3SECD004"
              Format: $in: ["3MUD014","3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300" ]
              Flux: "Y99"
              Exrecice: "SALES"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id:
                "Période": "$Période"
                "Libellé Format": "$Libellé Format"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
              label: $first: "$Libellé Format"
              "Code Entité": $first: "$Code Entité"
              Zone: $first: "$Zone"
          ,
            $project:
              type: $literal: "child"
              label: 1
              group: $literal: 'LFL'
              value: $divide:["$value", 1000]
              variation: $divide:["$variation", 100]
              "Période": "$_id.Période"
              order:
                $cond:[
                  $eq: ["$label", "Hyper"]
                  1
                  $cond:[
                    $eq: ["$label", "Super"]
                    2
                    $cond:[
                      $eq: ["$label", "Proxi"]
                      3
                      $cond:[
                        $eq: ["$label", "C&C"]
                        4
                        5
                      ]
                    ]
                  ]
                ]
          ]
          [ #effet calendaire
            $match:
              domain: "SA"
              $or: [
                Compte: "3XR55EFCTX"
                Origine: "30SA-CALC"
                Flux: "Y99"
              ,
                Compte: "XR55"
                Origine: "30SA-IFRS"
                Flux: "EFCAL"
              ]
              Secteur: "3SECD004"
              Format: "3MUD006"
              "Libellé Entité": "{{ report.entityName }}"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
          ,
            $project:
              type: $literal: "parent"
              label: $literal: "Eff Cal"
              value: $divide:["$value", 1000]
              group: $literal: "Eff Cal"
              order: $literal: 15
              variation: $divide:["$variation", 100]
              "Période": "$_id"
          ]
          [ #effets travaux
            $match:
              domain: "SA"
              Compte: $in: ["3XR55EFWRKTX","3XR55EFWRKTV"]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
              label: $first: "$Libellé"
          ,
            $project:
              type: $literal: "parent"
              label: 1
              value: $divide:["$value", 1000]
              group: "$label"
              order: $literal: 16
              variation: $divide:["$variation", 100]
              "Période": "$_id"
          ]
          [ #effet périmètre
            $match:
              domain: "SA"
              Compte: $in: ["3XR55PETX", "3XR55PETV"]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Exrecice: "SALES"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
              label: $first: "$Libellé"
          ,
            $project:
              type: $literal: "parent"
              label: 1
              value: $divide:["$value", 1000]
              group: "$label"
              order: $literal: 17
              variation: $divide:["$variation", 100]
              "Période": "$_id"
          ]
          [ #effet acquisition
            $match:
              domain: "SA"
              $or:[
                Compte: "XR55"
                Flux: "TACQ"
                Origine: "30SA-IFRS"
              ,
                Compte: "3XR55ACQTX"
                Flux: "Y99"
                Origine: "30SA-CALC"
              ]
              Secteur: "3SECD004"
              Format: "3MUD006"
              "Libellé Entité": "{{ report.entityName }}"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
          ,
            $project:
              type: $literal: "parent"
              label: $literal: "Eff Acq"
              value: $divide:["$value", 1000]
              group: $literal: "Eff Acq"
              order:$sum: [0,19]
              variation: $divide:["$variation", 100]
              "Période": "$_id"
          ]
          [ #effet X rate
            $match:
              domain: "SA"
              Compte: $in:["3XR55XR","3XR55XRTX"]
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              Montantabs: $abs: '$Montant'
          ,
            $sort:
              Montantabs: -1
          ,
            $group:
              _id: "$Période"
              value: $first: "$Montant"
              variation: $last: "$Montant"
              "Période": $first: "$Période"
              label: $first: "$Libellé"
          ,
            $project:
              type: $literal: "parent"
              label: 1
              value: $divide:["$value", 1000]
              group: "$label"
              order:$sum: [0,20]
              variation: $divide:["$variation", 100]
              "Période": "$_id"

          ]
          [#point d'arrivée CA N
            $match:
              domain: "SA"
              Compte: "XR55"
              Secteur: "3SECD004"
              Format: "3MUD006"
              Flux: "Y99"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              View: "{{ requestersManager.period.View }}"
          ,
            $addFields:
              type: $sum: [0, -1]
              label: $literal: "N"
              value: $divide:["$Montant", 1000]

          ,
            $addFields:
              group: "$label"
              order:$sum: [0,21]
          ]
        ]
        multiple_queries: true
        order:
          by: "order"
        postprocess:[
          argmax: "Période"
        ,
          rename:
            values:
              "Europe du Sud":
                en: "Europe"
                fr: "Europe"
              "Europe du Nord":
                en: "Europe"
                fr: "Europe"
              "Amérique Latine":
                en: "AmLat"
                fr: "AmLat"
              "Amérique latine":
                en: "AmLat"
                fr: "AmLat"
              "Effet Travaux en valeur":
                en: "Eff Trav"
                fr: "Eff Trav"
              "Effet Périmètre en valeur":
                en: "Eff Pér"
                fr: "Eff Pér"
        ]

        precision:
          "variation":',.1%'

      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      value:"value"
      label:"label"
      groups: "group"
      variation: "variation"
      type: "type"
      style: "waterfall-variation-only no-global-evolution"
      units:
        "evolution":' %'
        "value":' M€'

    highlightedKpis: [
      name: " Var. à taux constants"
      value: "value"
      badge: 'value'
      # comment: "commentary shown bellow KPI"
      sentiment:
        value:
          domain: [0]
          range: ['negative','positive']
      precision:
        value: ',.1f'
      units: value: "%"

      data:
        value:
          query:
            domain: "SA"
            "Période":"2016.12"
            Compte: "3XR55TXEH1"
            Secteur: "3SECD004"
            Format: "3MUD006"
            Flux: "Y99"
            Origine: "30SA-CALC"
            View: "{{ requestersManager.period.View }}"
            "Libellé Entité": "{{ report.entityName }}"
          field: "Montant"

    ,
      name: " Var. à taux courants"
      value: "value"
      badge: 'value'
      # comment: "commentary shown bellow KPI"
      sentiment:
        value:
          domain: [0]
          range: ['negative','positive']
      precision:
        value: ',.1f'
      units: value: "%"
      data:
        value:
          query:
            domain: "SA"
            Compte: "3XR55TXEH2"
            Secteur: "3SECD004"
            Format: "3MUD006"
            Flux: "Y99"
            "Période":"2016.12"
            Origine: "30SA-CALC"
            View: "{{ requestersManager.period.View }}"
            "Libellé Entité": "{{ report.entityName }}"
          field: "Montant"


    ]
  }


  # {
  #   title: 'CA sous enseignes'
  #   level: 3
  #   parent_id: 101
  #   id: 10103
  #   commentary: ""
  #   restrictVisibility:
  #     reportEntry: 'entityGroup'
  #     allowedReports: [
  #       'Pays'
  #     ]
  #   # filters:
  #   #   "bottom-right":
  #   #     on: "consolidation"
  #   #     type: "buttons"
  #   #     defaultSelected: "YTD"
  #   chartOptions:
  #     chartType: 'linechart'
  #     filters:
  #       "upper-right":
  #         on: "format"
  #         type: "dropdown"
  #         defaultSelected: "Hyper franchisé"
  #
  #     data:
  #       query:[
  #         [
  #           $match:
  #             domain:"fake-datas"
  #             kpi: "CA LFL"
  #             pays: "France"
  #             group: "N-1"
  #         ,
  #           $addFields:
  #             serie: $literal: "CA Total"
  #             format: $literal: "Hyper intégré"
  #             consolidation: $literal: "MTD"
  #         ]
  #         [
  #           $match:
  #             domain:"fake-datas"
  #             kpi: "CA LFL"
  #             pays: "Espagne"
  #             group: "N-1"
  #         ,
  #           $addFields:
  #             serie: $literal: "Ca Total"
  #             format: $literal: "Hyper franchisé"
  #             consolidation: $literal: "MTD"
  #         ]
  #         [
  #           $match:
  #             domain:"fake-datas"
  #             kpi: "CA LFL"
  #             pays: "France"
  #             group: "N-1"
  #         ,
  #           $addFields:
  #             serie: $literal: "CA Total"
  #             format: $literal: "Super intégré"
  #             consolidation: $literal: "MTD"
  #         ]
  #
  #         [
  #           $match:
  #             domain:"fake-datas"
  #             kpi: "CA LFL"
  #             pays: "Espagne"
  #             group: "N-1"
  #         ,
  #           $addFields:
  #             serie: $literal: "CA Total"
  #             format: $literal: "Super Franchisé"
  #             consolidation: $literal: "MTD"
  #         ]
  #         [
  #           $match:
  #             domain:"fake-datas"
  #             group: "Variation vs N-1"
  #             pays: $ne: "Italie"
  #         ,
  #           $addFields:
  #             serie: $literal: "CA Total"
  #             format: $literal: "Proxi intégré"
  #             consolidation: $literal: "MTD"
  #         ]
  #         [
  #           $match:
  #             domain:"fake-datas"
  #             kpi: "CA LFL"
  #             pays: "France"
  #             group: "N-1"
  #         ,
  #           $addFields:
  #             serie: $literal: "CA Total"
  #             format: $literal: "Proxi franchisé"
  #             consolidation: $literal: "MTD"
  #         ]
  #
  #         [
  #           $match:
  #             domain:"fake-datas"
  #             kpi: "CA LFL"
  #             pays: "Espagne"
  #             group: "N-1"
  #         ,
  #           $addFields:
  #             serie: $literal: "CA Total"
  #             format: $literal: "C&C"
  #             consolidation: $literal: "YTD"
  #         ]
  #         [
  #           $match:
  #             domain:"fake-datas"
  #             kpi: "CA LFL"
  #             pays: "France"
  #             group: "N-1"
  #         ,
  #           $addFields:
  #             serie: $literal: "Ca Total"
  #             format: $literal: "Autres"
  #             consolidation: $literal: "YTD"
  #         ]
  #
  #       ]
  #       multiple_queries: true
  #
  #       date:
  #         'format': "%Y.%m"
  #         'selector': "period"
  #       precision:
  #         value: ",.1f"
  #         "CA YTD": ".0f"
  #
  #     value:"value"
  #     # meta: ["PV", "Nombre articles"]
  #     date:"period"
  #     groups: "serie"
  #     legend: true
  #     units:
  #       "value": "€"
  #       "CA YTD" : " M€"
  #
  # }
  {
    level: 3
    title: "CA incl. Essence"
    parent_id: 101
    id: 10106
    commentary: "CA y compris essence"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [#point de départ CA N-1
            $match:
              domain: "SA"
              Compte: "3XR55H"
              Secteur: "3SECD000"
              Format: "3MUD000"
              Flux: "Y99"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              type: $subtract: [0, 1]
              label: $literal: "N-1 "
              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: "$label"
              order: $sum: [0,1]
          ]

          [ #création label CA retail
            $match:
              domain: "SA"
              Compte: "3XR55TXVH1"
              Secteur: "3SECD004"
              Format: "3MUD006"

              Flux: "Y99"
              Exrecice: "SALES"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              type: $literal: "parent"
              label: $literal: "CA retail"
              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: "$label"
              order: $sum: [0,2]
          ]
          [ #création group CA essence
            $match:
              domain: "SA"
              Compte: "3XR55TXVH1"
              Secteur: "SECT1430"
              Format: "3MUD000"
              Flux: "Y99"
              Exrecice: "SALES"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              type: $literal: "parent"
              label: $literal: "CA essence"
              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: "$label"
              order: $sum: [0,2]
          ]
          # [ #création des labels du CA essence
          #   $match:
          #     domain: "SA"
          #     Compte: "3XR55TXVH1"
          #     Secteur: "SECT1430"
          #     "Libellé Secteur": "Petrol"
          #     Format: "3MUD000"
          #     Flux: "Y99"
          #     "Libellé Format": "All formats"
          #     Exrecice: "SALES"
          #     Origine: "30SA-CALC"
          #     "Code Entité": $nin: ["3RUDAMLAADP", "3RUDASIAADP", "3RUDEURADP", "3RUD2100", "3RUDFRA09"]
          # ,
          #   $addFields:
          #     type: $literal: "child"
          #     label: $substr: ["$Libellé Entité", 0, 2]
          #     value: $divide:["$Montant", 1000]
          # ,
          #   $addFields:
          #     group: $literal: "CA essence"
          #     order:
          #       $cond:[
          #         $eq: ["$Code Entité", "3RUDFRAADP"]
          #         3
          #         $cond:[
          #           $eq: ["$Code Entité", "3RUDESPADP"]
          #           4
          #           $cond:[
          #             $eq: ["$Code Entité", "3RUDITAADP"]
          #             5
          #             $cond:[
          #               $eq: ["$Code Entité", "3RUDBELADP"]
          #               6
          #               $cond:[
          #                 $eq: ["$Code Entité", "3RUDPOLADP"]
          #                 7
          #                 $cond:[
          #                   $eq: ["$Code Entité", "3RUDROUADP"]
          #                   8
          #                   $cond:[
          #                     $eq: ["$Code Entité", "3RUDTWNADP"]
          #                     9
          #                     $cond:[
          #                       $eq: ["$Code Entité", "3RUDBRAADP"]
          #                       10
          #                       11
          #                     ]
          #                   ]
          #                 ]
          #               ]
          #             ]
          #           ]
          #         ]
          #       ]
          # ]
          [ #création group effet X rate
            $match:
              domain: "SA"
              Compte: "3XR55XR"
              Secteur: "3SECD000"
              Format: "3MUD000"
              Flux: "Y99"
              Format: "3MUD000"
              Exrecice: "SALES"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              type: $literal: "parent"
              label: "$Libellé"
              value: $divide:["$Montant", 1000]
          ,
            $addFields:
              group: "$label"
              order: $sum: [0,12]
          ]
          [#point d'arrivée CA N
            $match:
              domain: "SA"
              Compte: "XR55"
              Secteur: "3SECD000"
              Format: "3MUD000"
              Flux: "Y99"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              type: $subtract: [0, 1]
              label: $literal: "N"
              value: $divide:["$Montant", 1000]

          ,
            $addFields:
              group: "$label"
              order: $sum: [0,13]
          ]
        ]
        multiple_queries: true
        order:
          by: "order"
        postprocess:[
          argmax:"Période"
        ]
        precision:
          "evolution":',.2f'
          "value":',.0f'
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      value:"value"
      label:"label"
      groups: "group"
      # variation: "evolution"
      type: "type"
      units:
        "evolution":' %'
        "value":' M€'
  }
  {
    title: 'Equation Commerciale'
    level: 3
    parent_id: 101
    id: 10108
    commentary: "Périmètre intégré uniquement. Débits nets de l'effet calendaire et de l'effet travaux"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    chartOptions:
      chartType: 'linechart'
      filters:
        "upper-right":
          on: "Libellé Format"
          type: "dropdown"

      data:
        query:[
          $match:
            domain:"SA"
            Compte: $in:["3XR5033E", "3XR5031EN"]
            Secteur: "3SECD004"
            Flux: "Y99"
            "Format": $in:["3MUD1010","3MUD1110"]
            View: "MONTH"
            Origine: "30SA-CALC"
            "Libellé Entité": "{{ report.entityName }}"
        ]
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.1f"

      value:"Montant"
      date:"Période"
      groups: "Libellé"
      legend: true
      smoothLine: true
      units:
        "Montant": "%"

  }
  {
    level: 3
    title: "VA par secteurs"
    parent_id: 201
    id: 201111
    commentary: "Valeur et Variation du VA web en %"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    charts: [
      {
        chartType:'stackedBarchart'
        data:
          query:[
            $match:
              domain: "VA"
              "Période":"2016.12"
              Compte: $in: [ "3XR60I", "3XR60M", "3XR60ITXVH", "3XR60MTXVH"]
              Secteur: "Total"
              "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              Montant: $divide: ["$Montant", 1000]
              multiplicateur: $sum: [0, 1000]
          ]
          order:
            by: "Libellé Entité"
            custom: [
              "Groupe"
            ]
          postprocess:[
            pivot:
              index: ['View','Libellé Entité', 'Période', 'multiplicateur']
              column: 'Libellé'
              value: 'Montant'
          ,
            melt:
              id: ['View', 'Libellé Entité', "Var. VA Marketplace", "Var. ventes consolidées", 'Période', "multiplicateur"]
              value: ['VA consolidé','VA Marketplace']
              dropna: true
          # ,
          #   multiply:
          #     new_column: 'Evo VA consolidé'
          #     column_1: 'Var. ventes consolidées'
          #     column_2: 'multiplicateur'
          # ,
          #   multiply:
          #     new_column: 'Evo VA Marketplace'
          #     column_1: 'Var. VA Marketplace'
          #     column_2: 'multiplicateur'
          ,
            math: [
              multiply:
                'Evo VA consolidé': ["Var. ventes consolidées","multiplicateur"]
            ]

          ,
            math: [
              multiply:
                'Evo VA Marketplace': ["Var. VA Marketplace","multiplicateur"]
            ]

          ,
            rename:
              columns:
                "Var. ventes consolidées":
                  en: "Evo VA consolidé"
                  fr: "Evo VA consolidé"
                "Var. VA Marketplace":
                  en: "Evo VA Marketplace"
                  fr: "Evo VA Marketplace"

          ]
          precision:
            "Evo VA consolidé":".1f"
            "Evo VA Marketplace": '.1f'
            Montant:[
              precision: ",.1f"
              where:
                View: "Month"
            ,
              precision: ".0f"
              where:
                View: "YTD"
            ]
        value: "value"
        label:"Libellé Entité"

        groups: "Libellé"
        meta:["Evo VA consolidé","Evo VA Marketplace"]
        legend: true
        groupsOrder: ['VA consolidé','VA Marketplace']
        units:
          "Evo VA consolidé": "%"
          "Evo VA Marketplace": "%"
          Montant: " M€"
        unstackable: false
        hideEmptyGroups: true
      }
    ]
  }


  {
    level: 3
    title: "Mix VA"
    parent_id: 201
    id: 20011
    commentary: "Poids des categories et variation VA %"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          $match:
            domain: "VA"
            "Période":"2016.12"
            Compte: $in: ["3XR60PDS", "3XR60TXVH"]
            Secteur: $in: ["Food", "Non Food", "Services"]
            "Libellé Entité": "{{ report.entityName }}"
            Montant: $ne: 0
        ]

        precision:
          "Var. VA %": '.1f'

        postprocess:[

          pivot:
            index:["Période", "Libellé Entité", "Secteur", "View"]
            column: "Libellé"
            value: "Montant"

        ]
      chartType:'horizontal-barchart'
      value: "Poids VA"
      variation: "Var. VA %"
      variationLegend: "Evo VA %"
      label:"Secteur"
      packs: "Libellé Entité"

      packNames: true
      units:
        "Poids VA": "%"
        "Var. VA %": "%"
      style: "no-arrow"
  }
  {
    title: 'Trafic'
    level: 3
    parent_id: 201
    id: 20104
    commentary: "Evo trafic mensuel LTM"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]

    datasets:
      bars_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR62"
            Secteur: "Total"
            "Libellé Entité": "{{ report.entityName }}"
            View: "MONTH"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]

        ]
        units: Montant: "%"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          value: ",.0f"
      lines_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR61"
            Secteur: "Total"
            "Libellé Entité": "{{ report.entityName }}"
            View: "MONTH"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]
        ]
        postprocess:[
          rename:
            values:
              "Trafic":
                fr: "Nb visites"
                en: "Nb visites"
        ]
        units: Montant: " k"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.0f"

    chartOptions:
      chartType: 'new-barlinechart'

      bars:
        dataset: 'bars_data'
        # domain: [0, 100]
      label: "Période"
      value: "Montant"
      groups: "Libellé"

      lines:
        dataset: 'lines_data'
        # domain: [0, 25]
        x: "Période"
        y: "Montant"
        serie: "Libellé"

      legend: true
      dateFormat: "%B %Y"
      commonScale: false
      meta: []

  }
  {
    level: 3
    title: "Taux de conversion"
    parent_id: 201
    id: 20105
    commentary: "Evo taux de conversion LTM"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]

    datasets:
      bars_data:
        precision:
          Montant: ",.1f"
        query:[
          $match:
            domain: "VA"
            Compte: "3XR64"
            Secteur: "Total"
            View: "MONTH"
            "Libellé Entité": "{{ report.entityName }}"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]

        ]
        units: Montant: "%"
        date:
          'format': "%Y.%m"
          'selector': "Période"

      lines_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR61"
            Secteur: "Total"
            View: "MONTH"
            "Libellé Entité": "{{ report.entityName }}"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]
        ]
        postprocess:[
          rename:
            values:
              "Trafic":
                fr: "Nb visites"
                en: "Nb visites"
        ]
        units: Montant: " k"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.0f"

    chartOptions:
      chartType: 'new-barlinechart'
      bars:
        dataset: 'bars_data'
        # domain: [0, 100]
      label: "Période"
      value: "Montant"
      groups: "Libellé"

      lines:
        dataset: 'lines_data'
        # domain: [0, 25]
        x: "Période"
        y: "Montant"
        serie: "Libellé"

      legend: true
      dateFormat: "%B %Y"
      commonScale: false
      meta: []
  }
  {
    level: 3
    title: "Clients actifs"
    parent_id: 201
    id: 20107
    commentary: "Nombre de visites vs nombre de Clients Actifs MTD"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]

    datasets:
      bars_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR66"
            Secteur: "Total"
            View: "MONTH"
            "Libellé Entité": "{{ report.entityName }}"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]
        ,
          $addFields:
            Montant: $divide: ["$Montant", 1000]
        ]
        units: Montant: " k"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          value: ",.0f"
      lines_data:
        query:[
          $match:
            domain: "VA"
            Compte: "3XR61"
            Secteur: "Total"
            View: "MONTH"
            "Libellé Entité": "{{ report.entityName }}"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]

        ]
        postprocess:[
          rename:
            values:
              "Trafic":
                fr: "Nb visites"
                en: "Nb visites"
        ]
        units: Montant: " k"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.0f"

    chartOptions:
      chartType: 'new-barlinechart'
      bars:
        dataset: 'bars_data'
        # domain: [0, 350000]
      label: "Période"
      value: "Montant"
      groups: "Libellé"

      lines:
        dataset: 'lines_data'
        # domain: [0, 25]
        x: "Période"
        y: "Montant"
        serie: "Libellé"


      legend: true
      dateFormat: "%B %Y"
      commonScale: false
      meta: []
  }
  {
    level: 3
    title: "Commandes"
    parent_id: 201
    id: 20106
    commentary: "Nombre de commandes vs Volume d'Affaires LTM"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]

    datasets:
      bars_data: #nb de commandes
        query:[
          $match:
            domain: "VA"
            Compte: "3XR63"
            Secteur: "Total"
            View: "MONTH"
            "Libellé Entité": "{{ report.entityName }}"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]
        ,
          $addFields:
            Montant: $divide: ["$Montant", 1000]
        ]
        units: Montant: " Mds€"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.0f"
      lines_data:
        query:[ #panier moyen
          $match:
            domain: "VA"
            Compte: "3XR65"
            Secteur: "Total"
            View: "MONTH"
            "Libellé Entité": "{{ report.entityName }}"
            "Période": $in:[
              "2016.09"
              "2016.10"
              "2016.11"
              "2016.12"
              "2017.01"
              "2017.02"
              "2017.03"
              "2017.04"
              "2017.05"
              "2017.06"
              "2017.07"
              "2017.08"
            ]
        ]

        units: Montant: " €"
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.0f"

    chartOptions:
      chartType: 'new-barlinechart'
      bars:
        dataset: 'bars_data'
        # domain: [0, 350000]
      label: "Période"
      value: "Montant"
      groups: "Libellé"

      lines:
        dataset: 'lines_data'
        # domain: [0, 25]
        x: "Période"
        y: "Montant"
        serie: "Libellé"
        zeroBaseline: 0
      legend: true
      dateFormat: "%B %Y"
      commonScale: false
      meta: []
  }

  {
    level: 3
    title: "Dynamique marge commerciale"
    parent_id: 30
    id: 30100
    commentary: "Evolution du taux de marge"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "comparaison"
        type: "buttons"
        defaultSelected: "vs N-1"

    chartOptions:
      chartType: 'linechart'
      filters:
        "upper-right":
          on: "Libellé Format"
          type: "dropdown"
          defaultSelected: "Tous formats"
          order:
            custom:[
              "Tous formats"
              "Hyper"
              "Hyper int."
              "Hyper Fr."
              "Super"
              "Super Int."
              "Super Fr."
              "Proxi"
              "Proxi Int."
              "Proxi Fr."
              "C&C"

            ]

      data:
        query:[
          [
            $match:
              domain: "actual"
              Exrecice: "A"
              View: "MONTH"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS"]
              Compte: "3TR210TX"
              Secteur: "3SECD004"
              Flux: "Y99"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
          ,
            $project:
              comparaison: $literal: "Vs N-1"
              date: "$Période"
              "Période": 1
              serie: $concat: ["$Libellé", " MONTH"]
              value: "$Montant"
              View: 1
              'Libellé Entité': 1
              "Taux de marge % YTD": 1
              Format: 1
              "Libellé Format": 1
              value_pct:$divide: ["$Montant", 100]
          ]
        ,
          [
            $match:
              domain: "actual"
              Exrecice: "A"
              View: "MONTH"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS"]
              Compte: "3TR210TXH"
              Secteur: "3SECD004"
              Flux: "Y99"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
          ,
            $project:
              comparaison: $literal: "Vs N-1"
              date: "$Période"
              "Période": 1
              serie: $concat: ["$Libellé", " MONTH"]
              value: "$Montant"
              View: 1
              'Libellé Entité': 1
              "Taux de marge % YTD": "$Taux de marge N-1 % YTD"
              Format: 1
              "Libellé Format": 1
              value_pct:$divide: ["$Montant", 100]
          ]
        ,
          [
            $match:
              domain: "actual"
              Exrecice: "A"
              View: "MONTH"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS"]
              Compte: "3TR210TX"
              Secteur: "3SECD004"
              Flux: "Y99"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
          ,
            $project:
              date: "$Période"
              "Période": 1
              'Libellé Entité': 1
              serie: $literal: "Tx marge MONTH"
              value: "$Montant"
              comparaison: $literal: "Vs Obj"
              "Taux de marge % YTD": 1
              View: 1
              Format: 1
              "Libellé Format": 1
              value_pct:$divide: ["$Montant", 100]
          ]
        ,
          [
            $match:
              domain: "forecast"
              Exrecice: "FORECAST"
              View: "MONTH"
              Origine: $in:["30F-COUNTRY1", "30F-IFRS"]
              Compte: "3TR210TX"
              Secteur: "3SECD004"
              Flux: "Y99"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
          ,
            $project:
              date: "$Période"
              "Période": 1
              serie: $literal: "Tx marge Obj MONTH"
              "Taux de marge % YTD": 1
              value: "$Montant"
              value_pct:$divide: ["$Montant", 100]
              View: 1
              'Libellé Entité': 1
              comparaison: $literal: "Vs Obj"
              Format: 1
              "Libellé Format": 1
          ]
        ]
        multiple_queries: true
        postprocess:[
          rename:
            columns:
              'Taux de marge % MONTH':
                'en': 'Tx marge MONTH'
                'fr': 'Tx marge MONTH'

              'Taux de marge N-1 % MONTH':
                'en': 'Tx marge N-1 MONTH'
                'fr': 'Tx marge N-1 MONTH'
              'Taux de marge % YTD':
                'en': 'Tx marge YTD'
                'fr': 'Tx marge YTD'
            values:
              'Taux de marge % MONTH':
                'en': 'Tx marge MONTH'
                'fr': 'Tx marge MONTH'

              'Taux de marge N-1 % MONTH':
                'en': 'Tx marge N-1 MONTH'
                'fr': 'Tx marge N-1 MONTH'
              'Taux de marge % YTD':
                'en': 'Tx marge YTD'
                'fr': 'Tx marge YTD'
              "All formats":
                fr: 'Tous formats'
                en: 'Tous formats'
        ]
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          # value: ",.1f"
          value_pct: ".1%"
          "Tx marge YTD":".1f"

      value:"value_pct"
      date:"Période"
      groups: "serie"
      legend: true
      smoothLine: true
      dateFormat: "%B %Y"
      units:
        "value_pct": ""
        "Tx marge YTD": "%"
      metaSerie: ["Tx marge YTD"]
  }

  {
    level: 3
    title: "Marge commerciale par formats"
    parent_id: 30
    id: 30101
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Origine: $in:["30A-COUNTRY1", "30A-IFRS"]
              Compte: $in: ["3TR210TXH", "3TR210TX", "3TR210TXVH"]
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in: ["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
          ,
            $addFields:
              'Libellé': $concat: ["$Libellé","$Exrecice"]
          ]
          [
            $match:
              domain: "forecast"
              "Période": "2016.12"
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              Compte: $in: ["3TR210TX", "3TR210TXVH"]
              Format: $in: ["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              'Libellé': $concat: ["$Libellé","$Exrecice"]
          ]
        ]
        multiple_queries: true
        postprocess: [

          pivot:
            index: ['Libellé Format', 'View' ]
            column: 'Libellé'
            value: 'Montant'
        ,
          rename:
            columns:
              'Taux de marge %A':
                'en': 'Tx réel'
                'fr': 'Tx réel'
              'Taux de marge N-1 %A':
                'en': 'Tx N-1'
                'fr': 'Tx N-1'
              'Taux de marge %FORECAST':
                'en': 'Tx obj'
                'fr': 'Tx obj'
              'Variation taux de marge  %A':
                'en': 'Var vs N-1'
                'fr': 'Var vs N-1'
              'Variation taux de marge  %FORECAST':
                'en': 'Var vs obj'
                'fr': 'Var vs obj'
            values:
              "All formats":
                fr: "{{ report.entityName }}"
                en: "{{ report.entityName }}"

        ]
        precision:
          "Tx réel": '.1f'
          "Tx N-1": '.1f'
          'Tx obj': '.1f'
          "Var vs N-1": '.1f'
          'Var vs obj': '.1f'
        order:
          by: "Libellé Format"
          custom:[
            "{{ report.entityName }}"
            "Tous formats"
            "Hyper"
            "Hyper int."
            "Hyper Fr."
            "Super"
            "Super Int."
            "Super Fr."
            "Proxi"
            "Proxi Int."
            "Proxi Fr."
            "C&C"


          ]
      chartType: "bulletChart"
      commonScale: true
      label: "Libellé Format"
      value: "Tx réel"
      target: 'Tx obj'
      comparison: "Tx N-1"
     # packs: "pack"
     # packNames: true
      colorTargets: true
      meta: ["Var vs obj", "Var vs N-1"]

      units:
        "Tx réel":'%'
        "Tx N-1":'%'
        "Tx obj":'%'
        "Var vs obj": " pts"
        "Var vs N-1": " pts"
      sentiment:
        "Tx réel":
          domain: ['Tx obj']
          range: ['negative','positive']
  }


  {
    level: 3
    title: "Passage Marge commerciale"
    parent_id: 30
    id: 30102
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]

    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"

    chartOptions:
      data:
        query: [
          [
            $match:
              domain: "actual"
              "Libellé Entité": "{{ report.entityName }}"
              "Période":"2016.12"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              Compte: "3TR210H"
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
              Exrecice: "A"
            ,
              $addFields:
                label: $literal: "Marge co N-1"
                group: $literal: "Marge co N-1"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs N-1"
          ]
          [
            $match:
              domain: "actual"
              "Libellé Entité": "{{ report.entityName }}"
              "Période":"2016.12"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              Compte: $in: ["3TR211EFV", "3TR211EFMIX", "3TR211EFTX"]
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
              Exrecice: "A"
            ,
              $addFields:
                label: "$Libellé"
                group: $literal: "Marge de gestion"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs N-1"
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              Compte: $in: ["3XP2101VH", "3XP2103VH", "3XP2105VH"]
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
              Exrecice: "A"
            ,
              $addFields:
                label: "$Libellé"
                group: $literal: "Autres"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs N-1"
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              Compte: $in: ["3XTP200VH", "3XP2102VH", "3TR210XR"]
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS","30A-COUN-BUD"]
              Exrecice: "A"
            ,
              $addFields:
                label: "$Libellé"
                group: "$Libellé"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs N-1"
          ]
          [
            $match:
              domain: "actual"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "TR210"
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
              Exrecice: "A"
          ,
            $addFields:
              label: $literal: "Marge Co N"
              group: $literal: "Marge Co N"
              value_divided: $divide: ["$Montant", 1000]
              type: $literal : "vs N-1"
          ]
          [
            $match:
              domain: "forecast"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              Compte: "TR210"
              Origine: $in: ["30F-COUNTRY1", "30F-IFRS"]
              Exrecice: "FORECAST"
            ,
              $addFields:
                label: $literal: "Marge co Obj"
                group: $literal: "Marge co Obj"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs Obj"
          ]
          [
            $match:
              domain: "forecast"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              Compte: $in: ["3TR211EFV", "3TR211EFMIX", "3TR211EFTX"]
              Origine: $in: ["30F-COUNTRY1", "30F-IFRS"]
              Exrecice: "FORECAST"
            ,
              $addFields:
                label: "$Libellé"
                group: $literal: "Marge de gestion"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs Obj"
          ]
          [
            $match:
              domain: "forecast"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              Compte: $in: ["3XP2101VH", "3XP2103VH", "3XP2105VH"]
              Origine: $in: ["30F-COUNTRY1", "30F-IFRS"]
              Exrecice: "FORECAST"
            ,
              $addFields:
                label: "$Libellé"
                group: $literal: "Autres"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs Obj"
          ]
          [
            $match:
              domain: "forecast"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              Compte: $in: ["3XTP200VH", "3XP2102VH", "3TR210XR"]
              Origine: $in: ["30F-COUNTRY1", "30F-IFRS","30F-RATE-BGT","30F-COUN-BUD"]
              Exrecice: "FORECAST"
            ,
              $addFields:
                label: "$Libellé"
                group: "$Libellé"
                value_divided: $divide: ["$Montant", 1000]
                type: $literal : "vs Obj"
          ]
          [
            $match:
              domain: "actual"
              Format: $in:["3MUD000","3MUD1000", "3MUD1100", "3MUD1200","3MUD1300", "3MUD1010", "3MUD1020", "3MUD1110", "3MUD1120", "3MUD1210", "3MUD1220"]
              "Libellé Entité": "{{ report.entityName }}"
              "Période":"2016.12"
              Compte: "TR210"
              Origine: $in: ["30A-COUNTRY1", "30A-IFRS"]
              Exrecice: "A"
          ,
            $addFields:
              label: $literal: "Marge Co N"
              group: $literal: "Marge Co N"
              value_divided: $divide: ["$Montant", 1000]
              type: $literal : "vs Obj"
          ]

        ]
        multiple_queries: true

        postprocess: [

          rename:
            values:
              "All formats":
                fr: 'Tous formats'
                en: 'Tous formats'
              "Evo. Shrinkage":
                fr: "Démarque"
                en: "Démarque"
              "Evo. Fidélité":
                fr: "Fid"
                en: "Fid"
              "Evo Autre":
                fr: "Autre"
                en: "Autre"
              "Evo Cts logistique":
                fr: "Log"
                en: "Log"
              "Evo Décote":
                fr: "Décote"
                en: "Décote"
              "Effet volume":
                fr: "Eff Volume"
                en: "Eff Volume"
              "Effet taux brut %":
                fr: "Eff Taux"
                en: "Eff Taux"
              "Effet taux net du mix %":
                fr: "Eff Taux"
                en: "Eff Taux"
              "Effet mix %":
                fr: "Eff Mix"
                en: "Eff Mix"
        ]
        precision:
          evolution: ",.1f"
          value_divided: ",.0f"
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      value: "value_divided"
      label: "label"
      groups: "group"
      groupsOrder:[
        "Marge co N-1"
        "Marge co Obj"
        "Marge de gestion"
        "MARGE DE GESTION"
        "Démarque"
        "Evo. Fidélité"
        "EVO. FIDÉLITÉ"
        "Autres"
        "Effet X rates"
        "Marge co N"
      ]
      # type: "niveau"
      variation: ""
      units:
        evolution: " %"
        value_divided: " M€"
      filters:
        "upper-middle":
          on: "type"
          type: "buttons"
          order: custom: ["vs N-1", "vs Obj"]
        "upper-right":
          on: "Libellé Format"
          type: "dropdown"
          defaultSelected: "Tous formats"
          order:
            custom:[
              "Tous formats"
              "Hyper"
              "Hyper int."
              "Hyper Fr."
              "Super"
              "Super Int."
              "Super Fr."
              "Proxi"
              "Proxi Int."
              "Proxi Fr."
              "C&C"

            ]

  }
  {
    level: 3
    title: "Mix Promo"
    parent_id: 30
    id: 30103
    commentary: "Poids des promotions"

    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          $match:
            domain: "actual"
            "Période":"2016.12"
            Compte: $in: ["3MPROMO", "3MPROMOVH", "3PDSPROMO", "3PDSPROMOVH"]
            Secteur: "3SECT1010"
            Format: $in: ["FORM1011", "FORM1111"]
            Origine: "30A-ADPLC"
            "Libellé Entité": "{{ report.entityName }}"
        ,
          $addFields:
            order:
              $switch:
                branches: [
                  case: $eq: ["$Format", "FORM1011"]
                  then: 1
                ,
                  case: $eq: ["$Format", "FORM1111"]
                  then: 2
                ]
                default: 3
        ]
        postprocess:[
          pivot:
            index: ['Libellé Entité', 'Format','View', "Période", "Zone", "order"]
            column: 'Libellé'
            value: 'Montant'
        ,
          rename:
            columns:
              "Margin  Promo %":
                en: "Tx marge Promo"
                fr: "Tx marge Promo"
              "Variation Marge Promo %":
                en: "Var Tx marge Promo"
                fr: "Var Tx marge Promo"
        ,
          rename:
            values:
              "FORM1011":
                en: "Hyper"
                fr: "Hyper"
              "FORM1111":
                en: "Super"
                fr: "Super"
        ]
        order:
          by: "order"
        precision:
          'Tx marge Promo': ",.1f"
          "Poids  Promo %": ",.1f"
          "Variation Poids Promo %": ".1f"
          "Var Tx marge Promo": ".1f"

      chartType: "horizontal-barchart"
      packs: "Libellé Entité"
      packNames: true
      value: "Poids  Promo %"
      variation: "Variation Poids Promo %"
      variationLegend: "Var poids<br> vs N-1"
      label: "Format"
      meta: ['Tx marge Promo', "Var Tx marge Promo"]
      units:
        'Tx marge Promo': "%"
        "Variation Poids Promo %": " pts"
        "Poids  Promo %" : "%"
        "Var Tx marge Promo": "%"
      legend: true
      style: "no-value-legend"
      sparklines:
        orderDates: true
        value: "Montant"
        units: Montant : "%"
        legend: "Evo sur<br>12 mois"
        joins: [
          "Format"
        ]
        date: "Période"
        data:
          query:
            domain: "actual"
            # Compte: $in: ["3MPROMO", "3MPROMOVH", "3PDSPROMO", "3PDSPROMOVH"]
            Compte: "3MPROMO"
            Secteur: "3SECT1010"
            Format: $in: ["FORM1011", "FORM1111"]
            Origine: "30A-ADPLC"
            "Libellé Entité": "{{ report.entityName }}"
            View: "MONTH"
          postprocess:[
            rename:
              values:
                "FORM1011":
                  en: "Hyper"
                  fr: "Hyper"
                "FORM1111":
                  en: "Super"
                  fr: "Super"
          ]
  }

  {
    level: 3
    title: "Mix MN / MDD"
    parent_id: 30
    id: 30104
    commentary: "Poids MN / MDD"

    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"

    chartOptions:
      data:
        query:[
          [
            $match:
              domain:"actual"
              Compte: "3XR5103TX"
              "Libellé Entité": "{{ report.entityName }}"
              Flux: "Y99"
              Format: $in:["FORM1011", "FORM1111"]
          ,
            $group:
              _id:
                'Format': "$Format"
                View: "$View"
              "Poids N": $first:"$Poids MN %"
              "Poids N-1" : $first:"$Variation Poids MN %"
              "Var Tx de marge": $first:"$Variation Marge MN %"
              "Tx de marge": $first:"$Marge MN %"
              "Montant": $sum: "$Montant"
          ,
            $project:
              'Format': "$_id.Format"
              View: "$_id.View"
              label: $literal: "MN"
              "Poids N": 1
              "Poids N-1": $add:["$Poids N", "$Poids N-1"]
              "Var Tx de marge": 1
              "Tx de marge": 1
          ,
            $sort:
              # 'Entité': 1
              label: -1
          ]
        ,
          [
            $match:
              domain:"actual"
              Compte:  "3XTR514TX"
              "Libellé Entité": "{{ report.entityName }}"
              Flux: "Y99"
              Format: $in:["FORM1011", "FORM1111"]
          ,
            $group:
              _id:
                'Format': "$Format"
                View: "$View"
              "Poids N": $first:"$Poids MDD %"
              "Poids N-1" : $first:"$Variation Poids MDD %"
              "Var Tx de marge": $first:"$Variation Marge MDD %"
              "Tx de marge": $first:"$Marge MDD %"
              "Montant": $sum: "$Montant"
          ,
            $project:
              'Format': "$_id.Format"
              View: "$_id.View"
              label: $literal: "MDD"
              "Poids N": 1
              "Poids N-1": $add:["$Poids N", "$Poids N-1"]
              "Var Tx de marge": 1
              "Tx de marge": 1
          ,
            $sort:
              # 'Entité': 1
              label: -1
          ]
        ]
        multiple_queries: true
        postprocess:[
          rename:
            values:
              "FORM1011":
                en: "Hyper"
                fr: "Hyper"
              "FORM1111":
                en: "Super"
                fr: "Super"
        ]

        precision:
          "Poids N": ".1f"
          "Poids N-1": ".1f"
          "Var Tx de marge": ".1f"
          "Tx de marge": ".1f"

      chartType:'bulletChart'
      value: "Poids N"
      packs:"Format"
      commonScale: true
      label: "label"
      target: "Poids N-1"
      meta:[ "Tx de marge", "Var Tx de marge" ]
      units:
        "Poids N": "%"
        "Poids N-1": "%"
        "Var Tx de marge": " pts"
        "Tx de marge": "%"
      legend: true


  }
  {
    level: 3
    title: "Variation démarque"
    parent_id: 30
    id: 30105
    commentary: "Var. Démarque % vs N-1"

    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:
          domain: "actual"
          "Période":"2016.12"
          "Libellé Entité": "{{ report.entityName }}"
          Exrecice: "A"

          Compte: "3XTP200TXVH"
          Origine: "30A-COUNTRY1"
        postprocess:[

          rename:
            values:
              "All formats":
                fr: "{{ report.entityName }}"
                en: "{{ report.entityName }}"
              "HYPER INTEG OPE":
                fr: "Hyper int"
                en: "Hyper int"
              "SUPER INT OPE":
                fr: "Super int"
                en: "Super int"
        ]
        order:
          by: "Libellé Format"
          custom: [
            "Tous formats"
            "Hyper"
            "Super"
            "Proxi"
            "C&C"
          ]

        precision:
          Montant:".2f"
      chartType:'leaderboardCenteredAverage'
      value: "Montant"
      label:"Libellé Format"

      hideAverageBox: true
      average: 0
      units:
        Montant: " pts"
  }
  {
    level: 3
    title: "P&L Logistique"
    parent_id: 30
    id: 30122
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    requesters:
      "bottom-right":
        query:
          domain: 'scorecard'
          ecran: "pl"
        type: "buttons"
        id: "requester_consolidation"
        fields: ["consolidation"]
    chartOptions:
      chartType: "score-card"
      filters:
        # "upper-right":
        #   on: "pays"
        #   type: "buttons"
        #   defaultSelected: "Toucan Groupe"
        "upper-middle":
          on: "unit"
          type: "buttons"
          defaultSelected: " €/colis "
      value: "value"
      label: "label"
      variation: "variation"
      variationLegend: 'Variation vs N-1'
      packs: "group"
      packNames: true
      data:
        query:[
          [
            $match:
              domain: 'scorecard'
              ecran: "pl"
              consolidation: "{{ requestersManager.requester_consolidation }}"
          ,
            $addFields:
              unit: $literal : " €/colis "
          ]
          [
            $match:
              domain: 'scorecard'
              ecran: "pl"
              consolidation: "{{ requestersManager.requester_consolidation }}"
          ,
            $addFields:
              unit: $literal : " % CA "
          ]
        ]
        multiple_queries: true

      units:
        value:[
          unit: "%"
          where: unit: " % CA "
        ,
          unit: " €"
          where: unit: " € "
          ]
        variation:[
          unit: " pts"
          where: unit: " % CA "
        ,
          unit: " %"
          where: unit: " € "
          ]
  }
  {
    level:3
    parent_id:101
    id:10105
    title: "Parc"
    commentary: "Evolution du Parc"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    chartOptions:
      data:
        query:[
          [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "F99"
              "Format": "3MUD006"
              View: "YTD"
              Secteur: "Tous secteurs"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.01"
          ,
            $addFields:
              "Libellé": $literal: '2016.01'
          ]
          [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "TACQ"
              "Format": "3MUD006"
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              "Libellé": $literal: 'Acquisition'
              "type": $literal: 'parent'
              "group": $literal: 'Acquisition'
          ]
          [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "TACQ"
              "Format": $in: ["3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300", "3MUD014"]
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              "Libellé": '$Libellé Format'
              "type": $literal: 'child'
              "group": $literal: 'Acquisition'
          ]
          [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "TOPE"
              "Format": "3MUD006"
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              "Libellé": $literal: 'Ouvertures'
              "type": $literal: 'parent'
              "group": $literal: 'Ouvertures'
          ]
          [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "TOPE"
              "Format": $in: ["3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300", "3MUD014"]
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              "Libellé": '$Libellé Format'
              "type": $literal: 'child'
              "group": $literal: 'Ouvertures'
          ]
          [
            $match:
              domain:"SA"
              Compte: "3XTA001F"
              Flux: "F99"
              "Format": "3MUD006"
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              "Libellé": $literal: 'Fermetures'
              "type": $literal: 'parent'
              "group": $literal: 'Fermetures'
          ]
          [
            $match:
              domain:"SA"
              Compte: "3XTA001F"
              Flux: "F99"
              "Format": $in: ["3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300", "3MUD014"]
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              "Libellé": '$Libellé Format'
              "type": $literal: 'child'
              "group": $literal: 'Fermetures'
          ]
          [
            $match:
              domain:"SA"
              Compte: "3XTA001T"
              Flux: "F99"
              "Format": "3MUD006"
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              "Libellé": $literal: 'Transferts'
              "type": $literal: 'parent'
              "group": $literal: 'Transferts'
          ]
          [
            $match:
              domain:"SA"
              Compte: "3XTA001T"
              Flux: "F99"
              "Format": $in: ["3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300", "3MUD014"]
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-CALC"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              "Libellé": '$Libellé Format'
              "type": $literal: 'child'
              "group": $literal: 'Transferts'
          ]
          [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "F99"
              "Format": "3MUD006"
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ,
            $addFields:
              "Libellé": $literal: '2016.12'
          ]
        ]
        multiple_queries: true
        precision:
          "evolution":',.2f'
          "value":',.0f'
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      value:"Montant"
      label:"Libellé"
      groups:"group"
      type: "type"
      style: "waterfall-no-evol-highlight"
      units:
        "evolution":' %'
        "value":''

    highlightedKpis: [
      name: "Hypermarchés"
      value: "value"
      precision:
        value: ',.0f'
      units: value: "%"

      data:
        value:
          query: [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "F99"
              "Format": $in:["3MUD1000","3MUD1100","3MUD1300","3MUD1200","3MUD014"]
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ]
          postprocess:[
            percentage:
              new_column: 'number_percentage'
              column: 'Montant'
          ,
            query: "Format == '3MUD1000'"
          ]
          field: "number_percentage"

    ,
      name: "Supermarchés"
      value: "value"
      precision:
        value: ',.0f'
      units: value: " %"

      data:
        value:
          query: [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "F99"
              "Format": $in:["3MUD1000","3MUD1100","3MUD1300","3MUD1200","3MUD014"]
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ]
          postprocess:[
            percentage:
              new_column: 'number_percentage'
              column: 'Montant'
          ,
            query: "Format == '3MUD1100'"
          ]
          field: "number_percentage"
    ,
      name: "Proximarchés"
      value: "value"
      precision:
        value: ',.0f'
      units: value: "%"

      data:
        value:
          query: [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "F99"
              "Format": $in:["3MUD1000","3MUD1100","3MUD1300","3MUD1200","3MUD014"]
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ]
          postprocess:[
            percentage:
              new_column: 'number_percentage'
              column: 'Montant'
          ,
            query: "Format == '3MUD1200'"
          ]
          field: "number_percentage"
    ,
      name: "C&C"
      value: "value"
      precision:
        value: ',.0f'
      units: value: "%"

      data:
        value:
          query: [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "F99"
              "Format": $in:["3MUD1000","3MUD1100","3MUD1300","3MUD1200","3MUD014"]
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ]
          postprocess:[
            percentage:
              new_column: 'number_percentage'
              column: 'Montant'
          ,
            query: "Format == '3MUD1300'"
          ]
          field: "number_percentage"
    ,
      name: "Autres"
      value: "value"
      precision:
        value: ',.0f'
      units: value: "%"

      data:
        value:
          query: [
            $match:
              domain:"SA"
              Compte: "XTA001"
              Flux: "F99"
              "Format": $in:["3MUD1000","3MUD1100","3MUD1300","3MUD1200","3MUD014"]
              Secteur: "Tous secteurs"
              View: "YTD"
              Origine: "30SA-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
              "Période": "2016.12"
          ]
          postprocess:[
            percentage:
              new_column: 'number_percentage'
              column: 'Montant'
          ,
            query: "Format == '3MUD014'"
          ]
          field: "number_percentage"
    ]
  }
  {
    title: 'Dynamique Coûts'
    level: 3
    parent_id: 40
    id: 40101
    commentary: "Evolution coûts de distribution %"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        defaultSelected: "vs N-1"
        order: custom: ["vs N-1","vs Obj"]


    chartOptions:
      chartType: 'linechart'
      filters:
        "upper-right":
          on: "Libellé Format"
          type: "dropdown"
          defaultSelected: "Tous formats"
          order:
            custom:[
              "Tous formats"
              "Hyper"
              "Hyper int."
              "Hyper Fr."
              "Super"
              "Super Int."
              "Super Fr."
              "Proxi"
              "Proxi Int."
              "Proxi Fr."
              "C&C"

            ]
      data:
        query:[
          [
            $match:
              domain:"actual"
              "Libellé Entité": "{{ report.entityName }}"
              View: "MONTH"
              Format: $in: ["3MUD000", "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              Exrecice:"A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Compte: "3TR300TX"
          ,
            $addFields:
              Filtre1: $literal: 'vs Obj'
              "Tx CD YTD": "$Taux de CDD % YTD"
          ]
        ,
          [
            $match:
              domain:"forecast"
              Format: $in: ["3MUD000", "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              "Libellé Entité": "{{ report.entityName }}"
              View: "MONTH"
              Exrecice:"FORECAST"
              Origine: $in: ["30F-IFRS", "30F-COUNTRY1"]
              'Compte': "3TR300TX"
          ,
            $addFields:
              'Libellé': $literal: 'Taux Budget'
              Filtre1: $literal: 'vs Obj'
              "Tx CD YTD": "$Taux de CDD % YTD"
          ]
        ,
          [
            $match:
              domain:"actual"
              Format: $in: ["3MUD000", "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              "Libellé Entité": "{{ report.entityName }}"
              View: "MONTH"
              Exrecice:"A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Compte: "3TR300TX"
          ,
            $addFields:
              Filtre1: $literal: 'vs N-1'
              "Tx CD YTD": "$Taux de CDD % YTD"
          ]
        ,
          [
            $match:
              domain:"actual"
              "Libellé Entité": "{{ report.entityName }}"
              View: "MONTH"
              Format: $in: ["3MUD000", "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              Exrecice:"A"
              Origine: $in: ["30A-IFRS", "30A-COUNTRY1"]
              Compte: "3TR300TXH"
          ,
            $addFields:
              Filtre1: $literal: 'vs N-1'
              "Tx CD YTD": "$Taux de CDD N-1 % YTD"
          ]

        ]
        multiple_queries: true
        postprocess:[
          rename:
            values:
              "Taux de CDD %":
                en: "Tx CD % MONTH"
                fr: "Tx CD % MONTH"
              "Taux de CDD N-1 %":
                en: "Tx CD N-1 % MONTH"
                fr: "Tx CD N-1 % MONTH"
              "Taux Budget":
                en: "Tx CD Objectif % MONTH"
                fr: "Tx CD Objectif % MONTH"
              "All formats":
                fr: 'Tous formats'
                en: 'Tous formats'
        ]
        date:
          'format': "%Y.%m"
          'selector': "Période"
        precision:
          Montant: ",.1f"
          "Tx CD YTD": ",.1f"

      value:"Montant"
      date:"Période"
      groups: "Libellé"
      legend: true
      smoothLine: true
      dateFormat: '%B %Y'
      units:
        "Montant": "%"
        "Taux YTD": " %"
        "Tx CD YTD": "%"
      metaSerie: ["Tx CD YTD"]

  }
  {
    level: 3
    parent_id: 40
    id: 40102
    title: "Coûts de distribution par formats"
    commentary: "Coûts de distribution par pays (%)"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"

    chartOptions:
      data:
        query:[

            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              Format: $in: ["3MUD000", "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3TR300TX", "3TR300TXH"]
              Origine: $in: ["30A-COUNTRY1", "30F-COUNTRY1"]
              # Secteur: "Tous secteurs"
          ,
            $addFields:
              'montant_positive': $multiply: ["$Montant", -1]
              'Libellé': $concat: ["$Libellé","$Exrecice"]
              Zone: $cond:[
                  $eq: ["$Zone", 'Toutes Zones']
                  ''
                  $cond:[
                    $eq: ["$Zone", 'France']
                    ''
                    '$Zone'
                  ]
                ]
        ]
        # multiple_queries: true
        postprocess: [

          pivot:
            index: ['Libellé Entité','Zone', 'View', "Libellé Format" ]
            column: 'Libellé'
            value: 'montant_positive'
        ,

          rename:
            values:
              "All formats" :
                fr: "Tous formats"
                en: "Tous formats"
            columns:
              'Taux de CDD %A':
                'en': 'Tx Réel'
                'fr': 'Tx Réel'
              "Taux de CDD N-1 %A":
                'en': 'Tx N-1'
                'fr': 'Tx N-1'
              'Taux de CDD %FORECAST':
                'en': 'Tx Obj'
                'fr': 'Tx Obj'
              'Variation taux de CDD %A':
                'en': 'Var vs N-1'
                'fr': 'Var vs N-1'
              'Variation taux de CDD %FORECAST':
                'en': 'Var vs Obj'
                'fr': 'Var vs Obj'
        ]
        precision:
          "Evolution vs N-1": "+,.1f"
          "Tx Réel":",.1f"
          "Tx N-1":",.1f"
          "Tx Obj":",.1f"
        order:
          by: "format"
          custom: [
            "Tous formats"
            "Hyper"
            "Super"
            "Proxi"
            "C&C"

          ]

      chartType: "bulletChart"

      commonScale: true
      label: "Libellé Format"
      value: 'Tx Réel'
      target: 'Tx Obj'
      comparison: "Tx N-1"

      colorTargets: true
      # meta: ["Variation vs N-1", "Variation vs objectif"]
      # meta: ["NB"]
      units:
        'Tx Réel':' %'
        "Tx N-1":' %'
        'Tx Obj':' %'
        "Variation vs N-1": " pts"
        "Variation vs objectif": " pts"

      sentiment:
        'Tx Réel':
          domain: ['Objectif']
          range: ['positive','negative']
  }
  {
    level:3
    parent_id:40
    id:40103
    title: "Passage couts de distribution par formats"
    commentary: "Contribution par formats à la var. du taux de coûts de distribution"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query: [
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              Format: "3MUD000"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300TXH"
              Origine: "30A-COUNTRY1"
              Exrecice: "A"
          ,
            $addFields:
              niveau: $literal: -1
              Filtre1: $literal: "vs N-1"
              Zone: $literal: "Tx CDD N-1"
              Pays: $literal: "Tx CDD N-1"
              value_divided: "$Montant"
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300CONTRI"
              Origine: "30A-COUNTRY1"
              Format: $in: [ "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300", "3MUD048"]
              Exrecice: "A"
          ,
            $addFields:
              Filtre1: $literal: "vs N-1"
              Pays: "$Libellé Format"
              Zone: "$Libellé Format"
              value_divided: "$Montant"
              niveau: $literal: "child"

          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300EFMIX"
              Origine: "30A-COUNTRY1"
              Format: "3MUD000"
              Exrecice: "A"
          ,
            $addFields:
              niveau: $literal: "parent"
              Filtre1: $literal: "vs N-1"
              Zone: $literal: "Effet Mix"
              Pays: $literal: "Effet Mix"
              value_divided: "$Montant"
          ]
          [
            $match:
              domain: "actual"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300TX"
              Format: "3MUD000"
              Origine: "30A-COUNTRY1"
              Exrecice: "A"
          ,
            $addFields:
              niveau: $literal: -1
              Filtre1: $literal: "vs N-1"
              Zone: $literal: "Tx CDD N"
              Pays: $literal: "Tx CDD N"
              value_divided: "$Montant"
          ]


          [
            $match:
              domain: "forecast"
              "Période": $in: [ "2016.12",2016.12]
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300TX"
              Format: "3MUD000"
              Origine: "30F-COUNTRY1"
              Exrecice: "FORECAST"
          ,
            $addFields:
              niveau: $literal: -1
              Filtre1: $literal: "vs Obj"
              Zone: $literal: "Tx CDD Objectif"
              Pays: $literal: "Tx CDD Objectif"
              value_divided: "$Montant"
          ]
          [
            $match:
              domain: "forecast"
              "Période": $in: [ "2016.12",2016.12]
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300CONTRI"
              Origine: "30F-COUNTRY1"
              Format: $in: [ "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300", "3MUD048"]
              Exrecice: "FORECAST"
          ,
            $addFields:
              Filtre1: $literal: "vs Obj"
              Pays: "$Libellé Format"
              Zone: "$Libellé Format"
              value_divided: "$Montant"
              niveau: $literal: "child"

          ]
          [
            $match:
              domain: "forecast"
              "Période": $in: [ "2016.12",2016.12]
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300EFMIX"
              Format: "3MUD000"
              Origine: "30F-COUNTRY1"
              Exrecice: "FORECAST"
          ,
            $addFields:
              niveau: $literal: "parent"
              Filtre1: $literal: "vs Obj"
              Zone: $literal: "Effet Mix"
              Pays: $literal: "Effet Mix"
              value_divided: "$Montant"
          ]
          [
            $match:
              domain: "actual"
              "Période": "2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: "3TR300TX"
              Format: "3MUD000"
              Origine: "30A-COUNTRY1"
          ,
            $addFields:
              niveau: $literal: -1
              Filtre1: $literal: "vs Obj"
              Zone: $literal: "Tx CDD N"
              Pays: $literal: "Tx CDD N"
              value_divided: "$Montant"
          ]

        ]
        multiple_queries: true
        postprocess:[
          rename:
            values:
              'All formats':
                fr: "Tous formats"
                en: "Tous formats"
        ]
        order:
          by: "Zone"
          custom: [
            "Tx CDD N-1"
            "Tx CDD Objectif"
            "Tous formats"
            "Hyper"
            "Super"
            "Proxi"
            "C&C"
            "Autres"
            "Effet Mix"
            "Tx CDD N"
          ]
        precision:
          evolution: ",.1f"
          value_divided: ",.2f"
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      filters:
        "upper-middle":
          on: "View"
          type: "buttons"
          defaultSelected: "YTD"
      value: "value_divided"
      label: "Pays"
      groups: "Zone"
      # type: "Niveau"

      variation: ""
      units:
        evolution: " %"
        value_divided: " %"
      style: "waterfall-no-value"

    highlightedKpis: [
      name: "YTD vs N-1"
      ###attention il faudra rendre les highlighted filtrable par MTD / YTD ###
      value: "value"
      badge: "value"
      # comment: "commentary shown bellow KPI"
      sentiment:
        value:
          domain: [0]
          range: ['negative','positive']
      precision:
        value: '+,.2f'
      units: value: " Pts"

      data:
        value:
          query:
            domain: "actual"
            Compte: "3TR300TXVH"
            "Période":"2016.12"
            "Libellé Entité": "{{ report.entityName }}"
            Origine: "30A-COUNTRY1"
            Exrecice: "A"
            Format: "3MUD000"
            View: "YTD"

          field: "Montant"
    ,
      name: "YTD vs Obj"
      value: "value"
      badge: "value"
      # comment: "commentary shown bellow KPI"
      sentiment:
        value:
          domain: [0]
          range: ['negative','positive']
      precision:
        value: '+,.2f'
      units: value: " Pts"

      data:
        value:
          query:
            domain: "forecast"
            Compte: "3TR300TXVH"
            "Libellé Entité": "{{ report.entityName }}"
            Origine: "30F-COUNTRY1"
            Exrecice: "FORECAST"
            Format: "3MUD000"
            "Période": "2016.12"
            View: "YTD"

          field: "Montant"
    ]
  }
  {
    level: 3
    parent_id: 50
    id: 50101
    title: "Profitabilité ROC par formats"
    comment: "Profitabilité par formats vs Objectif et N-1 (en M€)"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              "Libellé Entité": "{{ report.entityName }}"
              Origine:$in:["30A-COUNTRY1", "30F-COUNTRY1"]
              Format: $in: ["3MUD000", "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              Compte: $in: ["TR160", "3TR160H"]
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période": $in: [ "2016.12",2016.12]
              "Libellé Entité": "{{ report.entityName }}"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              Compte: $in: ["3TR160TXVH", "3TR160TXVF"]
              Format: $in: ["3MUD000", "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: "$Montant"
          ]
        ]
        multiple_queries: true
        postprocess: [
          pivot:
            index: ['Libellé Format','Zone', 'View', 'Période']
            column: 'LibelléA'
            value: 'value_divided'
        ,
          rename:
            values:
              'All formats':
                fr: "Tous formats"
                en: "Tous formats"
            columns:
              'ROC - Recurring operating resultA':
                'en': 'Reporté'
                'fr': 'Reporté'
              "ROC  N-1A":
                'en': 'N-1'
                'fr': 'N-1'
              'ROC - Recurring operating resultFORECAST':
                'en': 'objectif'
                'fr': 'objectif'
              'Variation ROC vs N-1 %A':
                'en': 'Var vs N-1'
                'fr': 'Var vs N-1'
              'Variation ROC vs Budget %FORECAST':
                'en': 'Var vs Obj'
                'fr': 'Var vs Obj'

        ]
        precision:
          "Reporté": '.0f'
          "N-1": '.0f'
          'objectif': '.0f'
          "Var vs N-1": '+.1f'
          'Var vs Obj': '+.1f'

        order:
          by: "Libellé Format"
          custom: [
            "Tous formats"
            "Hyper"
            "Super"
            "Proxi"
            "C&C"

          ]

      chartType: "bulletChart"
      commonScale: true
      label: 'Libellé Format'
      value: "Reporté"
      target: "objectif"
      comparison: "N-1"

      colorTargets: true
      meta: [
        "Var vs Obj"
        "Var vs N-1"
      ]
      units:
        "Reporté":' M€'
        "N-1":' M€'
        "objectif":' M€'
        "Var vs N-1": " pts"
        "Var vs Obj": " pts"

      sentiment:
        "Reporté":
          domain: ['objectif']
          range: ['negative','positive']
  }
  {
    level: 3
    parent_id: 50
    id: 50104
    title: "Profitabilité ROCDA par formats"
    comment: "Profitabilité par formats vs Objectif et N-1 (en M€)"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "View"
        type: "buttons"
        defaultSelected: "YTD"
    chartOptions:
      data:
        query:[
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période":"2016.12"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              Compte: $in: ["3TR180NH", "3TR180N"]
              "Libellé Entité": "{{ report.entityName }}"
              Format: $in: ["3MUD000", "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: $in: ["actual", "forecast"]
              "Période":"2016.12"
              Origine:$in:["30A-COUNTRY1", "30A-IFRS", "30F-COUNTRY1", "30F-IFRS"]
              Compte: $in: ["3TR180NTXVF", "3TR180NTXVH"]
              Format: $in: ["3MUD000", "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              "Libellé Entité": "{{ report.entityName }}"
              # 'Libellé': $in:["ROC - Recurring operating result", "ROC  N-1",'Variation ROC vs N-1 %', 'Variation ROC vs Budget %']
              # "Période":"2016.12"
          ,
            $addFields:
              'LibelléA': $concat: ["$Libellé","$Exrecice"]
              value_divided: "$Montant"
          ]
        ]
        multiple_queries: true
        postprocess: [
          pivot:
            index: ['Libellé Format','Zone', 'View', 'Période']
            column: 'LibelléA'
            value: 'value_divided'
        ,
          rename:
            values:
              'All formats':
                fr: "Tous formats"
                en: "Tous formats"
            columns:
              'ROCDA Net Amort LogA':
                'en': 'Reporté'
                'fr': 'Reporté'
              'ROCDA  Net Amort Log N-1A':
                'en': 'N-1'
                'fr': 'N-1'
              'ROCDA Net Amort LogFORECAST':
                'en': 'objectif'
                'fr': 'objectif'
              'Variation ROCDA Net Amort Log en taux vs N-1 %A':
                'en': 'Var vs N-1'
                'fr': 'Var vs N-1'
              'Variation ROCDA Net Amort Log en taux vs Budget %FORECAST':
                'en': 'Var vs Obj'
                'fr': 'Var vs Obj'
        ]
        precision:
          "Reporté": '.0f'
          "N-1": '.0f'
          'objectif': '.0f'
          "Var vs N-1": '+.1f'
          'Var vs Obj': '+.1f'

        order:
          by: "Libellé Format"
          custom: [
            "Tous formats"
            "Hyper"
            "Super"
            "Proxi"
            "C&C"

          ]

      chartType: "bulletChart"
      commonScale: true
      label: "Libellé Format"
      value: "Reporté"
      target: "objectif"
      comparison: 'N-1'
      colorTargets: true
      meta: [
        "Var vs Obj"
        "Var vs N-1"
      ]
      units:
        "Reporté":' M€'
        "N-1":' M€'
        "objectif":' M€'
        "Var vs N-1": " pts"
        "Var vs Obj": " pts"

      sentiment:
        "Reporté":
          domain: ['objectif']
          range: ['negative','positive']
  }
  {
    title:"Evolution TM"
    level:3
    id:60103
    parent_id:60
    commentary: "Variation TM"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
        order:
          custom: [
            "Vs N-1"
            "Vs Obj"
          ]
    chartOptions:
      data:
        query:[
          [
            $match:
              domain:"actual"
              "Période":"2016.12"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3TMJVH", "3CRJVH", "3DFJVH", "3STJVH"]
              Exrecice: "A"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              Format: "Tous Formats"

          ,
            $addFields:
              Filtre1: $literal: "Vs N-1"
          ]
          [
            $match:
              domain:"forecast"
              "Période":"2016.12"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3TMJVH", "3CRJVH", "3DFJVH", "3STJVH"]
              Exrecice: "FORECAST"
              Format: "Tous Formats"

          ,
            $addFields:
              Filtre1: $literal: "Vs Obj"
          ]

        ]
        multiple_queries: true
        postprocess:[

          rename:
            values:
              "Evo TM en jours N-1":
                fr: "Trésorerie Marchandise"
                en: "Trésorerie Marchandise"
              "Evo Créances en jours N-1":
                fr: "Créances"
                en: "Créances"
              "Evo Dette Fourni en jours N-1":
                fr: "Dette fournisseurs"
                en: "Dette fournisseurs"
              "Evo Stock en jours N-1":
                fr: "Stock"
                en: "Stock"
        ]
        precision:
          "Montant": ",.1f"

      chartType: "leaderboardCenteredAverage"
      # filters:
      #   "upper-middle":
      #     on: "Libellé"
      #     type: "dropdown"
      #     defaultSelected: "Trésorerie Marchandise"
      value:'Montant'
      label:'Libellé'
      reverse: true
      average:0
      # variation: "BFR"
      # variationLegend: "Variation BFR"
      hideAverageBox: true
      units:
        Montant: " jour(s)"

  }
  {
    title: "Capex"
    level: 3
    parent_id: 60
    id:60104
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]
    filters:
      "bottom-right":
        on: "Filtre1"
        type: "buttons"
    chartOptions:

      data:
        query: [
          [
            $match:
              domain:"actual"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3CAPVH","3CAP"]
              Origine: "30A-COUNTRY1"
              # Format: $in: ["3MUD000", "3MUD1000", "3MUD1100", "3MUD1200", "3MUD1300"]
              Format: "3MUD000"
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                zone: "$Zone"
                format: "$Libellé Format"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: "$_id.format"
              zone: "$_id.zone"
              # value: 1
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs N-1"
              # Variation: "$_id.order"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
              parent: ""
              id:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                ]
          ]
          [
            $match:
              domain:"actual"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3CAP-EXP", "3CAP-EXPVH"]
              Origine: "30A-COUNTRY1"
              Format: "3MUD000"
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                format: "$Libellé Format"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Expansion"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs N-1"
              parent:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
          ]
          [
            $match:
              domain:"actual"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3CAP-REM", "3CAP-REMVH"]
              Origine: "30A-COUNTRY1"
              Format: "3MUD000"
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                format: "$Libellé Format"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Remodeling & On-going"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs N-1"
              parent:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
          ]
          [
            $match:
              domain:"actual"
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3CAP-AUT", "3CAP-AUTVH"]
              Origine: "30A-COUNTRY1"
              Format: "3MUD000"
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                format: "$Libellé Format"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Autres"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs N-1"
              parent:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  1
                ]
          ]

          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              domain: $in: ["actual","forecast"]
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3CAPVF","3CAP"]
              Origine: $in: ["30F-COUNTRY1", "30A-COUNTRY1"]
              Format: "3MUD000"
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                zone: "$Zone"
                format: "$Libellé Format"
                # consolidation: "$consolidation"
              # value:$sum: "$Montant"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: "$_id.format"
              zone: "$_id.zone"
              # value: 1
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              # Variation: "$_id.order"
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  2
                ]
              parent: ""
              id:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              domain: $in: ["actual","forecast"]
              Origine: $in: ["30F-COUNTRY1", "30A-COUNTRY1"]
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3CAP-EXP", "3CAP-EXPVF"]
              Format: "3MUD000"
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                format: "$Libellé Format"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Expansion"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              parent:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  2
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              domain: $in: ["actual","forecast"]
              Origine: $in: ["30F-COUNTRY1", "30A-COUNTRY1"]
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3CAP-REM", "3CAP-REMVF"]
              Format: "3MUD000"
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                format: "$Libellé Format"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Remodeling & On-going"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              parent:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  2
                ]
          ]
          [
            $match:
              "Période": $in: [ "2016.12",2016.12]
              domain: $in: ["actual","forecast"]
              Origine: $in: ["30F-COUNTRY1", "30A-COUNTRY1"]
              "Libellé Entité": "{{ report.entityName }}"
              Compte: $in: ["3CAP-AUT", "3CAP-AUTVF"]
              Format: "3MUD000"
          ,
            $addFields:
              montant2: $divide: ["$Montant", 1000]
          ,
            $group:
              _id:
                periode: "$Période"
                format: "$Libellé Format"
                zone: "$Zone"
              # value:$sum: "$montant2"
              kpi: $push: "$Compte"
              value_kpi: $push: "$montant2"

          ,
            $project:
              label: $literal: "Autres"
              zone: "$_id.zone"
              periode: "$_id.periode"
              # consolidation:"$_id.consolidation"
              Filtre1: $literal: "Vs Obj"
              parent:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                ]
              id:
                $concat: [
                  "$_id.format"
                  "_"
                  "A"
                  "-"
                  "$_id.label"
                ]
              variation:
                $arrayElemAt: [
                  "$value_kpi"
                  0
                ]
              value:
                $arrayElemAt: [
                  "$value_kpi"
                  2
                ]
          ]

        ]
        multiple_queries: true

        postprocess:[
        #   argmax: "periode"
        # ,
          rename:
            values:
              "All formats":
                fr: "Tous formats"
                en: "Tous formats"

        ]
        precision:
          value: ",.0f"
          variation: ",.0f"
        order:
          by: "label"
          custom:[ "Tous formats", "Hyper", "Super", "Proxi", "C&C", "Expansion", "Remodeling & On-going", "Autres"]
      chartType:'horizontal-barchart'
      value: "value"
      variation: "variation"
      variationLegend: "Evo. tx constants"
      # domain: [0, 100]
      label:"label"


      # packs: "pays"
      # packNames: true
      'children':
            'root': ''
            'id': 'id'
            'parent': 'parent'
      units:
        value: " M€"
        variation: " M€"
      legend: true
      reverse: true
      style: "no-value-legend"

  }
  {
    level:3
    parent_id:60
    id:60105
    title: "Passage Dette Nette"
    commentary: "Passage Dette Nette en M€"
    restrictVisibility:
      reportEntry: 'entityGroup'
      allowedReports: [
        'Pays'
      ]

    chartOptions:
      data:
        query:[
          [
            $match:
              domain: "actual"
              Compte: "3SCF7005ADP"
              "Période":"2016.12"
              # "Origine": "30A-IFRS"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              order: $literal: 1
              niveau: $literal: -1
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              Flux: "Y99"
              "Période":"2016.12"
              Secteur: "Tous secteurs"
              Compte: $in: ["3SCF5045ADP", "3SCF1200ADP", "3AND-FCF-B", "3AN1-SCF6", "3AN1-SCF5"]
              # "Origine": "30A-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              order: $literal: 2
              niveau: $literal: "parent"
              value_divided: $divide: ["$Montant", 1000]
          ]
          [
            $match:
              domain: "actual"
              Compte: "3SCF7010ADP"
              "Période":"2016.12"
              Flux: "Y99"
              Secteur: "Tous secteurs"
              # "Origine": "30A-IFRS"
              "Libellé Entité": "{{ report.entityName }}"
          ,
            $addFields:
              order: $literal: 3
              niveau: $literal: -1
              value_divided: $divide: ["$Montant", 1000]
          ]

        ]
        multiple_queries: true
        postprocess:[

          rename:
            values:
              "Cout de la dette":
                fr: "Coût de la dette"
                en: "Coût de la dette"
              "Autre Dette":
                fr: "Autres"
                en: "Autres"
        ]
        order:
          by: "Compte"
          custom: [
            "3SCF7005ADP"
            "3AND-FCF-B"
            "3AN1-SCF5"
            "3AN1-SCF6"
            "3SCF5045ADP"
            "3SCF1200ADP"
            "3SCF7010ADP"
          ]

        precision:
          "evolution":',.1f'
          "value":',.1f'
      chartType: "waterfallchart"
      hideParenthesisEvolution: true
      value:"value_divided"
      label:"Libellé"
      groups: "Libellé"
      # type: "niveau"
      # variation: "evolution"
      style: "waterfall-no-evol-highlight"
      units:
        "evolution":' %'
        "value_divided":' M€'

  }



]
